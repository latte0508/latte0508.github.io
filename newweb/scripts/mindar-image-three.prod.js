import{Matrix4 as m,Vector3 as p,Quaternion as w,Scene as v,WebGLRenderer as M,sRGBEncoding as b,PerspectiveCamera as T,Group as g}from"three";import{t as A,C as R}from"./controller.03a2d8ae.js";import{CSS3DRenderer as E}from"three/addons/renderers/CSS3DRenderer.js";import{U as I}from"./ui.4498bf0c.js";const f=new m;f.compose(new p,new w,new p(.001,.001,.001));class H{constructor({container:e,imageTargetSrc:t,maxTrack:i,uiLoading:s="yes",uiScanning:n="yes",uiError:o="yes",filterMinCF:r=null,filterBeta:a=null,warmupTolerance:h=null,missTolerance:l=null}){this.container=e,this.imageTargetSrc=t,this.maxTrack=i,this.filterMinCF=r,this.filterBeta=a,this.warmupTolerance=h,this.missTolerance=l,this.ui=new I({uiLoading:s,uiScanning:n,uiError:o}),this.scene=new v,this.cssScene=new v,this.renderer=new M({antialias:!0,alpha:!0}),this.cssRenderer=new E({antialias:!0}),this.renderer.outputEncoding=b,this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new T,this.anchors=[],this.renderer.domElement.style.position="absolute",this.cssRenderer.domElement.style.position="absolute",this.container.appendChild(this.renderer.domElement),this.container.appendChild(this.cssRenderer.domElement),window.addEventListener("resize",this.resize.bind(this))}async start(){this.ui.showLoading(),await this._startVideo(),await this._startAR()}stop(){this.controller.stopProcessVideo(),this.video.srcObject.getTracks().forEach((function(e){e.stop()})),this.video.remove()}addAnchor(e){const t=new g;t.visible=!1,t.matrixAutoUpdate=!1;const i={group:t,targetIndex:e,onTargetFound:null,onTargetLost:null,css:!1,visible:!1};return this.anchors.push(i),this.scene.add(t),i}addCSSAnchor(e){const t=new g;t.visible=!1,t.matrixAutoUpdate=!1;const i={group:t,targetIndex:e,onTargetFound:null,onTargetLost:null,css:!0,visible:!1};return this.anchors.push(i),this.cssScene.add(t),i}_startVideo(){return new Promise(((e,t)=>{if(this.video=document.createElement("video"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.position="absolute",this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex="-2",this.container.appendChild(this.video),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return this.ui.showCompatibility(),void t();navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then((t=>{this.video.addEventListener("loadedmetadata",(()=>{this.video.setAttribute("width",this.video.videoWidth),this.video.setAttribute("height",this.video.videoHeight),e()})),this.video.srcObject=t})).catch((e=>{console.log("getUserMedia error",e),t()}))}))}_startAR(){return new Promise((async(e,t)=>{const i=this.video;this.container,this.controller=new R({inputWidth:i.videoWidth,inputHeight:i.videoHeight,filterMinCF:this.filterMinCF,filterBeta:this.filterBeta,warmupTolerance:this.warmupTolerance,missTolerance:this.missTolerance,maxTrack:this.maxTrack,onUpdate:e=>{if("updateMatrix"===e.type){const{targetIndex:t,worldMatrix:i}=e;for(let e=0;e<this.anchors.length;e++)if(this.anchors[e].targetIndex===t){if(this.anchors[e].css?this.anchors[e].group.children.forEach((e=>{e.element.style.visibility=null===i?"hidden":"visible"})):this.anchors[e].group.visible=null!==i,null!==i){let s=new m;s.elements=[...i],s.multiply(this.postMatrixs[t]),this.anchors[e].css&&s.multiply(f),this.anchors[e].group.matrix=s}this.anchors[e].visible&&null===i&&(this.anchors[e].visible=!1,this.anchors[e].onTargetLost&&this.anchors[e].onTargetLost()),!this.anchors[e].visible&&null!==i&&(this.anchors[e].visible=!0,this.anchors[e].onTargetFound&&this.anchors[e].onTargetFound()),null!==i&&this.ui.hideScanning()}}}}),this.resize();const{dimensions:s}=await this.controller.addImageTargets(this.imageTargetSrc);this.postMatrixs=[];for(let e=0;e<s.length;e++){const t=new p,i=new w,n=new p,[o,r]=s[e];t.x=o/2,t.y=o/2+(r-o)/2,n.x=o,n.y=o,n.z=o;const a=new m;a.compose(t,i,n),this.postMatrixs.push(a)}await this.controller.dummyRun(this.video),this.ui.hideLoading(),this.ui.showScanning(),this.controller.processVideo(this.video),e()}))}resize(){const{renderer:e,cssRenderer:t,camera:i,container:s,video:n}=this;if(!n)return;let o,r;const a=n.videoWidth/n.videoHeight;a>s.clientWidth/s.clientHeight?(r=s.clientHeight,o=r*a):(o=s.clientWidth,r=o/a);const h=this.controller.getProjectionMatrix(),l=2*Math.atan(1/h[5]/r*s.clientHeight)*180/Math.PI,d=h[14]/(h[10]-1),c=h[14]/(h[10]+1);h[5],h[0],i.fov=l,i.near=d,i.far=c,i.aspect=s.clientWidth/s.clientHeight,i.updateProjectionMatrix(),n.style.top=-(r-s.clientHeight)/2+"px",n.style.left=-(o-s.clientWidth)/2+"px",n.style.width=o+"px",n.style.height=r+"px";const u=e.domElement,p=t.domElement;u.style.position="absolute",u.style.left=0,u.style.top=0,u.style.width=s.clientWidth+"px",u.style.height=s.clientHeight+"px",p.style.position="absolute",p.style.left=0,p.style.top=0,p.style.width=s.clientWidth+"px",p.style.height=s.clientHeight+"px",e.setSize(s.clientWidth,s.clientHeight),t.setSize(s.clientWidth,s.clientHeight)}}window.MINDAR||(window.MINDAR={}),window.MINDAR.IMAGE||(window.MINDAR.IMAGE={}),window.MINDAR.IMAGE.MindARThree=H,window.MINDAR.IMAGE.tf=A;export{H as MindARThree};