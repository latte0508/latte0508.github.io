!function t(e,i,n){function o(r,a){if(!i[r]){if(!e[r]){var l="function"==typeof require&&require;if(!a&&l)return l(r,!0);if(s)return s(r,!0);var h=new Error("Cannot find module '"+r+"'");throw h.code="MODULE_NOT_FOUND",h}var c=i[r]={exports:{}};e[r][0].call(c.exports,(function(t){return o(e[r][1][t]||t)}),c,c.exports,t,e,i,n)}return i[r].exports}for(var s="function"==typeof require&&require,r=0;r<n.length;r++)o(n[r]);return o}({1:[function(t,e,i){var n=t("cannon-es");t("./src/components/math"),t("./src/components/body/ammo-body"),t("./src/components/body/body"),t("./src/components/body/dynamic-body"),t("./src/components/body/static-body"),t("./src/components/shape/shape"),t("./src/components/shape/ammo-shape"),t("./src/components/ammo-constraint"),t("./src/components/constraint"),t("./src/components/spring"),t("./src/system"),e.exports={registerAll:function(){console.warn("registerAll() is deprecated. Components are automatically registered.")}},window.CANNON=window.CANNON||n},{"./src/components/ammo-constraint":8,"./src/components/body/ammo-body":9,"./src/components/body/body":10,"./src/components/body/dynamic-body":11,"./src/components/body/static-body":12,"./src/components/constraint":13,"./src/components/math":14,"./src/components/shape/ammo-shape":16,"./src/components/shape/shape":17,"./src/components/spring":18,"./src/system":28,"cannon-es":4}],2:[function(t,e,i){var n=t("cannon-es");n.shape2mesh=function(t){for(var e=new THREE.Object3D,i=0;i<t.shapes.length;i++){var o,s=t.shapes[i];switch(s.type){case n.Shape.types.SPHERE:var r=new THREE.SphereGeometry(s.radius,8,8);o=new THREE.Mesh(r,this.currentMaterial);break;case n.Shape.types.PARTICLE:o=new THREE.Mesh(this.particleGeo,this.particleMaterial);var a=this.settings;o.scale.set(a.particleSize,a.particleSize,a.particleSize);break;case n.Shape.types.PLANE:var l=new THREE.PlaneGeometry(10,10,4,4);o=new THREE.Object3D;var h=new THREE.Object3D,c=new THREE.Mesh(l,this.currentMaterial);c.scale.set(100,100,100),h.add(c),c.castShadow=!0,c.receiveShadow=!0,o.add(h);break;case n.Shape.types.BOX:var u=new THREE.BoxGeometry(2*s.halfExtents.x,2*s.halfExtents.y,2*s.halfExtents.z);o=new THREE.Mesh(u,this.currentMaterial);break;case n.Shape.types.CONVEXPOLYHEDRON:for(var d=new THREE.Geometry,p=0;p<s.vertices.length;p++){var f=s.vertices[p];d.vertices.push(new THREE.Vector3(f.x,f.y,f.z))}for(p=0;p<s.faces.length;p++)for(var v=s.faces[p],m=v[0],y=1;y<v.length-1;y++){var g=v[y],w=v[y+1];d.faces.push(new THREE.Face3(m,g,w))}d.computeBoundingSphere(),d.computeFaceNormals(),o=new THREE.Mesh(d,this.currentMaterial);break;case n.Shape.types.HEIGHTFIELD:l=new THREE.Geometry;for(var b=new n.Vec3,x=new n.Vec3,E=new n.Vec3,A=0;A<s.data.length-1;A++)for(var S=0;S<s.data[A].length-1;S++)for(var C=0;C<2;C++)s.getConvexTrianglePillar(A,S,0===C),b.copy(s.pillarConvex.vertices[0]),x.copy(s.pillarConvex.vertices[1]),E.copy(s.pillarConvex.vertices[2]),b.vadd(s.pillarOffset,b),x.vadd(s.pillarOffset,x),E.vadd(s.pillarOffset,E),l.vertices.push(new THREE.Vector3(b.x,b.y,b.z),new THREE.Vector3(x.x,x.y,x.z),new THREE.Vector3(E.x,E.y,E.z)),p=l.vertices.length-3,l.faces.push(new THREE.Face3(p,p+1,p+2));l.computeBoundingSphere(),l.computeFaceNormals(),o=new THREE.Mesh(l,this.currentMaterial);break;case n.Shape.types.TRIMESH:for(l=new THREE.Geometry,b=new n.Vec3,x=new n.Vec3,E=new n.Vec3,p=0;p<s.indices.length/3;p++)s.getTriangleVertices(p,b,x,E),l.vertices.push(new THREE.Vector3(b.x,b.y,b.z),new THREE.Vector3(x.x,x.y,x.z),new THREE.Vector3(E.x,E.y,E.z)),y=l.vertices.length-3,l.faces.push(new THREE.Face3(y,y+1,y+2));l.computeBoundingSphere(),l.computeFaceNormals(),o=new THREE.Mesh(l,this.currentMaterial);break;default:throw"Visual type not recognized: "+s.type}if(o.receiveShadow=!0,o.castShadow=!0,o.children)for(p=0;p<o.children.length;p++)if(o.children[p].castShadow=!0,o.children[p].receiveShadow=!0,o.children[p])for(y=0;y<o.children[p].length;y++)o.children[p].children[y].castShadow=!0,o.children[p].children[y].receiveShadow=!0;var T=t.shapeOffsets[i],B=t.shapeOrientations[i];o.position.set(T.x,T.y,T.z),o.quaternion.set(B.x,B.y,B.z,B.w),e.add(o)}return e},e.exports=n.shape2mesh},{"cannon-es":4}],3:[function(t,e,i){THREE.AmmoDebugConstants={NoDebug:0,DrawWireframe:1,DrawAabb:2,DrawFeaturesText:4,DrawContactPoints:8,NoDeactivation:16,NoHelpText:32,DrawText:64,ProfileTimings:128,EnableSatComparison:256,DisableBulletLCP:512,EnableCCD:1024,DrawConstraints:2048,DrawConstraintLimits:4096,FastWireframe:8192,DrawNormals:16384,DrawOnTop:32768,MAX_DEBUG_DRAW_MODE:4294967295},THREE.AmmoDebugDrawer=function(t,e,i){this.scene=t,this.world=e,i=i||{},this.debugDrawMode=i.debugDrawMode||THREE.AmmoDebugConstants.DrawWireframe;var n=this.debugDrawMode&THREE.AmmoDebugConstants.DrawOnTop||!1,o=i.maxBufferSize||1e6;this.geometry=new THREE.BufferGeometry;var s=new Float32Array(3*o),r=new Float32Array(3*o);this.geometry.addAttribute("position",new THREE.BufferAttribute(s,3).setDynamic(!0)),this.geometry.addAttribute("color",new THREE.BufferAttribute(r,3).setDynamic(!0)),this.index=0;var a=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,depthTest:!n});this.mesh=new THREE.LineSegments(this.geometry,a),n&&(this.mesh.renderOrder=999),this.mesh.frustumCulled=!1,this.enabled=!1,this.debugDrawer=new Ammo.DebugDrawer,this.debugDrawer.drawLine=this.drawLine.bind(this),this.debugDrawer.drawContactPoint=this.drawContactPoint.bind(this),this.debugDrawer.reportErrorWarning=this.reportErrorWarning.bind(this),this.debugDrawer.draw3dText=this.draw3dText.bind(this),this.debugDrawer.setDebugMode=this.setDebugMode.bind(this),this.debugDrawer.getDebugMode=this.getDebugMode.bind(this),this.debugDrawer.enable=this.enable.bind(this),this.debugDrawer.disable=this.disable.bind(this),this.debugDrawer.update=this.update.bind(this),this.world.setDebugDrawer(this.debugDrawer)},THREE.AmmoDebugDrawer.prototype=function(){return this.debugDrawer},THREE.AmmoDebugDrawer.prototype.enable=function(){this.enabled=!0,this.scene.add(this.mesh)},THREE.AmmoDebugDrawer.prototype.disable=function(){this.enabled=!1,this.scene.remove(this.mesh)},THREE.AmmoDebugDrawer.prototype.update=function(){this.enabled&&(0!=this.index&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0),this.index=0,this.world.debugDrawWorld(),this.geometry.setDrawRange(0,this.index))},THREE.AmmoDebugDrawer.prototype.drawLine=function(t,e,i){const n=Ammo.HEAPF32,o=n[(i+0)/4],s=n[(i+4)/4],r=n[(i+8)/4],a=n[(t+0)/4],l=n[(t+4)/4],h=n[(t+8)/4];this.geometry.attributes.position.setXYZ(this.index,a,l,h),this.geometry.attributes.color.setXYZ(this.index++,o,s,r);const c=n[(e+0)/4],u=n[(e+4)/4],d=n[(e+8)/4];this.geometry.attributes.position.setXYZ(this.index,c,u,d),this.geometry.attributes.color.setXYZ(this.index++,o,s,r)},THREE.AmmoDebugDrawer.prototype.drawContactPoint=function(t,e,i,n,o){const s=Ammo.HEAPF32,r=s[(o+0)/4],a=s[(o+4)/4],l=s[(o+8)/4],h=s[(t+0)/4],c=s[(t+4)/4],u=s[(t+8)/4];this.geometry.attributes.position.setXYZ(this.index,h,c,u),this.geometry.attributes.color.setXYZ(this.index++,r,a,l);const d=s[(e+0)/4]*i,p=s[(e+4)/4]*i,f=s[(e+8)/4]*i;this.geometry.attributes.position.setXYZ(this.index,h+d,c+p,u+f),this.geometry.attributes.color.setXYZ(this.index++,r,a,l)},THREE.AmmoDebugDrawer.prototype.reportErrorWarning=function(t){Ammo.hasOwnProperty("Pointer_stringify")?console.warn(Ammo.Pointer_stringify(t)):this.warnedOnce||(this.warnedOnce=!0,console.warn("Cannot print warningString, please rebuild Ammo.js using 'debug' flag"))},THREE.AmmoDebugDrawer.prototype.draw3dText=function(t,e){console.warn("TODO: draw3dText")},THREE.AmmoDebugDrawer.prototype.setDebugMode=function(t){this.debugDrawMode=t},THREE.AmmoDebugDrawer.prototype.getDebugMode=function(){return this.debugDrawMode}},{}],4:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function t(){this.matrix={}}var e=t.prototype;return e.get=function(t,e){var i=t.id,n=e.id;if(n>i){var o=n;n=i,i=o}return i+"-"+n in this.matrix},e.set=function(t,e,i){var n=t.id,o=e.id;if(o>n){var s=o;o=n,n=s}i?this.matrix[n+"-"+o]=!0:delete this.matrix[n+"-"+o]},e.reset=function(){this.matrix={}},e.setNumObjects=function(t){},t}(),o=function(){function t(t){void 0===t&&(t=[0,0,0,0,0,0,0,0,0]),this.elements=t}var e=t.prototype;return e.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},e.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},e.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},e.getTrace=function(t){void 0===t&&(t=new s);var e=this.elements;t.x=e[0],t.y=e[4],t.z=e[8]},e.vmult=function(t,e){void 0===e&&(e=new s);var i=this.elements,n=t.x,o=t.y,r=t.z;return e.x=i[0]*n+i[1]*o+i[2]*r,e.y=i[3]*n+i[4]*o+i[5]*r,e.z=i[6]*n+i[7]*o+i[8]*r,e},e.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t},e.mmult=function(e,i){void 0===i&&(i=new t);for(var n=e.elements,o=0;o<3;o++)for(var s=0;s<3;s++){for(var r=0,a=0;a<3;a++)r+=n[o+3*a]*this.elements[a+3*s];i.elements[o+3*s]=r}return i},e.scale=function(e,i){void 0===i&&(i=new t);for(var n=this.elements,o=i.elements,s=0;3!==s;s++)o[3*s+0]=e.x*n[3*s+0],o[3*s+1]=e.y*n[3*s+1],o[3*s+2]=e.z*n[3*s+2];return i},e.solve=function(t,e){void 0===e&&(e=new s);var i,n,o=[];for(i=0;i<12;i++)o.push(0);for(i=0;i<3;i++)for(n=0;n<3;n++)o[i+4*n]=this.elements[i+3*n];o[3]=t.x,o[7]=t.y,o[11]=t.z;var r,a,l=3,h=l;do{if(0===o[(i=h-l)+4*i])for(n=i+1;n<h;n++)if(0!==o[i+4*n]){r=4;do{o[(a=4-r)+4*i]+=o[a+4*n]}while(--r);break}if(0!==o[i+4*i])for(n=i+1;n<h;n++){var c=o[i+4*n]/o[i+4*i];r=4;do{o[(a=4-r)+4*n]=a<=i?0:o[a+4*n]-o[a+4*i]*c}while(--r)}}while(--l);if(e.z=o[11]/o[10],e.y=(o[7]-o[6]*e.z)/o[5],e.x=(o[3]-o[2]*e.z-o[1]*e.y)/o[0],isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||e.x===1/0||e.y===1/0||e.z===1/0)throw"Could not solve equation! Got x=["+e.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return e},e.e=function(t,e,i){if(void 0===i)return this.elements[e+3*t];this.elements[e+3*t]=i},e.copy=function(t){for(var e=0;e<t.elements.length;e++)this.elements[e]=t.elements[e];return this},e.toString=function(){for(var t="",e=0;e<9;e++)t+=this.elements[e]+",";return t},e.reverse=function(e){void 0===e&&(e=new t);var i,n,o=[];for(i=0;i<18;i++)o.push(0);for(i=0;i<3;i++)for(n=0;n<3;n++)o[i+6*n]=this.elements[i+3*n];o[3]=1,o[9]=0,o[15]=0,o[4]=0,o[10]=1,o[16]=0,o[5]=0,o[11]=0,o[17]=1;var s,r,a=3,l=a;do{if(0===o[(i=l-a)+6*i])for(n=i+1;n<l;n++)if(0!==o[i+6*n]){s=6;do{o[(r=6-s)+6*i]+=o[r+6*n]}while(--s);break}if(0!==o[i+6*i])for(n=i+1;n<l;n++){var h=o[i+6*n]/o[i+6*i];s=6;do{o[(r=6-s)+6*n]=r<=i?0:o[r+6*n]-o[r+6*i]*h}while(--s)}}while(--a);i=2;do{n=i-1;do{var c=o[i+6*n]/o[i+6*i];s=6;do{o[(r=6-s)+6*n]=o[r+6*n]-o[r+6*i]*c}while(--s)}while(n--)}while(--i);i=2;do{var u=1/o[i+6*i];s=6;do{o[(r=6-s)+6*i]=o[r+6*i]*u}while(--s)}while(i--);i=2;do{n=2;do{if(r=o[3+n+6*i],isNaN(r)||r===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(i,n,r)}while(n--)}while(i--);return e},e.setRotationFromQuaternion=function(t){var e=t.x,i=t.y,n=t.z,o=t.w,s=e+e,r=i+i,a=n+n,l=e*s,h=e*r,c=e*a,u=i*r,d=i*a,p=n*a,f=o*s,v=o*r,m=o*a,y=this.elements;return y[0]=1-(u+p),y[1]=h-m,y[2]=c+v,y[3]=h+m,y[4]=1-(l+p),y[5]=d-f,y[6]=c-v,y[7]=d+f,y[8]=1-(l+u),this},e.transpose=function(e){void 0===e&&(e=new t);for(var i=e.elements,n=this.elements,o=0;3!==o;o++)for(var s=0;3!==s;s++)i[3*o+s]=n[3*s+o];return e},t}(),s=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}var e=t.prototype;return e.cross=function(e,i){void 0===i&&(i=new t);var n=e.x,o=e.y,s=e.z,r=this.x,a=this.y,l=this.z;return i.x=a*s-l*o,i.y=l*n-r*s,i.z=r*o-a*n,i},e.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},e.setZero=function(){this.x=this.y=this.z=0},e.vadd=function(e,i){if(!i)return new t(this.x+e.x,this.y+e.y,this.z+e.z);i.x=e.x+this.x,i.y=e.y+this.y,i.z=e.z+this.z},e.vsub=function(e,i){if(!i)return new t(this.x-e.x,this.y-e.y,this.z-e.z);i.x=this.x-e.x,i.y=this.y-e.y,i.z=this.z-e.z},e.crossmat=function(){return new o([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},e.normalize=function(){var t=this.x,e=this.y,i=this.z,n=Math.sqrt(t*t+e*e+i*i);if(n>0){var o=1/n;this.x*=o,this.y*=o,this.z*=o}else this.x=0,this.y=0,this.z=0;return n},e.unit=function(e){void 0===e&&(e=new t);var i=this.x,n=this.y,o=this.z,s=Math.sqrt(i*i+n*n+o*o);return s>0?(s=1/s,e.x=i*s,e.y=n*s,e.z=o*s):(e.x=1,e.y=0,e.z=0),e},e.length=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},e.lengthSquared=function(){return this.dot(this)},e.distanceTo=function(t){var e=this.x,i=this.y,n=this.z,o=t.x,s=t.y,r=t.z;return Math.sqrt((o-e)*(o-e)+(s-i)*(s-i)+(r-n)*(r-n))},e.distanceSquared=function(t){var e=this.x,i=this.y,n=this.z,o=t.x,s=t.y,r=t.z;return(o-e)*(o-e)+(s-i)*(s-i)+(r-n)*(r-n)},e.scale=function(e,i){void 0===i&&(i=new t);var n=this.x,o=this.y,s=this.z;return i.x=e*n,i.y=e*o,i.z=e*s,i},e.vmul=function(e,i){return void 0===i&&(i=new t),i.x=e.x*this.x,i.y=e.y*this.y,i.z=e.z*this.z,i},e.addScaledVector=function(e,i,n){return void 0===n&&(n=new t),n.x=this.x+e*i.x,n.y=this.y+e*i.y,n.z=this.z+e*i.z,n},e.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},e.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},e.negate=function(e){return void 0===e&&(e=new t),e.x=-this.x,e.y=-this.y,e.z=-this.z,e},e.tangents=function(t,e){var i=this.length();if(i>0){var n=r,o=1/i;n.set(this.x*o,this.y*o,this.z*o);var s=a;Math.abs(n.x)<.9?(s.set(1,0,0),n.cross(s,t)):(s.set(0,1,0),n.cross(s,t)),n.cross(t,e)}else t.set(1,0,0),e.set(0,1,0)},e.toString=function(){return this.x+","+this.y+","+this.z},e.toArray=function(){return[this.x,this.y,this.z]},e.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.lerp=function(t,e,i){var n=this.x,o=this.y,s=this.z;i.x=n+(t.x-n)*e,i.y=o+(t.y-o)*e,i.z=s+(t.z-s)*e},e.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},e.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)},e.isAntiparallelTo=function(t,e){return this.negate(l),l.almostEquals(t,e)},e.clone=function(){return new t(this.x,this.y,this.z)},t}();s.ZERO=new s(0,0,0),s.UNIT_X=new s(1,0,0),s.UNIT_Y=new s(0,1,0),s.UNIT_Z=new s(0,0,1);var r=new s,a=new s,l=new s,h=function(){function t(t){void 0===t&&(t={}),this.lowerBound=new s,this.upperBound=new s,t.lowerBound&&this.lowerBound.copy(t.lowerBound),t.upperBound&&this.upperBound.copy(t.upperBound)}var e=t.prototype;return e.setFromPoints=function(t,e,i,n){var o=this.lowerBound,s=this.upperBound,r=i;o.copy(t[0]),r&&r.vmult(o,o),s.copy(o);for(var a=1;a<t.length;a++){var l=t[a];r&&(r.vmult(l,c),l=c),l.x>s.x&&(s.x=l.x),l.x<o.x&&(o.x=l.x),l.y>s.y&&(s.y=l.y),l.y<o.y&&(o.y=l.y),l.z>s.z&&(s.z=l.z),l.z<o.z&&(o.z=l.z)}return e&&(e.vadd(o,o),e.vadd(s,s)),n&&(o.x-=n,o.y-=n,o.z-=n,s.x+=n,s.y+=n,s.z+=n),this},e.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},e.clone=function(){return(new t).copy(this)},e.extend=function(t){this.lowerBound.x=Math.min(this.lowerBound.x,t.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,t.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,t.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,t.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,t.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,t.upperBound.z)},e.overlaps=function(t){var e=this.lowerBound,i=this.upperBound,n=t.lowerBound,o=t.upperBound,s=n.x<=i.x&&i.x<=o.x||e.x<=o.x&&o.x<=i.x,r=n.y<=i.y&&i.y<=o.y||e.y<=o.y&&o.y<=i.y,a=n.z<=i.z&&i.z<=o.z||e.z<=o.z&&o.z<=i.z;return s&&r&&a},e.volume=function(){var t=this.lowerBound,e=this.upperBound;return(e.x-t.x)*(e.y-t.y)*(e.z-t.z)},e.contains=function(t){var e=this.lowerBound,i=this.upperBound,n=t.lowerBound,o=t.upperBound;return e.x<=n.x&&i.x>=o.x&&e.y<=n.y&&i.y>=o.y&&e.z<=n.z&&i.z>=o.z},e.getCorners=function(t,e,i,n,o,s,r,a){var l=this.lowerBound,h=this.upperBound;t.copy(l),e.set(h.x,l.y,l.z),i.set(h.x,h.y,l.z),n.set(l.x,h.y,h.z),o.set(h.x,l.y,h.z),s.set(l.x,h.y,l.z),r.set(l.x,l.y,h.z),a.copy(h)},e.toLocalFrame=function(t,e){var i=u,n=i[0],o=i[1],s=i[2],r=i[3],a=i[4],l=i[5],h=i[6],c=i[7];this.getCorners(n,o,s,r,a,l,h,c);for(var d=0;8!==d;d++){var p=i[d];t.pointToLocal(p,p)}return e.setFromPoints(i)},e.toWorldFrame=function(t,e){var i=u,n=i[0],o=i[1],s=i[2],r=i[3],a=i[4],l=i[5],h=i[6],c=i[7];this.getCorners(n,o,s,r,a,l,h,c);for(var d=0;8!==d;d++){var p=i[d];t.pointToWorld(p,p)}return e.setFromPoints(i)},e.overlapsRay=function(t){var e=t.direction,i=t.from,n=1/e.x,o=1/e.y,s=1/e.z,r=(this.lowerBound.x-i.x)*n,a=(this.upperBound.x-i.x)*n,l=(this.lowerBound.y-i.y)*o,h=(this.upperBound.y-i.y)*o,c=(this.lowerBound.z-i.z)*s,u=(this.upperBound.z-i.z)*s,d=Math.max(Math.max(Math.min(r,a),Math.min(l,h)),Math.min(c,u)),p=Math.min(Math.min(Math.max(r,a),Math.max(l,h)),Math.max(c,u));return!(p<0||d>p)},t}(),c=new s,u=[new s,new s,new s,new s,new s,new s,new s,new s],d=function(){function t(){this.matrix=[]}var e=t.prototype;return e.get=function(t,e){var i=t.index,n=e.index;if(n>i){var o=n;n=i,i=o}return this.matrix[(i*(i+1)>>1)+n-1]},e.set=function(t,e,i){var n=t.index,o=e.index;if(o>n){var s=o;o=n,n=s}this.matrix[(n*(n+1)>>1)+o-1]=i?1:0},e.reset=function(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0},e.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1},t}();function p(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function f(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var v=function(){function t(){}var e=t.prototype;return e.addEventListener=function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[t]&&(i[t]=[]),i[t].includes(e)||i[t].push(e),this},e.hasEventListener=function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return!(void 0===i[t]||!i[t].includes(e))},e.hasAnyEventListener=function(t){return void 0!==this._listeners&&void 0!==this._listeners[t]},e.removeEventListener=function(t,e){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[t])return this;var n=i[t].indexOf(e);return-1!==n&&i[t].splice(n,1),this},e.dispatchEvent=function(t){if(void 0===this._listeners)return this;var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=0,n=e.length;i<n;i++)e[i].call(this,t)}return this},t}(),m=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),this.x=t,this.y=e,this.z=i,this.w=n}var e=t.prototype;return e.set=function(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this},e.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},e.toArray=function(){return[this.x,this.y,this.z,this.w]},e.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e),this},e.toAxisAngle=function(t){void 0===t&&(t=new s),this.normalize();var e=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i),[t,e]},e.setFromVectors=function(t,e){if(t.isAntiparallelTo(e)){var i=y,n=g;t.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var o=t.cross(e);this.x=o.x,this.y=o.y,this.z=o.z,this.w=Math.sqrt(Math.pow(t.length(),2)*Math.pow(e.length(),2))+t.dot(e),this.normalize()}return this},e.mult=function(e,i){void 0===i&&(i=new t);var n=this.x,o=this.y,s=this.z,r=this.w,a=e.x,l=e.y,h=e.z,c=e.w;return i.x=n*c+r*a+o*h-s*l,i.y=o*c+r*l+s*a-n*h,i.z=s*c+r*h+n*l-o*a,i.w=r*c-n*a-o*l-s*h,i},e.inverse=function(e){void 0===e&&(e=new t);var i=this.x,n=this.y,o=this.z,s=this.w;this.conjugate(e);var r=1/(i*i+n*n+o*o+s*s);return e.x*=r,e.y*=r,e.z*=r,e.w*=r,e},e.conjugate=function(e){return void 0===e&&(e=new t),e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},e.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},e.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},e.vmult=function(t,e){void 0===e&&(e=new s);var i=t.x,n=t.y,o=t.z,r=this.x,a=this.y,l=this.z,h=this.w,c=h*i+a*o-l*n,u=h*n+l*i-r*o,d=h*o+r*n-a*i,p=-r*i-a*n-l*o;return e.x=c*h+p*-r+u*-l-d*-a,e.y=u*h+p*-a+d*-r-c*-l,e.z=d*h+p*-l+c*-a-u*-r,e},e.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},e.toEuler=function(t,e){var i,n,o;void 0===e&&(e="YZX");var s=this.x,r=this.y,a=this.z,l=this.w;if("YZX"!==e)throw new Error("Euler order "+e+" not supported yet.");var h=s*r+a*l;if(h>.499&&(i=2*Math.atan2(s,l),n=Math.PI/2,o=0),h<-.499&&(i=-2*Math.atan2(s,l),n=-Math.PI/2,o=0),void 0===i){var c=s*s,u=r*r,d=a*a;i=Math.atan2(2*r*l-2*s*a,1-2*u-2*d),n=Math.asin(2*h),o=Math.atan2(2*s*l-2*r*a,1-2*c-2*d)}t.y=i,t.z=n,t.x=o},e.setFromEuler=function(t,e,i,n){void 0===n&&(n="XYZ");var o=Math.cos(t/2),s=Math.cos(e/2),r=Math.cos(i/2),a=Math.sin(t/2),l=Math.sin(e/2),h=Math.sin(i/2);return"XYZ"===n?(this.x=a*s*r+o*l*h,this.y=o*l*r-a*s*h,this.z=o*s*h+a*l*r,this.w=o*s*r-a*l*h):"YXZ"===n?(this.x=a*s*r+o*l*h,this.y=o*l*r-a*s*h,this.z=o*s*h-a*l*r,this.w=o*s*r+a*l*h):"ZXY"===n?(this.x=a*s*r-o*l*h,this.y=o*l*r+a*s*h,this.z=o*s*h+a*l*r,this.w=o*s*r-a*l*h):"ZYX"===n?(this.x=a*s*r-o*l*h,this.y=o*l*r+a*s*h,this.z=o*s*h-a*l*r,this.w=o*s*r+a*l*h):"YZX"===n?(this.x=a*s*r+o*l*h,this.y=o*l*r+a*s*h,this.z=o*s*h-a*l*r,this.w=o*s*r-a*l*h):"XZY"===n&&(this.x=a*s*r-o*l*h,this.y=o*l*r-a*s*h,this.z=o*s*h+a*l*r,this.w=o*s*r+a*l*h),this},e.clone=function(){return new t(this.x,this.y,this.z,this.w)},e.slerp=function(e,i,n){void 0===n&&(n=new t);var o,s,r,a,l,h=this.x,c=this.y,u=this.z,d=this.w,p=e.x,f=e.y,v=e.z,m=e.w;return(s=h*p+c*f+u*v+d*m)<0&&(s=-s,p=-p,f=-f,v=-v,m=-m),1-s>1e-6?(o=Math.acos(s),r=Math.sin(o),a=Math.sin((1-i)*o)/r,l=Math.sin(i*o)/r):(a=1-i,l=i),n.x=a*h+l*p,n.y=a*c+l*f,n.z=a*u+l*v,n.w=a*d+l*m,n},e.integrate=function(e,i,n,o){void 0===o&&(o=new t);var s=e.x*n.x,r=e.y*n.y,a=e.z*n.z,l=this.x,h=this.y,c=this.z,u=this.w,d=.5*i;return o.x+=d*(s*u+r*c-a*h),o.y+=d*(r*u+a*l-s*c),o.z+=d*(a*u+s*h-r*l),o.w+=d*(-s*l-r*h-a*c),o},t}(),y=new s,g=new s,w={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256},b=function(){function t(e){void 0===e&&(e={}),this.id=t.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}var e=t.prototype;return e.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},e.volume=function(){throw"volume() not implemented for shape type "+this.type},e.calculateLocalInertia=function(t,e){throw"calculateLocalInertia() not implemented for shape type "+this.type},e.calculateWorldAABB=function(t,e,i,n){throw"calculateWorldAABB() not implemented for shape type "+this.type},t}();b.idCounter=0,b.types=w;var x=function(){function t(t){void 0===t&&(t={}),this.position=new s,this.quaternion=new m,t.position&&this.position.copy(t.position),t.quaternion&&this.quaternion.copy(t.quaternion)}var e=t.prototype;return e.pointToLocal=function(e,i){return t.pointToLocalFrame(this.position,this.quaternion,e,i)},e.pointToWorld=function(e,i){return t.pointToWorldFrame(this.position,this.quaternion,e,i)},e.vectorToWorldFrame=function(t,e){return void 0===e&&(e=new s),this.quaternion.vmult(t,e),e},t.pointToLocalFrame=function(t,e,i,n){return void 0===n&&(n=new s),i.vsub(t,n),e.conjugate(E),E.vmult(n,n),n},t.pointToWorldFrame=function(t,e,i,n){return void 0===n&&(n=new s),e.vmult(i,n),n.vadd(t,n),n},t.vectorToWorldFrame=function(t,e,i){return void 0===i&&(i=new s),t.vmult(e,i),i},t.vectorToLocalFrame=function(t,e,i,n){return void 0===n&&(n=new s),e.w*=-1,e.vmult(i,n),e.w*=-1,n},t}(),E=new m,A=function(t){function e(e){var i;void 0===e&&(e={});var n=e,o=n.vertices,s=void 0===o?[]:o,r=n.faces,a=void 0===r?[]:r,l=n.normals,h=void 0===l?[]:l,c=n.axes,u=n.boundingSphereRadius;return(i=t.call(this,{type:b.types.CONVEXPOLYHEDRON})||this).vertices=s,i.faces=a,i.faceNormals=h,0===i.faceNormals.length&&i.computeNormals(),u?i.boundingSphereRadius=u:i.updateBoundingSphereRadius(),i.worldVertices=[],i.worldVerticesNeedsUpdate=!0,i.worldFaceNormals=[],i.worldFaceNormalsNeedsUpdate=!0,i.uniqueAxes=c?c.slice():null,i.uniqueEdges=[],i.computeEdges(),i}p(e,t);var i=e.prototype;return i.computeEdges=function(){var t=this.faces,e=this.vertices,i=this.uniqueEdges;i.length=0;for(var n=new s,o=0;o!==t.length;o++)for(var r=t[o],a=r.length,l=0;l!==a;l++){var h=(l+1)%a;e[r[l]].vsub(e[r[h]],n),n.normalize();for(var c=!1,u=0;u!==i.length;u++)if(i[u].almostEquals(n)||i[u].almostEquals(n)){c=!0;break}c||i.push(n.clone())}},i.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var e=0;e<this.faces[t].length;e++)if(!this.vertices[this.faces[t][e]])throw new Error("Vertex "+this.faces[t][e]+" not found!");var i=this.faceNormals[t]||new s;this.getFaceNormal(t,i),i.negate(i),this.faceNormals[t]=i;var n=this.vertices[this.faces[t][0]];if(i.dot(n)<0){console.error(".faceNormals["+t+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var o=0;o<this.faces[t].length;o++)console.warn(".vertices["+this.faces[t][o]+"] = Vec3("+this.vertices[this.faces[t][o]].toString()+")")}}},i.getFaceNormal=function(t,i){var n=this.faces[t],o=this.vertices[n[0]],s=this.vertices[n[1]],r=this.vertices[n[2]];e.computeNormal(o,s,r,i)},i.clipAgainstHull=function(t,e,i,n,o,r,a,l,h){for(var c=new s,u=-1,d=-Number.MAX_VALUE,p=0;p<i.faces.length;p++){c.copy(i.faceNormals[p]),o.vmult(c,c);var f=c.dot(r);f>d&&(d=f,u=p)}for(var v=[],m=0;m<i.faces[u].length;m++){var y=i.vertices[i.faces[u][m]],g=new s;g.copy(y),o.vmult(g,g),n.vadd(g,g),v.push(g)}u>=0&&this.clipFaceAgainstHull(r,t,e,v,a,l,h)},i.findSeparatingAxis=function(t,e,i,n,o,r,a,l){var h=new s,c=new s,u=new s,d=new s,p=new s,f=new s,v=Number.MAX_VALUE;if(this.uniqueAxes)for(var m=0;m!==this.uniqueAxes.length;m++){i.vmult(this.uniqueAxes[m],h);var y=this.testSepAxis(h,t,e,i,n,o);if(!1===y)return!1;y<v&&(v=y,r.copy(h))}else for(var g=a?a.length:this.faces.length,w=0;w<g;w++){var b=a?a[w]:w;h.copy(this.faceNormals[b]),i.vmult(h,h);var x=this.testSepAxis(h,t,e,i,n,o);if(!1===x)return!1;x<v&&(v=x,r.copy(h))}if(t.uniqueAxes)for(var E=0;E!==t.uniqueAxes.length;E++){o.vmult(t.uniqueAxes[E],c);var A=this.testSepAxis(c,t,e,i,n,o);if(!1===A)return!1;A<v&&(v=A,r.copy(c))}else for(var S=l?l.length:t.faces.length,C=0;C<S;C++){var T=l?l[C]:C;c.copy(t.faceNormals[T]),o.vmult(c,c);var B=this.testSepAxis(c,t,e,i,n,o);if(!1===B)return!1;B<v&&(v=B,r.copy(c))}for(var M=0;M!==this.uniqueEdges.length;M++){i.vmult(this.uniqueEdges[M],d);for(var z=0;z!==t.uniqueEdges.length;z++)if(o.vmult(t.uniqueEdges[z],p),d.cross(p,f),!f.almostZero()){f.normalize();var R=this.testSepAxis(f,t,e,i,n,o);if(!1===R)return!1;R<v&&(v=R,r.copy(f))}}return n.vsub(e,u),u.dot(r)>0&&r.negate(r),!0},i.testSepAxis=function(t,i,n,o,s,r){e.project(this,t,n,o,S),e.project(i,t,s,r,C);var a=S[0],l=S[1],h=C[0],c=C[1];if(a<c||h<l)return!1;var u=a-c,d=h-l;return u<d?u:d},i.calculateLocalInertia=function(t,e){var i=new s,n=new s;this.computeLocalAABB(n,i);var o=i.x-n.x,r=i.y-n.y,a=i.z-n.z;e.x=1/12*t*(2*r*2*r+2*a*2*a),e.y=1/12*t*(2*o*2*o+2*a*2*a),e.z=1/12*t*(2*r*2*r+2*o*2*o)},i.getPlaneConstantOfFace=function(t){var e=this.faces[t],i=this.faceNormals[t],n=this.vertices[e[0]];return-i.dot(n)},i.clipFaceAgainstHull=function(t,e,i,n,o,r,a){for(var l=new s,h=new s,c=new s,u=new s,d=new s,p=new s,f=new s,v=new s,m=n,y=[],g=-1,w=Number.MAX_VALUE,b=0;b<this.faces.length;b++){l.copy(this.faceNormals[b]),i.vmult(l,l);var x=l.dot(t);x<w&&(w=x,g=b)}if(!(g<0)){var E=this.faces[g];E.connectedFaces=[];for(var A=0;A<this.faces.length;A++)for(var S=0;S<this.faces[A].length;S++)-1!==E.indexOf(this.faces[A][S])&&A!==g&&-1===E.connectedFaces.indexOf(A)&&E.connectedFaces.push(A);for(var C=E.length,T=0;T<C;T++){var B=this.vertices[E[T]],M=this.vertices[E[(T+1)%C]];B.vsub(M,h),c.copy(h),i.vmult(c,c),e.vadd(c,c),u.copy(this.faceNormals[g]),i.vmult(u,u),e.vadd(u,u),c.cross(u,d),d.negate(d),p.copy(B),i.vmult(p,p),e.vadd(p,p);var z=E.connectedFaces[T];f.copy(this.faceNormals[z]);var R=this.getPlaneConstantOfFace(z);v.copy(f),i.vmult(v,v);var P=R-v.dot(e);for(this.clipFaceAgainstPlane(m,y,v,P);m.length;)m.shift();for(;y.length;)m.push(y.shift())}f.copy(this.faceNormals[g]);var I=this.getPlaneConstantOfFace(g);v.copy(f),i.vmult(v,v);for(var F=I-v.dot(e),L=0;L<m.length;L++){var N=v.dot(m[L])+F;if(N<=o&&(console.log("clamped: depth="+N+" to minDist="+o),N=o),N<=r){var D=m[L];if(N<=1e-6){var V={point:D,normal:v,depth:N};a.push(V)}}}}},i.clipFaceAgainstPlane=function(t,e,i,n){var o,r,a=t.length;if(a<2)return e;var l=t[t.length-1],h=t[0];o=i.dot(l)+n;for(var c=0;c<a;c++){if(h=t[c],r=i.dot(h)+n,o<0)if(r<0){var u=new s;u.copy(h),e.push(u)}else{var d=new s;l.lerp(h,o/(o-r),d),e.push(d)}else if(r<0){var p=new s;l.lerp(h,o/(o-r),p),e.push(p),e.push(h)}l=h,o=r}return e},i.computeWorldVertices=function(t,e){for(;this.worldVertices.length<this.vertices.length;)this.worldVertices.push(new s);for(var i=this.vertices,n=this.worldVertices,o=0;o!==this.vertices.length;o++)e.vmult(i[o],n[o]),t.vadd(n[o],n[o]);this.worldVerticesNeedsUpdate=!1},i.computeLocalAABB=function(t,e){var i=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var n=0;n<this.vertices.length;n++){var o=i[n];o.x<t.x?t.x=o.x:o.x>e.x&&(e.x=o.x),o.y<t.y?t.y=o.y:o.y>e.y&&(e.y=o.y),o.z<t.z?t.z=o.z:o.z>e.z&&(e.z=o.z)}},i.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new s);for(var i=this.faceNormals,n=this.worldFaceNormals,o=0;o!==e;o++)t.vmult(i[o],n[o]);this.worldFaceNormalsNeedsUpdate=!1},i.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0;i!==e.length;i++){var n=e[i].lengthSquared();n>t&&(t=n)}this.boundingSphereRadius=Math.sqrt(t)},i.calculateWorldAABB=function(t,e,i,n){for(var o,r,a,l,h,c,u=this.vertices,d=new s,p=0;p<u.length;p++){d.copy(u[p]),e.vmult(d,d),t.vadd(d,d);var f=d;(void 0===o||f.x<o)&&(o=f.x),(void 0===l||f.x>l)&&(l=f.x),(void 0===r||f.y<r)&&(r=f.y),(void 0===h||f.y>h)&&(h=f.y),(void 0===a||f.z<a)&&(a=f.z),(void 0===c||f.z>c)&&(c=f.z)}i.set(o,r,a),n.set(l,h,c)},i.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},i.getAveragePointLocal=function(t){void 0===t&&(t=new s);for(var e=this.vertices,i=0;i<e.length;i++)t.vadd(e[i],t);return t.scale(1/e.length,t),t},i.transformAllPoints=function(t,e){var i=this.vertices.length,n=this.vertices;if(e){for(var o=0;o<i;o++){var s=n[o];e.vmult(s,s)}for(var r=0;r<this.faceNormals.length;r++){var a=this.faceNormals[r];e.vmult(a,a)}}if(t)for(var l=0;l<i;l++){var h=n[l];h.vadd(t,h)}},i.pointIsInside=function(t){var e=this.vertices,i=this.faces,n=this.faceNormals,o=new s;this.getAveragePointLocal(o);for(var r=0;r<this.faces.length;r++){var a=n[r],l=e[i[r][0]],h=new s;t.vsub(l,h);var c=a.dot(h),u=new s;o.vsub(l,u);var d=a.dot(u);if(c<0&&d>0||c>0&&d<0)return!1}return-1},e}(b);A.computeNormal=function(t,e,i,n){var o=new s,r=new s;e.vsub(t,r),i.vsub(e,o),o.cross(r,n),n.isZero()||n.normalize()};var S=[],C=[];A.project=function(t,e,i,n,o){var r=t.vertices.length,a=new s,l=0,h=0,c=new s,u=t.vertices;c.setZero(),x.vectorToLocalFrame(i,n,e,a),x.pointToLocalFrame(i,n,c,c);var d=c.dot(a);h=l=u[0].dot(a);for(var p=1;p<r;p++){var f=u[p].dot(a);f>l&&(l=f),f<h&&(h=f)}if((h-=d)>(l-=d)){var v=h;h=l,l=v}o[0]=l,o[1]=h};var T=function(t){function e(e){var i;return(i=t.call(this,{type:b.types.BOX})||this).halfExtents=e,i.convexPolyhedronRepresentation=null,i.updateConvexPolyhedronRepresentation(),i.updateBoundingSphereRadius(),i}p(e,t);var i=e.prototype;return i.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,i=this.halfExtents.z,n=s,o=[new n(-t,-e,-i),new n(t,-e,-i),new n(t,e,-i),new n(-t,e,-i),new n(-t,-e,i),new n(t,-e,i),new n(t,e,i),new n(-t,e,i)],r=[new n(0,0,1),new n(0,1,0),new n(1,0,0)],a=new A({vertices:o,faces:[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],axes:r});this.convexPolyhedronRepresentation=a,a.material=this.material},i.calculateLocalInertia=function(t,i){return void 0===i&&(i=new s),e.calculateInertia(this.halfExtents,t,i),i},i.getSideNormals=function(t,e){var i=t,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==e)for(var o=0;o!==i.length;o++)e.vmult(i[o],i[o]);return i},i.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},i.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.length()},i.forEachWorldCorner=function(t,e,i){for(var n=this.halfExtents,o=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],s=0;s<o.length;s++)B.set(o[s][0],o[s][1],o[s][2]),e.vmult(B,B),t.vadd(B,B),i(B.x,B.y,B.z)},i.calculateWorldAABB=function(t,e,i,n){var o=this.halfExtents;M[0].set(o.x,o.y,o.z),M[1].set(-o.x,o.y,o.z),M[2].set(-o.x,-o.y,o.z),M[3].set(-o.x,-o.y,-o.z),M[4].set(o.x,-o.y,-o.z),M[5].set(o.x,o.y,-o.z),M[6].set(-o.x,o.y,-o.z),M[7].set(o.x,-o.y,o.z);var s=M[0];e.vmult(s,s),t.vadd(s,s),n.copy(s),i.copy(s);for(var r=1;r<8;r++){var a=M[r];e.vmult(a,a),t.vadd(a,a);var l=a.x,h=a.y,c=a.z;l>n.x&&(n.x=l),h>n.y&&(n.y=h),c>n.z&&(n.z=c),l<i.x&&(i.x=l),h<i.y&&(i.y=h),c<i.z&&(i.z=c)}},e}(b);T.calculateInertia=function(t,e,i){var n=t;i.x=1/12*e*(2*n.y*2*n.y+2*n.z*2*n.z),i.y=1/12*e*(2*n.x*2*n.x+2*n.z*2*n.z),i.z=1/12*e*(2*n.y*2*n.y+2*n.x*2*n.x)};var B=new s,M=[new s,new s,new s,new s,new s,new s,new s,new s],z={AWAKE:0,SLEEPY:1,SLEEPING:2},R=function(t){function e(i){var n;void 0===i&&(i={}),(n=t.call(this)||this).id=e.idCounter++,n.index=-1,n.world=null,n.preStep=null,n.postStep=null,n.vlambda=new s,n.collisionFilterGroup="number"==typeof i.collisionFilterGroup?i.collisionFilterGroup:1,n.collisionFilterMask="number"==typeof i.collisionFilterMask?i.collisionFilterMask:-1,n.collisionResponse="boolean"!=typeof i.collisionResponse||i.collisionResponse,n.position=new s,n.previousPosition=new s,n.interpolatedPosition=new s,n.initPosition=new s,i.position&&(n.position.copy(i.position),n.previousPosition.copy(i.position),n.interpolatedPosition.copy(i.position),n.initPosition.copy(i.position)),n.velocity=new s,i.velocity&&n.velocity.copy(i.velocity),n.initVelocity=new s,n.force=new s;var r="number"==typeof i.mass?i.mass:0;return n.mass=r,n.invMass=r>0?1/r:0,n.material=i.material||null,n.linearDamping="number"==typeof i.linearDamping?i.linearDamping:.01,n.type=r<=0?e.STATIC:e.DYNAMIC,typeof i.type==typeof e.STATIC&&(n.type=i.type),n.allowSleep=void 0===i.allowSleep||i.allowSleep,n.sleepState=0,n.sleepSpeedLimit=void 0!==i.sleepSpeedLimit?i.sleepSpeedLimit:.1,n.sleepTimeLimit=void 0!==i.sleepTimeLimit?i.sleepTimeLimit:1,n.timeLastSleepy=0,n.wakeUpAfterNarrowphase=!1,n.torque=new s,n.quaternion=new m,n.initQuaternion=new m,n.previousQuaternion=new m,n.interpolatedQuaternion=new m,i.quaternion&&(n.quaternion.copy(i.quaternion),n.initQuaternion.copy(i.quaternion),n.previousQuaternion.copy(i.quaternion),n.interpolatedQuaternion.copy(i.quaternion)),n.angularVelocity=new s,i.angularVelocity&&n.angularVelocity.copy(i.angularVelocity),n.initAngularVelocity=new s,n.shapes=[],n.shapeOffsets=[],n.shapeOrientations=[],n.inertia=new s,n.invInertia=new s,n.invInertiaWorld=new o,n.invMassSolve=0,n.invInertiaSolve=new s,n.invInertiaWorldSolve=new o,n.fixedRotation=void 0!==i.fixedRotation&&i.fixedRotation,n.angularDamping=void 0!==i.angularDamping?i.angularDamping:.01,n.linearFactor=new s(1,1,1),i.linearFactor&&n.linearFactor.copy(i.linearFactor),n.angularFactor=new s(1,1,1),i.angularFactor&&n.angularFactor.copy(i.angularFactor),n.aabb=new h,n.aabbNeedsUpdate=!0,n.boundingRadius=0,n.wlambda=new s,i.shape&&n.addShape(i.shape),n.updateMassProperties(),n}p(e,t);var i=e.prototype;return i.wakeUp=function(){var t=this.sleepState;this.sleepState=0,this.wakeUpAfterNarrowphase=!1,t===e.SLEEPING&&this.dispatchEvent(e.wakeupEvent)},i.sleep=function(){this.sleepState=e.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.wakeUpAfterNarrowphase=!1},i.sleepTick=function(t){if(this.allowSleep){var i=this.sleepState,n=this.velocity.lengthSquared()+this.angularVelocity.lengthSquared(),o=Math.pow(this.sleepSpeedLimit,2);i===e.AWAKE&&n<o?(this.sleepState=e.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(e.sleepyEvent)):i===e.SLEEPY&&n>o?this.wakeUp():i===e.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(e.sleepEvent))}},i.updateSolveMassProperties=function(){this.sleepState===e.SLEEPING||this.type===e.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},i.pointToLocalFrame=function(t,e){return void 0===e&&(e=new s),t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e},i.vectorToLocalFrame=function(t,e){return void 0===e&&(e=new s),this.quaternion.conjugate().vmult(t,e),e},i.pointToWorldFrame=function(t,e){return void 0===e&&(e=new s),this.quaternion.vmult(t,e),e.vadd(this.position,e),e},i.vectorToWorldFrame=function(t,e){return void 0===e&&(e=new s),this.quaternion.vmult(t,e),e},i.addShape=function(t,e,i){var n=new s,o=new m;return e&&n.copy(e),i&&o.copy(i),this.shapes.push(t),this.shapeOffsets.push(n),this.shapeOrientations.push(o),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,t.body=this,this},i.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,i=t.length,n=0,o=0;o!==i;o++){var s=t[o];s.updateBoundingSphereRadius();var r=e[o].length(),a=s.boundingSphereRadius;r+a>n&&(n=r+a)}this.boundingRadius=n},i.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,i=this.shapeOrientations,n=t.length,o=P,s=I,r=this.quaternion,a=this.aabb,l=F,h=0;h!==n;h++){var c=t[h];r.vmult(e[h],o),o.vadd(this.position,o),r.mult(i[h],s),c.calculateWorldAABB(o,s,l.lowerBound,l.upperBound),0===h?a.copy(l):a.extend(l)}this.aabbNeedsUpdate=!1},i.updateInertiaWorld=function(t){var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var i=L,n=N;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(e,i),i.mmult(n,this.invInertiaWorld)}},i.applyForce=function(t,i){if(this.type===e.DYNAMIC){var n=D;i.cross(t,n),this.force.vadd(t,this.force),this.torque.vadd(n,this.torque)}},i.applyLocalForce=function(t,i){if(this.type===e.DYNAMIC){var n=V,o=O;this.vectorToWorldFrame(t,n),this.vectorToWorldFrame(i,o),this.applyForce(n,o)}},i.applyImpulse=function(t,i){if(this.type===e.DYNAMIC){var n=i,o=H;o.copy(t),o.scale(this.invMass,o),this.velocity.vadd(o,this.velocity);var s=q;n.cross(t,s),this.invInertiaWorld.vmult(s,s),this.angularVelocity.vadd(s,this.angularVelocity)}},i.applyLocalImpulse=function(t,i){if(this.type===e.DYNAMIC){var n=_,o=W;this.vectorToWorldFrame(t,n),this.vectorToWorldFrame(i,o),this.applyImpulse(n,o)}},i.updateMassProperties=function(){var t=k;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,i=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),T.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!i?1/e.x:0,e.y>0&&!i?1/e.y:0,e.z>0&&!i?1/e.z:0),this.updateInertiaWorld(!0)},i.getVelocityAtWorldPoint=function(t,e){var i=new s;return t.vsub(this.position,i),this.angularVelocity.cross(i,e),this.velocity.vadd(e,e),e},i.integrate=function(t,i,n){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===e.DYNAMIC||this.type===e.KINEMATIC)&&this.sleepState!==e.SLEEPING){var o=this.velocity,s=this.angularVelocity,r=this.position,a=this.force,l=this.torque,h=this.quaternion,c=this.invMass,u=this.invInertiaWorld,d=this.linearFactor,p=c*t;o.x+=a.x*p*d.x,o.y+=a.y*p*d.y,o.z+=a.z*p*d.z;var f=u.elements,v=this.angularFactor,m=l.x*v.x,y=l.y*v.y,g=l.z*v.z;s.x+=t*(f[0]*m+f[1]*y+f[2]*g),s.y+=t*(f[3]*m+f[4]*y+f[5]*g),s.z+=t*(f[6]*m+f[7]*y+f[8]*g),r.x+=o.x*t,r.y+=o.y*t,r.z+=o.z*t,h.integrate(this.angularVelocity,t,this.angularFactor,h),i&&(n?h.normalizeFast():h.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},e}(v);R.COLLIDE_EVENT_NAME="collide",R.DYNAMIC=1,R.STATIC=2,R.KINEMATIC=4,R.AWAKE=z.AWAKE,R.SLEEPY=z.SLEEPY,R.SLEEPING=z.SLEEPING,R.idCounter=0,R.wakeupEvent={type:"wakeup"},R.sleepyEvent={type:"sleepy"},R.sleepEvent={type:"sleep"};var P=new s,I=new m,F=new h,L=new o,N=new o,D=(new o,new s),V=new s,O=new s,H=new s,q=new s,_=new s,W=new s,k=new s,j=function(){function t(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}var e=t.prototype;return e.collisionPairs=function(t,e,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")},e.needBroadphaseCollision=function(t,e){return 0!=(t.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&t.collisionFilterMask)&&(0==(t.type&R.STATIC)&&t.sleepState!==R.SLEEPING||0==(e.type&R.STATIC)&&e.sleepState!==R.SLEEPING)},e.intersectionTest=function(t,e,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,n):this.doBoundingSphereBroadphase(t,e,i,n)},e.doBoundingSphereBroadphase=function(t,e,i,n){var o=U;e.position.vsub(t.position,o);var s=Math.pow(t.boundingRadius+e.boundingRadius,2);o.lengthSquared()<s&&(i.push(t),n.push(e))},e.doBoundingBoxBroadphase=function(t,e,i,n){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(i.push(t),n.push(e))},e.makePairsUnique=function(t,e){for(var i=G,n=Y,o=X,s=t.length,r=0;r!==s;r++)n[r]=t[r],o[r]=e[r];t.length=0,e.length=0;for(var a=0;a!==s;a++){var l=n[a].id,h=o[a].id,c=l<h?l+","+h:h+","+l;i[c]=a,i.keys.push(c)}for(var u=0;u!==i.keys.length;u++){var d=i.keys.pop(),p=i[d];t.push(n[p]),e.push(o[p]),delete i[d]}},e.setWorld=function(t){},e.aabbQuery=function(t,e,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]},t}(),U=new s,G=(new s,new m,new s,{keys:[]}),Y=[],X=[];new s,j.boundingSphereCheck=function(t,e){var i=new s;t.position.vsub(e.position,i);var n=t.shapes[0],o=e.shapes[0];return Math.pow(n.boundingSphereRadius+o.boundingSphereRadius,2)>i.lengthSquared()};var Q=function(t){function e(e,i,n,o,r){var a;void 0===e&&(e=new s(100,100,100)),void 0===i&&(i=new s(-100,-100,-100)),void 0===n&&(n=10),void 0===o&&(o=10),void 0===r&&(r=10),(a=t.call(this)||this).nx=n,a.ny=o,a.nz=r,a.aabbMin=e,a.aabbMax=i;var l=a.nx*a.ny*a.nz;if(l<=0)throw"GridBroadphase: Each dimension's n must be >0";a.bins=[],a.binLengths=[],a.bins.length=l,a.binLengths.length=l;for(var h=0;h<l;h++)a.bins[h]=[],a.binLengths[h]=0;return a}return p(e,t),e.prototype.collisionPairs=function(t,e,i){for(var n=t.numObjects(),o=t.bodies,s=this.aabbMax,r=this.aabbMin,a=this.nx,l=this.ny,h=this.nz,c=l*h,u=h,d=s.x,p=s.y,f=s.z,v=r.x,m=r.y,y=r.z,g=a/(d-v),w=l/(p-m),x=h/(f-y),E=(d-v)/a,A=(p-m)/l,S=(f-y)/h,C=.5*Math.sqrt(E*E+A*A+S*S),T=b.types,B=T.SPHERE,M=T.PLANE,z=(T.BOX,T.COMPOUND,T.CONVEXPOLYHEDRON,this.bins),R=this.binLengths,P=this.bins.length,I=0;I!==P;I++)R[I]=0;var F=Math.ceil;function L(t,e,i,n,o,s,r){var d=(t-v)*g|0,p=(e-m)*w|0,f=(i-y)*x|0,b=F((n-v)*g),E=F((o-m)*w),A=F((s-y)*x);d<0?d=0:d>=a&&(d=a-1),p<0?p=0:p>=l&&(p=l-1),f<0?f=0:f>=h&&(f=h-1),b<0?b=0:b>=a&&(b=a-1),E<0?E=0:E>=l&&(E=l-1),A<0?A=0:A>=h&&(A=h-1),p*=u,f*=1,b*=c,E*=u,A*=1;for(var S=d*=c;S<=b;S+=c)for(var C=p;C<=E;C+=u)for(var T=f;T<=A;T+=1){var B=S+C+T;z[B][R[B]++]=r}}for(var N=0;N!==n;N++){var D=o[N],V=D.shapes[0];switch(V.type){case B:var O=V,H=D.position.x,q=D.position.y,_=D.position.z,W=O.radius;L(H-W,q-W,_-W,H+W,q+W,_+W,D);break;case M:var k=V;k.worldNormalNeedsUpdate&&k.computeWorldNormal(D.quaternion);var j=k.worldNormal,U=v+.5*E-D.position.x,G=m+.5*A-D.position.y,Y=y+.5*S-D.position.z,X=Z;X.set(U,G,Y);for(var Q=0,K=0;Q!==a;Q++,K+=c,X.y=G,X.x+=E)for(var J=0,$=0;J!==l;J++,$+=u,X.z=Y,X.y+=A)for(var tt=0,et=0;tt!==h;tt++,et+=1,X.z+=S)if(X.dot(j)<C){var it=K+$+et;z[it][R[it]++]=D}break;default:D.aabbNeedsUpdate&&D.computeAABB(),L(D.aabb.lowerBound.x,D.aabb.lowerBound.y,D.aabb.lowerBound.z,D.aabb.upperBound.x,D.aabb.upperBound.y,D.aabb.upperBound.z,D)}}for(var nt=0;nt!==P;nt++){var ot=R[nt];if(ot>1)for(var st=z[nt],rt=0;rt!==ot;rt++)for(var at=st[rt],lt=0;lt!==rt;lt++){var ht=st[lt];this.needBroadphaseCollision(at,ht)&&this.intersectionTest(at,ht,e,i)}}this.makePairsUnique(e,i)},e}(j),Z=new s,K=(new s,function(t){function e(){return t.call(this)||this}p(e,t);var i=e.prototype;return i.collisionPairs=function(t,e,i){for(var n,o,s=t.bodies,r=s.length,a=0;a!==r;a++)for(var l=0;l!==a;l++)n=s[a],o=s[l],this.needBroadphaseCollision(n,o)&&this.intersectionTest(n,o,e,i)},i.aabbQuery=function(t,e,i){void 0===i&&(i=[]);for(var n=0;n<t.bodies.length;n++){var o=t.bodies[n];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(e)&&i.push(o)}return i},e}(j)),J=function(){function t(){this.rayFromWorld=new s,this.rayToWorld=new s,this.hitNormalWorld=new s,this.hitPointWorld=new s,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}var e=t.prototype;return e.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1},e.abort=function(){this.shouldStop=!0},e.set=function(t,e,i,n,o,s,r){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=o,this.body=s,this.distance=r},t}(),$=function(){function t(e,i){void 0===e&&(e=new s),void 0===i&&(i=new s),this.from=e.clone(),this.to=i.clone(),this.direction=new s,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=t.ANY,this.result=new J,this.hasHit=!1,this.callback=function(t){}}var e=t.prototype;return e.intersectWorld=function(e,i){return this.mode=i.mode||t.ANY,this.result=i.result||new J,this.skipBackfaces=!!i.skipBackfaces,this.collisionFilterMask=void 0!==i.collisionFilterMask?i.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==i.collisionFilterGroup?i.collisionFilterGroup:-1,this.checkCollisionResponse=void 0===i.checkCollisionResponse||i.checkCollisionResponse,i.from&&this.from.copy(i.from),i.to&&this.to.copy(i.to),this.callback=i.callback||function(){},this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(tt),et.length=0,e.broadphase.aabbQuery(e,tt,et),this.intersectBodies(et),this.hasHit},e.intersectBody=function(t,e){e&&(this.result=e,this.updateDirection());var i=this.checkCollisionResponse;if((!i||t.collisionResponse)&&0!=(this.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&this.collisionFilterMask))for(var n=st,o=rt,s=0,r=t.shapes.length;s<r;s++){var a=t.shapes[s];if((!i||a.collisionResponse)&&(t.quaternion.mult(t.shapeOrientations[s],o),t.quaternion.vmult(t.shapeOffsets[s],n),n.vadd(t.position,n),this.intersectShape(a,o,n,t),this.result.shouldStop))break}},e.intersectBodies=function(t,e){e&&(this.result=e,this.updateDirection());for(var i=0,n=t.length;!this.result.shouldStop&&i<n;i++)this.intersectBody(t[i])},e.updateDirection=function(){this.to.vsub(this.from,this.direction),this.direction.normalize()},e.intersectShape=function(t,e,i,n){if(!(function(t,e,i){i.vsub(t,Bt);var n=Bt.dot(e);return e.scale(n,Mt),Mt.vadd(t,Mt),i.distanceTo(Mt)}(this.from,this.direction,i)>t.boundingSphereRadius)){var o=this[t.type];o&&o.call(this,t,e,i,n,t)}},e._intersectBox=function(t,e,i,n,o){return this._intersectConvex(t.convexPolyhedronRepresentation,e,i,n,o)},e._intersectPlane=function(t,e,i,n,o){var r=this.from,a=this.to,l=this.direction,h=new s(0,0,1);e.vmult(h,h);var c=new s;r.vsub(i,c);var u=c.dot(h);if(a.vsub(i,c),!(u*c.dot(h)>0||r.distanceTo(a)<u)){var d=h.dot(l);if(!(Math.abs(d)<this.precision)){var p=new s,f=new s,v=new s;r.vsub(i,p);var m=-h.dot(p)/d;l.scale(m,f),r.vadd(f,v),this.reportIntersection(h,v,o,n,-1)}}},e.getAABB=function(t){var e=t.lowerBound,i=t.upperBound,n=this.to,o=this.from;e.x=Math.min(n.x,o.x),e.y=Math.min(n.y,o.y),e.z=Math.min(n.z,o.z),i.x=Math.max(n.x,o.x),i.y=Math.max(n.y,o.y),i.z=Math.max(n.z,o.z)},e._intersectHeightfield=function(t,e,i,n,o){t.data,t.elementSize;var s=pt;s.from.copy(this.from),s.to.copy(this.to),x.pointToLocalFrame(i,e,s.from,s.from),x.pointToLocalFrame(i,e,s.to,s.to),s.updateDirection();var r,a,l,c,u=ft;r=a=0,l=c=t.data.length-1;var d=new h;s.getAABB(d),t.getIndexOfPosition(d.lowerBound.x,d.lowerBound.y,u,!0),r=Math.max(r,u[0]),a=Math.max(a,u[1]),t.getIndexOfPosition(d.upperBound.x,d.upperBound.y,u,!0),l=Math.min(l,u[0]+1),c=Math.min(c,u[1]+1);for(var p=r;p<l;p++)for(var f=a;f<c;f++){if(this.result.shouldStop)return;if(t.getAabbAtIndex(p,f,d),d.overlapsRay(s)){if(t.getConvexTrianglePillar(p,f,!1),x.pointToWorldFrame(i,e,t.pillarOffset,dt),this._intersectConvex(t.pillarConvex,e,dt,n,o,ut),this.result.shouldStop)return;t.getConvexTrianglePillar(p,f,!0),x.pointToWorldFrame(i,e,t.pillarOffset,dt),this._intersectConvex(t.pillarConvex,e,dt,n,o,ut)}}},e._intersectSphere=function(t,e,i,n,o){var s=this.from,r=this.to,a=t.radius,l=Math.pow(r.x-s.x,2)+Math.pow(r.y-s.y,2)+Math.pow(r.z-s.z,2),h=2*((r.x-s.x)*(s.x-i.x)+(r.y-s.y)*(s.y-i.y)+(r.z-s.z)*(s.z-i.z)),c=Math.pow(s.x-i.x,2)+Math.pow(s.y-i.y,2)+Math.pow(s.z-i.z,2)-Math.pow(a,2),u=Math.pow(h,2)-4*l*c,d=vt,p=mt;if(!(u<0))if(0===u)s.lerp(r,u,d),d.vsub(i,p),p.normalize(),this.reportIntersection(p,d,o,n,-1);else{var f=(-h-Math.sqrt(u))/(2*l),v=(-h+Math.sqrt(u))/(2*l);if(f>=0&&f<=1&&(s.lerp(r,f,d),d.vsub(i,p),p.normalize(),this.reportIntersection(p,d,o,n,-1)),this.result.shouldStop)return;v>=0&&v<=1&&(s.lerp(r,v,d),d.vsub(i,p),p.normalize(),this.reportIntersection(p,d,o,n,-1))}},e._intersectConvex=function(t,e,i,n,o,s){for(var r=yt,a=gt,l=s&&s.faceList||null,h=t.faces,c=t.vertices,u=t.faceNormals,d=this.direction,p=this.from,f=this.to,v=p.distanceTo(f),m=l?l.length:h.length,y=this.result,g=0;!y.shouldStop&&g<m;g++){var w=l?l[g]:g,b=h[w],x=u[w],E=e,A=i;a.copy(c[b[0]]),E.vmult(a,a),a.vadd(A,a),a.vsub(p,a),E.vmult(x,r);var S=d.dot(r);if(!(Math.abs(S)<this.precision)){var C=r.dot(a)/S;if(!(C<0)){d.scale(C,at),at.vadd(p,at),lt.copy(c[b[0]]),E.vmult(lt,lt),A.vadd(lt,lt);for(var T=1;!y.shouldStop&&T<b.length-1;T++){ht.copy(c[b[T]]),ct.copy(c[b[T+1]]),E.vmult(ht,ht),E.vmult(ct,ct),A.vadd(ht,ht),A.vadd(ct,ct);var B=at.distanceTo(p);!ot(at,lt,ht,ct)&&!ot(at,ht,lt,ct)||B>v||this.reportIntersection(r,at,o,n,w)}}}}},e._intersectTrimesh=function(t,e,i,n,o,s){var r=wt,a=Ct,l=Tt,h=gt,c=bt,u=xt,d=Et,p=St,f=At,v=(s&&s.faceList,t.indices),m=(t.vertices,this.from),y=this.to,g=this.direction;l.position.copy(i),l.quaternion.copy(e),x.vectorToLocalFrame(i,e,g,c),x.pointToLocalFrame(i,e,m,u),x.pointToLocalFrame(i,e,y,d),d.x*=t.scale.x,d.y*=t.scale.y,d.z*=t.scale.z,u.x*=t.scale.x,u.y*=t.scale.y,u.z*=t.scale.z,d.vsub(u,c),c.normalize();var w=u.distanceSquared(d);t.tree.rayQuery(this,l,a);for(var b=0,E=a.length;!this.result.shouldStop&&b!==E;b++){var A=a[b];t.getNormal(A,r),t.getVertex(v[3*A],lt),lt.vsub(u,h);var S=c.dot(r),C=r.dot(h)/S;if(!(C<0)){c.scale(C,at),at.vadd(u,at),t.getVertex(v[3*A+1],ht),t.getVertex(v[3*A+2],ct);var T=at.distanceSquared(u);!ot(at,ht,lt,ct)&&!ot(at,lt,ht,ct)||T>w||(x.vectorToWorldFrame(e,r,f),x.pointToWorldFrame(i,e,at,p),this.reportIntersection(f,p,o,n,A))}}a.length=0},e.reportIntersection=function(e,i,n,o,s){var r=this.from,a=this.to,l=r.distanceTo(i),h=this.result;if(!(this.skipBackfaces&&e.dot(this.direction)>0))switch(h.hitFaceIndex=void 0!==s?s:-1,this.mode){case t.ALL:this.hasHit=!0,h.set(r,a,e,i,n,o,l),h.hasHit=!0,this.callback(h);break;case t.CLOSEST:(l<h.distance||!h.hasHit)&&(this.hasHit=!0,h.hasHit=!0,h.set(r,a,e,i,n,o,l));break;case t.ANY:this.hasHit=!0,h.hasHit=!0,h.set(r,a,e,i,n,o,l),h.shouldStop=!0}},t}();$.CLOSEST=1,$.ANY=2,$.ALL=4;var tt=new h,et=[],it=new s,nt=new s;function ot(t,e,i,n){n.vsub(e,Bt),i.vsub(e,it),t.vsub(e,nt);var o,s,r=Bt.dot(Bt),a=Bt.dot(it),l=Bt.dot(nt),h=it.dot(it),c=it.dot(nt);return(o=h*l-a*c)>=0&&(s=r*c-a*l)>=0&&o+s<r*h-a*a}$.pointInTriangle=ot;var st=new s,rt=new m,at=(new s,new s,new s),lt=new s,ht=new s,ct=new s;new s,new J,$.prototype[b.types.BOX]=$.prototype._intersectBox,$.prototype[b.types.PLANE]=$.prototype._intersectPlane;var ut={faceList:[0]},dt=new s,pt=new $,ft=[];$.prototype[b.types.HEIGHTFIELD]=$.prototype._intersectHeightfield;var vt=new s,mt=new s;$.prototype[b.types.SPHERE]=$.prototype._intersectSphere;var yt=new s,gt=(new s,new s,new s);$.prototype[b.types.CONVEXPOLYHEDRON]=$.prototype._intersectConvex;var wt=new s,bt=new s,xt=new s,Et=new s,At=new s,St=new s,Ct=(new h,[]),Tt=new x;$.prototype[b.types.TRIMESH]=$.prototype._intersectTrimesh;var Bt=new s,Mt=new s,zt=function(t){function e(e){var i;(i=t.call(this)||this).axisList=[],i.world=null,i.axisIndex=0;var n=i.axisList;return i._addBodyHandler=function(t){n.push(t.body)},i._removeBodyHandler=function(t){var e=n.indexOf(t.body);-1!==e&&n.splice(e,1)},e&&i.setWorld(e),i}p(e,t);var i=e.prototype;return i.setWorld=function(t){this.axisList.length=0;for(var e=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},i.collisionPairs=function(t,i,n){var o,s,r=this.axisList,a=r.length,l=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),o=0;o!==a;o++){var h=r[o];for(s=o+1;s<a;s++){var c=r[s];if(this.needBroadphaseCollision(h,c)){if(!e.checkBounds(h,c,l))break;this.intersectionTest(h,c,i,n)}}}},i.sortList=function(){for(var t=this.axisList,i=this.axisIndex,n=t.length,o=0;o!==n;o++){var s=t[o];s.aabbNeedsUpdate&&s.computeAABB()}0===i?e.insertionSortX(t):1===i?e.insertionSortY(t):2===i&&e.insertionSortZ(t)},i.autoDetectAxis=function(){for(var t=0,e=0,i=0,n=0,o=0,s=0,r=this.axisList,a=r.length,l=1/a,h=0;h!==a;h++){var c=r[h],u=c.position.x;t+=u,e+=u*u;var d=c.position.y;i+=d,n+=d*d;var p=c.position.z;o+=p,s+=p*p}var f=e-t*t*l,v=n-i*i*l,m=s-o*o*l;this.axisIndex=f>v?f>m?0:2:v>m?1:2},i.aabbQuery=function(t,e,i){void 0===i&&(i=[]),this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,o="x";1===n&&(o="y"),2===n&&(o="z");for(var s=this.axisList,r=(e.lowerBound[o],e.upperBound[o],0);r<s.length;r++){var a=s[r];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(e)&&i.push(a)}return i},e}(j);function Rt(){}zt.insertionSortX=function(t){for(var e=1,i=t.length;e<i;e++){var n=t[e],o=void 0;for(o=e-1;o>=0&&!(t[o].aabb.lowerBound.x<=n.aabb.lowerBound.x);o--)t[o+1]=t[o];t[o+1]=n}return t},zt.insertionSortY=function(t){for(var e=1,i=t.length;e<i;e++){var n=t[e],o=void 0;for(o=e-1;o>=0&&!(t[o].aabb.lowerBound.y<=n.aabb.lowerBound.y);o--)t[o+1]=t[o];t[o+1]=n}return t},zt.insertionSortZ=function(t){for(var e=1,i=t.length;e<i;e++){var n=t[e],o=void 0;for(o=e-1;o>=0&&!(t[o].aabb.lowerBound.z<=n.aabb.lowerBound.z);o--)t[o+1]=t[o];t[o+1]=n}return t},zt.checkBounds=function(t,e,i){var n,o;0===i?(n=t.position.x,o=e.position.x):1===i?(n=t.position.y,o=e.position.y):2===i&&(n=t.position.z,o=e.position.z);var s=t.boundingRadius;return o-e.boundingRadius<n+s},Rt.defaults=function(t,e){for(var i in void 0===t&&(t={}),e)i in t||(t[i]=e[i]);return t};var Pt=function(){function t(e,i,n){void 0===n&&(n={}),n=Rt.defaults(n,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=i,this.id=t.idCounter++,this.collideConnected=n.collideConnected,n.wakeUpBodies&&(e&&e.wakeUp(),i&&i.wakeUp())}var e=t.prototype;return e.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},e.enable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!0},e.disable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!1},t}();Pt.idCounter=0;var It=function(){function t(){this.spatial=new s,this.rotational=new s}var e=t.prototype;return e.multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)},e.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)},t}(),Ft=function(){function t(e,i,n,o){void 0===n&&(n=-1e6),void 0===o&&(o=1e6),this.id=t.id++,this.minForce=n,this.maxForce=o,this.bi=e,this.bj=i,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new It,this.jacobianElementB=new It,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}var e=t.prototype;return e.setSpookParams=function(t,e,i){var n=e,o=t,s=i;this.a=4/(s*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(s*s*o*(1+4*n))},e.computeB=function(t,e,i){var n=this.computeGW();return-this.computeGq()*t-n*e-this.computeGiMf()*i},e.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,o=i.position,s=n.position;return t.spatial.dot(o)+e.spatial.dot(s)},e.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,o=i.velocity,s=n.velocity,r=i.angularVelocity,a=n.angularVelocity;return t.multiplyVectors(o,r)+e.multiplyVectors(s,a)},e.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,o=i.vlambda,s=n.vlambda,r=i.wlambda,a=n.wlambda;return t.multiplyVectors(o,r)+e.multiplyVectors(s,a)},e.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,o=i.force,s=i.torque,r=n.force,a=n.torque,l=i.invMassSolve,h=n.invMassSolve;return o.scale(l,Lt),r.scale(h,Nt),i.invInertiaWorldSolve.vmult(s,Dt),n.invInertiaWorldSolve.vmult(a,Vt),t.multiplyVectors(Lt,Dt)+e.multiplyVectors(Nt,Vt)},e.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,o=i.invMassSolve,s=n.invMassSolve,r=i.invInertiaWorldSolve,a=n.invInertiaWorldSolve,l=o+s;return r.vmult(t.rotational,Ot),l+=Ot.dot(t.rotational),a.vmult(e.rotational,Ot),l+Ot.dot(e.rotational)},e.addToWlambda=function(t){var e=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,o=this.bj,s=Ht;n.vlambda.addScaledVector(n.invMassSolve*t,e.spatial,n.vlambda),o.vlambda.addScaledVector(o.invMassSolve*t,i.spatial,o.vlambda),n.invInertiaWorldSolve.vmult(e.rotational,s),n.wlambda.addScaledVector(t,s,n.wlambda),o.invInertiaWorldSolve.vmult(i.rotational,s),o.wlambda.addScaledVector(t,s,o.wlambda)},e.computeC=function(){return this.computeGiMGt()+this.eps},t}();Ft.id=0;var Lt=new s,Nt=new s,Dt=new s,Vt=new s,Ot=new s,Ht=new s,qt=function(t){function e(e,i,n){var o;return void 0===n&&(n=1e6),(o=t.call(this,e,i,0,n)||this).restitution=0,o.ri=new s,o.rj=new s,o.ni=new s,o}p(e,t);var i=e.prototype;return i.computeB=function(t){var e=this.a,i=this.b,n=this.bi,o=this.bj,s=this.ri,r=this.rj,a=_t,l=Wt,h=n.velocity,c=n.angularVelocity,u=(n.force,n.torque,o.velocity),d=o.angularVelocity,p=(o.force,o.torque,kt),f=this.jacobianElementA,v=this.jacobianElementB,m=this.ni;s.cross(m,a),r.cross(m,l),m.negate(f.spatial),a.negate(f.rotational),v.spatial.copy(m),v.rotational.copy(l),p.copy(o.position),p.vadd(r,p),p.vsub(n.position,p),p.vsub(s,p);var y=m.dot(p),g=this.restitution+1;return-y*e-(g*u.dot(m)-g*h.dot(m)+d.dot(l)-c.dot(a))*i-t*this.computeGiMf()},i.getImpactVelocityAlongNormal=function(){var t=jt,e=Ut,i=Gt,n=Yt,o=Xt;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,t),this.bj.getVelocityAtWorldPoint(n,e),t.vsub(e,o),this.ni.dot(o)},e}(Ft),_t=new s,Wt=new s,kt=new s,jt=new s,Ut=new s,Gt=new s,Yt=new s,Xt=new s,Qt=function(t){function e(e,i,n,o,r){var a;void 0===i&&(i=new s),void 0===o&&(o=new s),void 0===r&&(r=1e6),(a=t.call(this,e,n)||this).pivotA=i.clone(),a.pivotB=o.clone();var l=a.equationX=new qt(e,n),h=a.equationY=new qt(e,n),c=a.equationZ=new qt(e,n);return a.equations.push(l,h,c),l.minForce=h.minForce=c.minForce=-r,l.maxForce=h.maxForce=c.maxForce=r,l.ni.set(1,0,0),h.ni.set(0,1,0),c.ni.set(0,0,1),a}return p(e,t),e.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.equationX,n=this.equationY,o=this.equationZ;t.quaternion.vmult(this.pivotA,i.ri),e.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),o.ri.copy(i.ri),o.rj.copy(i.rj)},e}(Pt),Zt=function(t){function e(e,i,n){var o;void 0===n&&(n={});var r=void 0!==n.maxForce?n.maxForce:1e6;return(o=t.call(this,e,i,-r,r)||this).axisA=n.axisA?n.axisA.clone():new s(1,0,0),o.axisB=n.axisB?n.axisB.clone():new s(0,1,0),o.angle=void 0!==n.angle?n.angle:0,o}return p(e,t),e.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.axisA,o=this.axisB,s=Kt,r=Jt,a=this.jacobianElementA,l=this.jacobianElementB;return n.cross(o,s),o.cross(n,r),a.rotational.copy(r),l.rotational.copy(s),-(Math.cos(this.angle)-n.dot(o))*e-this.computeGW()*i-t*this.computeGiMf()},e}(Ft),Kt=new s,Jt=new s,$t=function(t){function e(e,i,n){var o;void 0===n&&(n={});var r=void 0!==n.maxForce?n.maxForce:1e6;return(o=t.call(this,e,i,-r,r)||this).axisA=n.axisA?n.axisA.clone():new s(1,0,0),o.axisB=n.axisB?n.axisB.clone():new s(0,1,0),o.maxAngle=Math.PI/2,o}return p(e,t),e.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.axisA,o=this.axisB,s=te,r=ee,a=this.jacobianElementA,l=this.jacobianElementB;return n.cross(o,s),o.cross(n,r),a.rotational.copy(r),l.rotational.copy(s),-(Math.cos(this.maxAngle)-n.dot(o))*e-this.computeGW()*i-t*this.computeGiMf()},e}(Ft),te=new s,ee=new s,ie=function(t){function e(e,i,n){var o;void 0===n&&(n={});var r=void 0!==n.maxForce?n.maxForce:1e6,a=n.pivotA?n.pivotA.clone():new s,l=n.pivotB?n.pivotB.clone():new s;(o=t.call(this,e,a,i,l,r)||this).axisA=n.axisA?n.axisA.clone():new s,o.axisB=n.axisB?n.axisB.clone():new s,o.collideConnected=!!n.collideConnected,o.angle=void 0!==n.angle?n.angle:0;var h=o.coneEquation=new Zt(e,i,n),c=o.twistEquation=new $t(e,i,n);return o.twistAngle=void 0!==n.twistAngle?n.twistAngle:0,h.maxForce=0,h.minForce=-r,c.maxForce=0,c.minForce=-r,o.equations.push(h,c),o}return p(e,t),e.prototype.update=function(){var e=this.bodyA,i=this.bodyB,n=this.coneEquation,o=this.twistEquation;t.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,n.axisA),i.vectorToWorldFrame(this.axisB,n.axisB),this.axisA.tangents(o.axisA,o.axisA),e.vectorToWorldFrame(o.axisA,o.axisA),this.axisB.tangents(o.axisB,o.axisB),i.vectorToWorldFrame(o.axisB,o.axisB),n.angle=this.angle,o.maxAngle=this.twistAngle},e}(Qt),ne=(new s,new s,function(t){function e(e,i,n,o){var s;void 0===o&&(o=1e6),s=t.call(this,e,i)||this,void 0===n&&(n=e.position.distanceTo(i.position)),s.distance=n;var r=s.distanceEquation=new qt(e,i);return s.equations.push(r),r.minForce=-o,r.maxForce=o,s}return p(e,t),e.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.distanceEquation,n=.5*this.distance,o=i.ni;e.position.vsub(t.position,o),o.normalize(),o.scale(n,i.ri),o.scale(-n,i.rj)},e}(Pt)),oe=function(t){function e(e,i,n){var o;void 0===n&&(n={});var r=void 0!==n.maxForce?n.maxForce:1e6,a=new s,l=new s,h=new s;e.position.vadd(i.position,h),h.scale(.5,h),i.pointToLocalFrame(h,l),e.pointToLocalFrame(h,a),(o=t.call(this,e,a,i,l,r)||this).xA=e.vectorToLocalFrame(s.UNIT_X),o.xB=i.vectorToLocalFrame(s.UNIT_X),o.yA=e.vectorToLocalFrame(s.UNIT_Y),o.yB=i.vectorToLocalFrame(s.UNIT_Y),o.zA=e.vectorToLocalFrame(s.UNIT_Z),o.zB=i.vectorToLocalFrame(s.UNIT_Z);var c=o.rotationalEquation1=new $t(e,i,n),u=o.rotationalEquation2=new $t(e,i,n),d=o.rotationalEquation3=new $t(e,i,n);return o.equations.push(c,u,d),o}return p(e,t),e.prototype.update=function(){var e=this.bodyA,i=this.bodyB,n=(this.motorEquation,this.rotationalEquation1),o=this.rotationalEquation2,s=this.rotationalEquation3;t.prototype.update.call(this),e.vectorToWorldFrame(this.xA,n.axisA),i.vectorToWorldFrame(this.yB,n.axisB),e.vectorToWorldFrame(this.yA,o.axisA),i.vectorToWorldFrame(this.zB,o.axisB),e.vectorToWorldFrame(this.zA,s.axisA),i.vectorToWorldFrame(this.xB,s.axisB)},e}(Qt),se=(new s,new s,function(t){function e(e,i,n){var o;return void 0===n&&(n=1e6),(o=t.call(this,e,i,-n,n)||this).axisA=new s,o.axisB=new s,o.targetVelocity=0,o}return p(e,t),e.prototype.computeB=function(t){this.a;var e=this.b,i=(this.bi,this.bj,this.axisA),n=this.axisB,o=this.jacobianElementA,s=this.jacobianElementB;return o.rotational.copy(i),n.negate(s.rotational),-(this.computeGW()-this.targetVelocity)*e-t*this.computeGiMf()},e}(Ft)),re=function(t){function e(e,i,n){var o;void 0===n&&(n={});var r=void 0!==n.maxForce?n.maxForce:1e6,a=n.pivotA?n.pivotA.clone():new s,l=n.pivotB?n.pivotB.clone():new s;((o=t.call(this,e,a,i,l,r)||this).axisA=n.axisA?n.axisA.clone():new s(1,0,0)).normalize(),(o.axisB=n.axisB?n.axisB.clone():new s(1,0,0)).normalize(),o.collideConnected=!!n.collideConnected;var h=o.rotationalEquation1=new $t(e,i,n),c=o.rotationalEquation2=new $t(e,i,n),u=o.motorEquation=new se(e,i,r);return u.enabled=!1,o.equations.push(h,c,u),o}p(e,t);var i=e.prototype;return i.enableMotor=function(){this.motorEquation.enabled=!0},i.disableMotor=function(){this.motorEquation.enabled=!1},i.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},i.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t},i.update=function(){var e=this.bodyA,i=this.bodyB,n=this.motorEquation,o=this.rotationalEquation1,s=this.rotationalEquation2,r=ae,a=le,l=this.axisA,h=this.axisB;t.prototype.update.call(this),e.quaternion.vmult(l,r),i.quaternion.vmult(h,a),r.tangents(o.axisA,s.axisA),o.axisB.copy(a),s.axisB.copy(a),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,n.axisA),i.quaternion.vmult(this.axisB,n.axisB))},e}(Qt),ae=new s,le=new s,he=function(t){function e(e,i,n){var o;return(o=t.call(this,e,i,-n,n)||this).ri=new s,o.rj=new s,o.t=new s,o}return p(e,t),e.prototype.computeB=function(t){this.a;var e=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,o=ce,s=ue,r=this.t;i.cross(r,o),n.cross(r,s);var a=this.jacobianElementA,l=this.jacobianElementB;return r.negate(a.spatial),o.negate(a.rotational),l.spatial.copy(r),l.rotational.copy(s),-this.computeGW()*e-t*this.computeGiMf()},e}(Ft),ce=new s,ue=new s,de=function t(e,i,n){n=Rt.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=t.idCounter++,this.materials=[e,i],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation};de.idCounter=0;var pe=function t(e){void 0===e&&(e={});var i="";"string"==typeof e&&(i=e,e={}),this.name=i,this.id=t.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1};pe.idCounter=0;var fe=function(){function t(t,e,i){void 0===i&&(i={}),this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new s,this.localAnchorB=new s,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}var e=t.prototype;return e.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},e.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},e.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},e.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)},e.applyForce=function(){var t=this.stiffness,e=this.damping,i=this.restLength,n=this.bodyA,o=this.bodyB,s=ve,r=me,a=ye,l=ge,h=Ce,c=we,u=be,d=xe,p=Ee,f=Ae,v=Se;this.getWorldAnchorA(c),this.getWorldAnchorB(u),c.vsub(n.position,d),u.vsub(o.position,p),u.vsub(c,s);var m=s.length();r.copy(s),r.normalize(),o.velocity.vsub(n.velocity,a),o.angularVelocity.cross(p,h),a.vadd(h,a),n.angularVelocity.cross(d,h),a.vsub(h,a),r.scale(-t*(m-i)-e*a.dot(r),l),n.force.vsub(l,n.force),o.force.vadd(l,o.force),d.cross(l,f),p.cross(l,v),n.torque.vsub(f,n.torque),o.torque.vadd(v,o.torque)},t}(),ve=new s,me=new s,ye=new s,ge=new s,we=new s,be=new s,xe=new s,Ee=new s,Ae=new s,Se=new s,Ce=new s,Te=function(){function t(t){void 0===t&&(t={}),t=Rt.defaults(t,{chassisConnectionPointLocal:new s,chassisConnectionPointWorld:new s,directionLocal:new s,directionWorld:new s,axleLocal:new s,axleWorld:new s,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,slipInfo:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.slipInfo=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new J,this.worldTransform=new x,this.isInContact=!1}return t.prototype.updateWheel=function(t){var e=this.raycastResult;if(this.isInContact){var i=e.hitNormalWorld.dot(e.directionWorld);e.hitPointWorld.vsub(t.position,Me),t.getVelocityAtWorldPoint(Me,Be);var n=e.hitNormalWorld.dot(Be);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var o=-1/i;this.suspensionRelativeVelocity=n*o,this.clippedInvContactDotSuspension=o}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.hitNormalWorld),this.clippedInvContactDotSuspension=1},t}(),Be=new s,Me=new s,ze=function(){function t(t){this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:1,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:2,this.constraints=[],this.preStepCallback=function(){},this.currentVehicleSpeedKmHour=0}var e=t.prototype;return e.addWheel=function(t){void 0===t&&(t={});var e=new Te(t),i=this.wheelInfos.length;return this.wheelInfos.push(e),i},e.setSteeringValue=function(t,e){this.wheelInfos[e].steering=t},e.applyEngineForce=function(t,e){this.wheelInfos[e].engineForce=t},e.setBrake=function(t,e){this.wheelInfos[e].brake=t},e.addToWorld=function(t){this.constraints,t.addBody(this.chassisBody);var e=this;this.preStepCallback=function(){e.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t},e.getVehicleAxisWorld=function(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(e,e)},e.updateVehicle=function(t){for(var e=this.wheelInfos,i=e.length,n=this.chassisBody,o=0;o<i;o++)this.updateWheelTransform(o);this.currentVehicleSpeedKmHour=3.6*n.velocity.length();var r=new s;this.getVehicleAxisWorld(this.indexForwardAxis,r),r.dot(n.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var a=0;a<i;a++)this.castRay(e[a]);this.updateSuspension(t);for(var l=new s,h=new s,c=0;c<i;c++){var u=e[c],d=u.suspensionForce;d>u.maxSuspensionForce&&(d=u.maxSuspensionForce),u.raycastResult.hitNormalWorld.scale(d*t,l),u.raycastResult.hitPointWorld.vsub(n.position,h),n.applyImpulse(l,h)}this.updateFriction(t);for(var p=new s,f=new s,v=new s,m=0;m<i;m++){var y=e[m];n.getVelocityAtWorldPoint(y.chassisConnectionPointWorld,v);var g=1;if(1===this.indexUpAxis)g=-1;if(y.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,f);var w=f.dot(y.raycastResult.hitNormalWorld);y.raycastResult.hitNormalWorld.scale(w,p),f.vsub(p,f);var b=f.dot(v);y.deltaRotation=g*b*t/y.radius}!y.sliding&&y.isInContact||0===y.engineForce||!y.useCustomSlidingRotationalSpeed||(y.deltaRotation=(y.engineForce>0?1:-1)*y.customSlidingRotationalSpeed*t),Math.abs(y.brake)>Math.abs(y.engineForce)&&(y.deltaRotation=0),y.rotation+=y.deltaRotation,y.deltaRotation*=.99}},e.updateSuspension=function(t){for(var e=this.chassisBody.mass,i=this.wheelInfos,n=i.length,o=0;o<n;o++){var s=i[o];if(s.isInContact){var r=void 0,a=s.suspensionRestLength-s.suspensionLength;r=s.suspensionStiffness*a*s.clippedInvContactDotSuspension;var l=s.suspensionRelativeVelocity;r-=(l<0?s.dampingCompression:s.dampingRelaxation)*l,s.suspensionForce=r*e,s.suspensionForce<0&&(s.suspensionForce=0)}else s.suspensionForce=0}},e.removeFromWorld=function(t){this.constraints,t.removeBody(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null},e.castRay=function(t){var e=Fe,i=Le;this.updateWheelTransformWorld(t);var n=this.chassisBody,o=-1,r=t.suspensionRestLength+t.radius;t.directionWorld.scale(r,e);var a=t.chassisConnectionPointWorld;a.vadd(e,i);var l=t.raycastResult;l.reset();var h=n.collisionResponse;n.collisionResponse=!1,this.world.rayTest(a,i,l),n.collisionResponse=h;var c=l.body;if(t.raycastResult.groundObject=0,c){o=l.distance,t.raycastResult.hitNormalWorld=l.hitNormalWorld,t.isInContact=!0;var u=l.distance;t.suspensionLength=u-t.radius;var d=t.suspensionRestLength-t.maxSuspensionTravel,p=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<d&&(t.suspensionLength=d),t.suspensionLength>p&&(t.suspensionLength=p,t.raycastResult.reset());var f=t.raycastResult.hitNormalWorld.dot(t.directionWorld),v=new s;n.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,v);var m=t.raycastResult.hitNormalWorld.dot(v);if(f>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{var y=-1/f;t.suspensionRelativeVelocity=m*y,t.clippedInvContactDotSuspension=y}}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return o},e.updateWheelTransformWorld=function(t){t.isInContact=!1;var e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),e.vectorToWorldFrame(t.directionLocal,t.directionWorld),e.vectorToWorldFrame(t.axleLocal,t.axleWorld)},e.updateWheelTransform=function(t){var e=Re,i=Pe,n=Ie,o=this.wheelInfos[t];this.updateWheelTransformWorld(o),o.directionLocal.scale(-1,e),i.copy(o.axleLocal),e.cross(i,n),n.normalize(),i.normalize();var s=o.steering,r=new m;r.setFromAxisAngle(e,s);var a=new m;a.setFromAxisAngle(i,o.rotation);var l=o.worldTransform.quaternion;this.chassisBody.quaternion.mult(r,l),l.mult(a,l),l.normalize();var h=o.worldTransform.position;h.copy(o.directionWorld),h.scale(o.suspensionLength,h),h.vadd(o.chassisConnectionPointWorld,h)},e.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform},e.updateFriction=function(t){for(var e=De,i=this.wheelInfos,n=i.length,o=this.chassisBody,r=Oe,a=Ve,l=0;l<n;l++){var h=i[l];h.raycastResult.body,h.sideImpulse=0,h.forwardImpulse=0,r[l]||(r[l]=new s),a[l]||(a[l]=new s)}for(var c=0;c<n;c++){var u=i[c],d=u.raycastResult.body;if(d){var p=a[c];this.getWheelTransformWorld(c).vectorToWorldFrame(Ne[this.indexRightAxis],p);var f=u.raycastResult.hitNormalWorld,v=p.dot(f);f.scale(v,e),p.vsub(e,p),p.normalize(),f.cross(p,r[c]),r[c].normalize(),u.sideImpulse=Je(o,u.raycastResult.hitPointWorld,d,u.raycastResult.hitPointWorld,p),u.sideImpulse*=He}}this.sliding=!1;for(var m=0;m<n;m++){var y=i[m],g=y.raycastResult.body,w=0;if(y.slipInfo=1,g){var b=y.brake?y.brake:0;w=ke(o,g,y.raycastResult.hitPointWorld,r[m],b);var x=b/(w+=y.engineForce*t);y.slipInfo*=x}if(y.forwardImpulse=0,y.skidInfo=1,g){y.skidInfo=1;var E=y.suspensionForce*t*y.frictionSlip,A=E*E;y.forwardImpulse=w;var S=.5*y.forwardImpulse,C=1*y.sideImpulse,T=S*S+C*C;if(y.sliding=!1,T>A){this.sliding=!0,y.sliding=!0;var B=E/Math.sqrt(T);y.skidInfo*=B}}}if(this.sliding)for(var M=0;M<n;M++){var z=i[M];0!==z.sideImpulse&&z.skidInfo<1&&(z.forwardImpulse*=z.skidInfo,z.sideImpulse*=z.skidInfo)}for(var R=0;R<n;R++){var P=i[R],I=new s;if(P.raycastResult.hitPointWorld.vsub(o.position,I),0!==P.forwardImpulse){var F=new s;r[R].scale(P.forwardImpulse,F),o.applyImpulse(F,I)}if(0!==P.sideImpulse){var L=P.raycastResult.body,N=new s;P.raycastResult.hitPointWorld.vsub(L.position,N);var D=new s;a[R].scale(P.sideImpulse,D),o.vectorToLocalFrame(I,I),I["xyz"[this.indexUpAxis]]*=P.rollInfluence,o.vectorToWorldFrame(I,I),o.applyImpulse(D,I),D.scale(-1,D),L.applyImpulse(D,N)}}},t}(),Re=(new s,new s,new s,new s),Pe=new s,Ie=new s,Fe=(new $,new s,new s),Le=new s,Ne=[new s(1,0,0),new s(0,1,0),new s(0,0,1)],De=new s,Ve=[],Oe=[],He=1,qe=new s,_e=new s,We=new s;function ke(t,e,i,n,o){var s=0,r=i,a=qe,l=_e,h=We;return t.getVelocityAtWorldPoint(r,a),e.getVelocityAtWorldPoint(r,l),a.vsub(l,h),o<(s=-n.dot(h)*(1/(Xe(t,i,n)+Xe(e,i,n))))&&(s=o),s<-o&&(s=-o),s}var je=new s,Ue=new s,Ge=new s,Ye=new s;function Xe(t,e,i){var n=je,o=Ue,s=Ge,r=Ye;return e.vsub(t.position,n),n.cross(i,o),t.invInertiaWorld.vmult(o,r),r.cross(n,s),t.invMass+i.dot(s)}var Qe=new s,Ze=new s,Ke=new s;function Je(t,e,i,n,o){if(o.lengthSquared()>1.1)return 0;var s=Qe,r=Ze,a=Ke;return t.getVelocityAtWorldPoint(e,s),i.getVelocityAtWorldPoint(n,r),s.vsub(r,a),-.2*o.dot(a)*(1/(t.invMass+i.invMass))}var $e=function(t){function e(e){var i;if((i=t.call(this,{type:b.types.SPHERE})||this).radius=void 0!==e?e:1,i.radius<0)throw new Error("The sphere radius cannot be negative.");return i.updateBoundingSphereRadius(),i}p(e,t);var i=e.prototype;return i.calculateLocalInertia=function(t,e){void 0===e&&(e=new s);var i=2*t*this.radius*this.radius/5;return e.x=i,e.y=i,e.z=i,e},i.volume=function(){return 4*Math.PI*Math.pow(this.radius,3)/3},i.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},i.calculateWorldAABB=function(t,e,i,n){for(var o=this.radius,s=["x","y","z"],r=0;r<s.length;r++){var a=s[r];i[a]=t[a]-o,n[a]=t[a]+o}},e}(b),ti=function(){function t(t){void 0===t&&(t={}),this.wheelBodies=[],this.coordinateSystem=void 0!==t.coordinateSystem?t.coordinateSystem.clone():new s(1,2,3),t.chassisBody?this.chassisBody=t.chassisBody:this.chassisBody=new R({mass:1,shape:new T(new s(5,2,.5))}),this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var e=t.prototype;return e.addWheel=function(t){var e;void 0===t&&(t={}),e=t.body?t.body:new R({mass:1,shape:new $e(1.2)}),this.wheelBodies.push(e),this.wheelForces.push(0),new s;var i=void 0!==t.position?t.position.clone():new s,n=new s;this.chassisBody.pointToWorldFrame(i,n),e.position.set(n.x,n.y,n.z);var o=void 0!==t.axis?t.axis.clone():new s(0,1,0);this.wheelAxes.push(o);var r=new re(this.chassisBody,e,{pivotA:i,axisA:o,pivotB:s.ZERO,axisB:o,collideConnected:!1});return this.constraints.push(r),this.wheelBodies.length-1},e.setSteeringValue=function(t,e){var i=this.wheelAxes[e],n=Math.cos(t),o=Math.sin(t),s=i.x,r=i.y;this.constraints[e].axisA.set(n*s-o*r,o*s+n*r,0)},e.setMotorSpeed=function(t,e){var i=this.constraints[e];i.enableMotor(),i.motorTargetVelocity=t},e.disableMotor=function(t){this.constraints[t].disableMotor()},e.setWheelForce=function(t,e){this.wheelForces[e]=t},e.applyWheelForce=function(t,e){var i=this.wheelAxes[e],n=this.wheelBodies[e],o=n.torque;i.scale(t,ei),n.vectorToWorldFrame(ei,ei),o.vadd(ei,o)},e.addToWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)t.addBody(i[n]);for(var o=0;o<e.length;o++)t.addConstraint(e[o]);t.addEventListener("preStep",this._update.bind(this))},e._update=function(){for(var t=this.wheelForces,e=0;e<t.length;e++)this.applyWheelForce(t[e],e)},e.removeFromWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)t.removeBody(i[n]);for(var o=0;o<e.length;o++)t.removeConstraint(e[o])},e.getWheelSpeed=function(t){var e=this.wheelAxes[t],i=this.wheelBodies[t].angularVelocity;return this.chassisBody.vectorToWorldFrame(e,ii),i.dot(ii)},t}(),ei=new s,ii=new s,ni=function(){function t(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}var e=t.prototype;return e.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},e.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())},e.getNeighbors=function(t,e){for(var i=this.particles.length,n=t.id,o=this.smoothingRadius*this.smoothingRadius,s=oi,r=0;r!==i;r++){var a=this.particles[r];a.position.vsub(t.position,s),n!==a.id&&s.lengthSquared()<o&&e.push(a)}},e.update=function(){for(var t=this.particles.length,e=si,i=this.speedOfSound,n=this.eps,o=0;o!==t;o++){var s=this.particles[o],r=this.neighbors[o];r.length=0,this.getNeighbors(s,r),r.push(this.particles[o]);for(var a=r.length,l=0,h=0;h!==a;h++){s.position.vsub(r[h].position,e);var c=e.length(),u=this.w(c);l+=r[h].mass*u}this.densities[o]=l,this.pressures[o]=i*i*(this.densities[o]-this.density)}for(var d=ri,p=ai,f=li,v=hi,m=ci,y=0;y!==t;y++){var g=this.particles[y];d.set(0,0,0),p.set(0,0,0);for(var w=void 0,b=void 0,x=this.neighbors[y],E=x.length,A=0;A!==E;A++){var S=x[A];g.position.vsub(S.position,v);var C=v.length();w=-S.mass*(this.pressures[y]/(this.densities[y]*this.densities[y]+n)+this.pressures[A]/(this.densities[A]*this.densities[A]+n)),this.gradw(v,f),f.scale(w,f),d.vadd(f,d),S.velocity.vsub(g.velocity,m),m.scale(1/(1e-4+this.densities[y]*this.densities[A])*this.viscosity*S.mass,m),b=this.nablaw(C),m.scale(b,m),p.vadd(m,p)}p.scale(g.mass,p),d.scale(g.mass,d),g.force.vadd(p,g.force),g.force.vadd(d,g.force)}},e.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},e.gradw=function(t,e){var i=t.length(),n=this.smoothingRadius;t.scale(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),e)},e.nablaw=function(t){var e=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)},t}(),oi=new s,si=new s,ri=new s,ai=new s,li=new s,hi=new s,ci=new s,ui=function(t){function e(e,i,n,o){var r=o,a=[],l=[],h=[],c=[],u=[],d=Math.cos,p=Math.sin;a.push(new s(i*d(0),i*p(0),.5*-n)),c.push(0),a.push(new s(e*d(0),e*p(0),.5*n)),u.push(1);for(var f=0;f<r;f++){var v=2*Math.PI/r*(f+1),m=2*Math.PI/r*(f+.5);f<r-1?(a.push(new s(i*d(v),i*p(v),.5*-n)),c.push(2*f+2),a.push(new s(e*d(v),e*p(v),.5*n)),u.push(2*f+3),h.push([2*f+2,2*f+3,2*f+1,2*f])):h.push([0,1,2*f+1,2*f]),(r%2==1||f<r/2)&&l.push(new s(d(m),p(m),0))}h.push(u),l.push(new s(0,0,1));for(var y=[],g=0;g<c.length;g++)y.push(c[c.length-g-1]);return h.push(y),t.call(this,{vertices:a,faces:h,axes:l})||this}return p(e,t),e}(A),di=function(t){function e(){return t.call(this,{type:b.types.PARTICLE})||this}p(e,t);var i=e.prototype;return i.calculateLocalInertia=function(t,e){return void 0===e&&(e=new s),e.set(0,0,0),e},i.volume=function(){return 0},i.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},i.calculateWorldAABB=function(t,e,i,n){i.copy(t),n.copy(t)},e}(b),pi=function(t){function e(){var e;return(e=t.call(this,{type:b.types.PLANE})||this).worldNormal=new s,e.worldNormalNeedsUpdate=!0,e.boundingSphereRadius=Number.MAX_VALUE,e}p(e,t);var i=e.prototype;return i.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},i.calculateLocalInertia=function(t,e){return void 0===e&&(e=new s),e},i.volume=function(){return Number.MAX_VALUE},i.calculateWorldAABB=function(t,e,i,n){fi.set(0,0,1),e.vmult(fi,fi);var o=Number.MAX_VALUE;i.set(-o,-o,-o),n.set(o,o,o),1===fi.x?n.x=t.x:-1===fi.x&&(i.x=t.x),1===fi.y?n.y=t.y:-1===fi.y&&(i.y=t.y),1===fi.z?n.z=t.z:-1===fi.z&&(i.z=t.z)},i.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE},e}(b),fi=new s,vi=function(t){function e(e,i){var n;return void 0===i&&(i={}),i=Rt.defaults(i,{maxValue:null,minValue:null,elementSize:1}),(n=t.call(this,{type:b.types.HEIGHTFIELD})||this).data=e,n.maxValue=i.maxValue,n.minValue=i.minValue,n.elementSize=i.elementSize,null===i.minValue&&n.updateMinValue(),null===i.maxValue&&n.updateMaxValue(),n.cacheEnabled=!0,n.pillarConvex=new A,n.pillarOffset=new s,n.updateBoundingSphereRadius(),n._cachedPillars={},n}p(e,t);var i=e.prototype;return i.update=function(){this._cachedPillars={}},i.updateMinValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var n=0;n!==t[i].length;n++){var o=t[i][n];o<e&&(e=o)}this.minValue=e},i.updateMaxValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var n=0;n!==t[i].length;n++){var o=t[i][n];o>e&&(e=o)}this.maxValue=e},i.setHeightValueAtIndex=function(t,e,i){this.data[t][e]=i,this.clearCachedConvexTrianglePillar(t,e,!1),t>0&&(this.clearCachedConvexTrianglePillar(t-1,e,!0),this.clearCachedConvexTrianglePillar(t-1,e,!1)),e>0&&(this.clearCachedConvexTrianglePillar(t,e-1,!0),this.clearCachedConvexTrianglePillar(t,e-1,!1)),e>0&&t>0&&this.clearCachedConvexTrianglePillar(t-1,e-1,!0)},i.getRectMinMax=function(t,e,i,n,o){void 0===o&&(o=[]);for(var s=this.data,r=this.minValue,a=t;a<=i;a++)for(var l=e;l<=n;l++){var h=s[a][l];h>r&&(r=h)}o[0]=this.minValue,o[1]=r},i.getIndexOfPosition=function(t,e,i,n){var o=this.elementSize,s=this.data,r=Math.floor(t/o),a=Math.floor(e/o);return i[0]=r,i[1]=a,n&&(r<0&&(r=0),a<0&&(a=0),r>=s.length-1&&(r=s.length-1),a>=s[0].length-1&&(a=s[0].length-1)),!(r<0||a<0||r>=s.length-1||a>=s[0].length-1)},i.getTriangleAt=function(t,e,i,n,o,s){var r=mi;this.getIndexOfPosition(t,e,r,i);var a=r[0],l=r[1],h=this.data;i&&(a=Math.min(h.length-2,Math.max(0,a)),l=Math.min(h[0].length-2,Math.max(0,l)));var c=this.elementSize,u=Math.pow(t/c-a,2)+Math.pow(e/c-l,2)>Math.pow(t/c-(a+1),2)+Math.pow(e/c-(l+1),2);return this.getTriangle(a,l,u,n,o,s),u},i.getNormalAt=function(t,e,i,n){var o=xi,s=Ei,r=Ai,a=Si,l=Ci;this.getTriangleAt(t,e,i,o,s,r),s.vsub(o,a),r.vsub(o,l),a.cross(l,n),n.normalize()},i.getAabbAtIndex=function(t,e,i){var n=i.lowerBound,o=i.upperBound,s=this.data,r=this.elementSize;n.set(t*r,e*r,s[t][e]),o.set((t+1)*r,(e+1)*r,s[t+1][e+1])},i.getHeightAt=function(t,e,i){var n=this.data,o=gi,s=wi,r=bi,a=mi;this.getIndexOfPosition(t,e,a,i);var l=a[0],h=a[1];i&&(l=Math.min(n.length-2,Math.max(0,l)),h=Math.min(n[0].length-2,Math.max(0,h)));var c=this.getTriangleAt(t,e,i,o,s,r);!function(t,e,i,n,o,s,r,a,l){l.x=((s-a)*(t-r)+(r-o)*(e-a))/((s-a)*(i-r)+(r-o)*(n-a)),l.y=((a-n)*(t-r)+(i-r)*(e-a))/((s-a)*(i-r)+(r-o)*(n-a)),l.z=1-l.x-l.y}(t,e,o.x,o.y,s.x,s.y,r.x,r.y,yi);var u=yi;return c?n[l+1][h+1]*u.x+n[l][h+1]*u.y+n[l+1][h]*u.z:n[l][h]*u.x+n[l+1][h]*u.y+n[l][h+1]*u.z},i.getCacheConvexTrianglePillarKey=function(t,e,i){return t+"_"+e+"_"+(i?1:0)},i.getCachedConvexTrianglePillar=function(t,e,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},i.setCachedConvexTrianglePillar=function(t,e,i,n,o){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]={convex:n,offset:o}},i.clearCachedConvexTrianglePillar=function(t,e,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},i.getTriangle=function(t,e,i,n,o,s){var r=this.data,a=this.elementSize;i?(n.set((t+1)*a,(e+1)*a,r[t+1][e+1]),o.set(t*a,(e+1)*a,r[t][e+1]),s.set((t+1)*a,e*a,r[t+1][e])):(n.set(t*a,e*a,r[t][e]),o.set((t+1)*a,e*a,r[t+1][e]),s.set(t*a,(e+1)*a,r[t][e+1]))},i.getConvexTrianglePillar=function(t,e,i){var n=this.pillarConvex,o=this.pillarOffset;if(this.cacheEnabled){var r=this.getCachedConvexTrianglePillar(t,e,i);if(r)return this.pillarConvex=r.convex,void(this.pillarOffset=r.offset);n=new A,o=new s,this.pillarConvex=n,this.pillarOffset=o}var a=this.data,l=this.elementSize,h=n.faces;n.vertices.length=6;for(var c=0;c<6;c++)n.vertices[c]||(n.vertices[c]=new s);h.length=5;for(var u=0;u<5;u++)h[u]||(h[u]=[]);var d=n.vertices,p=(Math.min(a[t][e],a[t+1][e],a[t][e+1],a[t+1][e+1])-this.minValue)/2+this.minValue;i?(o.set((t+.75)*l,(e+.75)*l,p),d[0].set(.25*l,.25*l,a[t+1][e+1]-p),d[1].set(-.75*l,.25*l,a[t][e+1]-p),d[2].set(.25*l,-.75*l,a[t+1][e]-p),d[3].set(.25*l,.25*l,-p-1),d[4].set(-.75*l,.25*l,-p-1),d[5].set(.25*l,-.75*l,-p-1),h[0][0]=0,h[0][1]=1,h[0][2]=2,h[1][0]=5,h[1][1]=4,h[1][2]=3,h[2][0]=2,h[2][1]=5,h[2][2]=3,h[2][3]=0,h[3][0]=3,h[3][1]=4,h[3][2]=1,h[3][3]=0,h[4][0]=1,h[4][1]=4,h[4][2]=5,h[4][3]=2):(o.set((t+.25)*l,(e+.25)*l,p),d[0].set(-.25*l,-.25*l,a[t][e]-p),d[1].set(.75*l,-.25*l,a[t+1][e]-p),d[2].set(-.25*l,.75*l,a[t][e+1]-p),d[3].set(-.25*l,-.25*l,-p-1),d[4].set(.75*l,-.25*l,-p-1),d[5].set(-.25*l,.75*l,-p-1),h[0][0]=0,h[0][1]=1,h[0][2]=2,h[1][0]=5,h[1][1]=4,h[1][2]=3,h[2][0]=0,h[2][1]=2,h[2][2]=5,h[2][3]=3,h[3][0]=1,h[3][1]=0,h[3][2]=3,h[3][3]=4,h[4][0]=4,h[4][1]=5,h[4][2]=2,h[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(t,e,i,n,o)},i.calculateLocalInertia=function(t,e){return void 0===e&&(e=new s),e.set(0,0,0),e},i.volume=function(){return Number.MAX_VALUE},i.calculateWorldAABB=function(t,e,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},i.updateBoundingSphereRadius=function(){var t=this.data,e=this.elementSize;this.boundingSphereRadius=new s(t.length*e,t[0].length*e,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).length()},i.setHeightsFromImage=function(t,e){var i=e.x,n=e.z,o=e.y,s=document.createElement("canvas");s.width=t.width,s.height=t.height;var r=s.getContext("2d");r.drawImage(t,0,0);var a=r.getImageData(0,0,t.width,t.height),l=this.data;l.length=0,this.elementSize=Math.abs(i)/a.width;for(var h=0;h<a.height;h++){for(var c=[],u=0;u<a.width;u++){var d=(a.data[4*(h*a.height+u)]+a.data[4*(h*a.height+u)+1]+a.data[4*(h*a.height+u)+2])/4/255*n;i<0?c.push(d):c.unshift(d)}o<0?l.unshift(c):l.push(c)}this.updateMaxValue(),this.updateMinValue(),this.update()},e}(b),mi=[],yi=new s,gi=new s,wi=new s,bi=new s,xi=new s,Ei=new s,Ai=new s,Si=new s,Ci=new s,Ti=function(t){function e(e,i){var n;return void 0===i&&(i={}),(n=t.call(this,{root:null,aabb:e})||this).maxDepth=void 0!==i.maxDepth?i.maxDepth:8,n}return p(e,t),e}(function(){function t(t){void 0===t&&(t={}),this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new h,this.data=[],this.children=[]}var e=t.prototype;return e.reset=function(){this.children.length=this.data.length=0},e.insert=function(t,e,i){void 0===i&&(i=0);var n=this.data;if(!this.aabb.contains(t))return!1;var o=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var s=!1;o.length||(this.subdivide(),s=!0);for(var r=0;8!==r;r++)if(o[r].insert(t,e,i+1))return!0;s&&(o.length=0)}return n.push(e),!0},e.subdivide=function(){var e=this.aabb,i=e.lowerBound,n=e.upperBound,o=this.children;o.push(new t({aabb:new h({lowerBound:new s(0,0,0)})}),new t({aabb:new h({lowerBound:new s(1,0,0)})}),new t({aabb:new h({lowerBound:new s(1,1,0)})}),new t({aabb:new h({lowerBound:new s(1,1,1)})}),new t({aabb:new h({lowerBound:new s(0,1,1)})}),new t({aabb:new h({lowerBound:new s(0,0,1)})}),new t({aabb:new h({lowerBound:new s(1,0,1)})}),new t({aabb:new h({lowerBound:new s(0,1,0)})})),n.vsub(i,Bi),Bi.scale(.5,Bi);for(var r=this.root||this,a=0;8!==a;a++){var l=o[a];l.root=r;var c=l.aabb.lowerBound;c.x*=Bi.x,c.y*=Bi.y,c.z*=Bi.z,c.vadd(i,c),c.vadd(Bi,l.aabb.upperBound)}},e.aabbQuery=function(t,e){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(t)&&Array.prototype.push.apply(e,n.data),Array.prototype.push.apply(i,n.children)}return e},e.rayQuery=function(t,e,i){return t.getAABB(Mi),Mi.toLocalFrame(e,Mi),this.aabbQuery(Mi,i),i},e.removeEmptyNodes=function(){for(var t=this.children.length-1;t>=0;t--)this.children[t].removeEmptyNodes(),this.children[t].children.length||this.children[t].data.length||this.children.splice(t,1)},t}()),Bi=new s,Mi=new h,zi=function(t){function e(e,i){var n;return(n=t.call(this,{type:b.types.TRIMESH})||this).vertices=new Float32Array(e),n.indices=new Int16Array(i),n.normals=new Float32Array(i.length),n.aabb=new h,n.edges=null,n.scale=new s(1,1,1),n.tree=new Ti,n.updateEdges(),n.updateNormals(),n.updateAABB(),n.updateBoundingSphereRadius(),n.updateTree(),n}p(e,t);var i=e.prototype;return i.updateTree=function(){var t=this.tree;t.reset(),t.aabb.copy(this.aabb);var e=this.scale;t.aabb.lowerBound.x*=1/e.x,t.aabb.lowerBound.y*=1/e.y,t.aabb.lowerBound.z*=1/e.z,t.aabb.upperBound.x*=1/e.x,t.aabb.upperBound.y*=1/e.y,t.aabb.upperBound.z*=1/e.z;for(var i=new h,n=new s,o=new s,r=new s,a=[n,o,r],l=0;l<this.indices.length/3;l++){var c=3*l;this._getUnscaledVertex(this.indices[c],n),this._getUnscaledVertex(this.indices[c+1],o),this._getUnscaledVertex(this.indices[c+2],r),i.setFromPoints(a),t.insert(i,l)}t.removeEmptyNodes()},i.getTrianglesInAABB=function(t,e){Pi.copy(t);var i=this.scale,n=i.x,o=i.y,s=i.z,r=Pi.lowerBound,a=Pi.upperBound;return r.x/=n,r.y/=o,r.z/=s,a.x/=n,a.y/=o,a.z/=s,this.tree.aabbQuery(Pi,e)},i.setScale=function(t){var e=this.scale.x===this.scale.y&&this.scale.y===this.scale.z,i=t.x===t.y&&t.y===t.z;e&&i||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()},i.updateNormals=function(){for(var t=Ri,i=this.normals,n=0;n<this.indices.length/3;n++){var o=3*n,s=this.indices[o],r=this.indices[o+1],a=this.indices[o+2];this.getVertex(s,Di),this.getVertex(r,Vi),this.getVertex(a,Oi),e.computeNormal(Vi,Di,Oi,t),i[o]=t.x,i[o+1]=t.y,i[o+2]=t.z}},i.updateEdges=function(){for(var t={},e=function(e,i){t[e<i?e+"_"+i:i+"_"+e]=!0},i=0;i<this.indices.length/3;i++){var n=3*i,o=this.indices[n],s=this.indices[n+1],r=this.indices[n+2];e(o,s),e(s,r),e(r,o)}var a=Object.keys(t);this.edges=new Int16Array(2*a.length);for(var l=0;l<a.length;l++){var h=a[l].split("_");this.edges[2*l]=parseInt(h[0],10),this.edges[2*l+1]=parseInt(h[1],10)}},i.getEdgeVertex=function(t,e,i){var n=this.edges[2*t+(e?1:0)];this.getVertex(n,i)},i.getEdgeVector=function(t,e){var i=Ii,n=Fi;this.getEdgeVertex(t,0,i),this.getEdgeVertex(t,1,n),n.vsub(i,e)},i.getVertex=function(t,e){var i=this.scale;return this._getUnscaledVertex(t,e),e.x*=i.x,e.y*=i.y,e.z*=i.z,e},i._getUnscaledVertex=function(t,e){var i=3*t,n=this.vertices;return e.set(n[i],n[i+1],n[i+2])},i.getWorldVertex=function(t,e,i,n){return this.getVertex(t,n),x.pointToWorldFrame(e,i,n,n),n},i.getTriangleVertices=function(t,e,i,n){var o=3*t;this.getVertex(this.indices[o],e),this.getVertex(this.indices[o+1],i),this.getVertex(this.indices[o+2],n)},i.getNormal=function(t,e){var i=3*t;return e.set(this.normals[i],this.normals[i+1],this.normals[i+2])},i.calculateLocalInertia=function(t,e){this.computeLocalAABB(Hi);var i=Hi.upperBound.x-Hi.lowerBound.x,n=Hi.upperBound.y-Hi.lowerBound.y,o=Hi.upperBound.z-Hi.lowerBound.z;return e.set(1/12*t*(2*n*2*n+2*o*2*o),1/12*t*(2*i*2*i+2*o*2*o),1/12*t*(2*n*2*n+2*i*2*i))},i.computeLocalAABB=function(t){var e=t.lowerBound,i=t.upperBound,n=this.vertices.length,o=(this.vertices,qi);this.getVertex(0,o),e.copy(o),i.copy(o);for(var s=0;s!==n;s++)this.getVertex(s,o),o.x<e.x?e.x=o.x:o.x>i.x&&(i.x=o.x),o.y<e.y?e.y=o.y:o.y>i.y&&(i.y=o.y),o.z<e.z?e.z=o.z:o.z>i.z&&(i.z=o.z)},i.updateAABB=function(){this.computeLocalAABB(this.aabb)},i.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=new s,n=0,o=e.length/3;n!==o;n++){this.getVertex(n,i);var r=i.lengthSquared();r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t)},i.calculateWorldAABB=function(t,e,i,n){var o=_i,s=Wi;o.position=t,o.quaternion=e,this.aabb.toWorldFrame(o,s),i.copy(s.lowerBound),n.copy(s.upperBound)},i.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},e}(b),Ri=new s,Pi=new h,Ii=new s,Fi=new s,Li=new s,Ni=new s;zi.computeNormal=function(t,e,i,n){e.vsub(t,Ni),i.vsub(e,Li),Li.cross(Ni,n),n.isZero()||n.normalize()};var Di=new s,Vi=new s,Oi=new s,Hi=new h,qi=new s,_i=new x,Wi=new h;zi.createTorus=function(t,e,i,n,o){void 0===t&&(t=1),void 0===e&&(e=.5),void 0===i&&(i=8),void 0===n&&(n=6),void 0===o&&(o=2*Math.PI);for(var s=[],r=[],a=0;a<=i;a++)for(var l=0;l<=n;l++){var h=l/n*o,c=a/i*Math.PI*2,u=(t+e*Math.cos(c))*Math.cos(h),d=(t+e*Math.cos(c))*Math.sin(h),p=e*Math.sin(c);s.push(u,d,p)}for(var f=1;f<=i;f++)for(var v=1;v<=n;v++){var m=(n+1)*f+v-1,y=(n+1)*(f-1)+v-1,g=(n+1)*(f-1)+v,w=(n+1)*f+v;r.push(m,y,w),r.push(y,g,w)}return new zi(s,r)};var ki=function(){function t(){this.equations=[]}var e=t.prototype;return e.solve=function(t,e){return 0},e.addEquation=function(t){t.enabled&&this.equations.push(t)},e.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},e.removeAllEquations=function(){this.equations.length=0},t}(),ji=function(t){function e(){var e;return(e=t.call(this)||this).iterations=10,e.tolerance=1e-7,e}return p(e,t),e.prototype.solve=function(t,e){var i,n,o,s,r,a=0,l=this.iterations,h=this.tolerance*this.tolerance,c=this.equations,u=c.length,d=e.bodies,p=d.length,f=t;if(0!==u)for(var v=0;v!==p;v++)d[v].updateSolveMassProperties();var m=Gi,y=Yi,g=Ui;m.length=u,y.length=u,g.length=u;for(var w=0;w!==u;w++){var b=c[w];g[w]=0,y[w]=b.computeB(f),m[w]=1/b.computeC()}if(0!==u){for(var x=0;x!==p;x++){var E=d[x],A=E.vlambda,S=E.wlambda;A.set(0,0,0),S.set(0,0,0)}for(a=0;a!==l;a++){s=0;for(var C=0;C!==u;C++){var T=c[C];i=y[C],n=m[C],(r=g[C])+(o=n*(i-T.computeGWlambda()-T.eps*r))<T.minForce?o=T.minForce-r:r+o>T.maxForce&&(o=T.maxForce-r),g[C]+=o,s+=o>0?o:-o,T.addToWlambda(o)}if(s*s<h)break}for(var B=0;B!==p;B++){var M=d[B],z=M.velocity,R=M.angularVelocity;M.vlambda.vmul(M.linearFactor,M.vlambda),z.vadd(M.vlambda,z),M.wlambda.vmul(M.angularFactor,M.wlambda),R.vadd(M.wlambda,R)}for(var P=c.length,I=1/f;P--;)c[P].multiplier=g[P]*I}return a},e}(ki),Ui=[],Gi=[],Yi=[],Xi=function(t){function e(e){var i;for((i=t.call(this)||this).iterations=10,i.tolerance=1e-7,i.subsolver=e,i.nodes=[],i.nodePool=[];i.nodePool.length<128;)i.nodePool.push(i.createNode());return i}p(e,t);var i=e.prototype;return i.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},i.solve=function(t,e){for(var i,n=Qi,o=this.nodePool,s=e.bodies,r=this.equations,a=r.length,l=s.length,h=this.subsolver;o.length<l;)o.push(this.createNode());n.length=l;for(var c=0;c<l;c++)n[c]=o[c];for(var u=0;u!==l;u++){var d=n[u];d.body=s[u],d.children.length=0,d.eqs.length=0,d.visited=!1}for(var p=0;p!==a;p++){var f=r[p],v=s.indexOf(f.bi),m=s.indexOf(f.bj),y=n[v],g=n[m];y.children.push(g),y.eqs.push(f),g.children.push(y),g.eqs.push(f)}var w=0,b=Zi;h.tolerance=this.tolerance,h.iterations=this.iterations;for(var x=Ki;i=$i(n);){b.length=0,x.bodies.length=0,en(i,nn,x.bodies,b);var E=b.length;b=b.sort(on);for(var A=0;A!==E;A++)h.addEquation(b[A]);h.solve(t,x),h.removeAllEquations(),w++}return w},e}(ki),Qi=[],Zi=[],Ki={bodies:[]},Ji=R.STATIC;function $i(t){for(var e=t.length,i=0;i!==e;i++){var n=t[i];if(!(n.visited||n.body.type&Ji))return n}return!1}var tn=[];function en(t,e,i,n){for(tn.push(t),t.visited=!0,e(t,i,n);tn.length;)for(var o=tn.pop(),s=void 0;s=$i(o.children);)s.visited=!0,e(s,i,n),tn.push(s)}function nn(t,e,i){e.push(t.body);for(var n=t.eqs.length,o=0;o!==n;o++){var s=t.eqs[o];i.includes(s)||i.push(s)}}function on(t,e){return e.id-t.id}var sn=function(){function t(){this.objects=[],this.type=Object}var e=t.prototype;return e.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(e<0||arguments.length<=e?void 0:arguments[e]);return this},e.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},e.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},e.resize=function(t){for(var e=this.objects;e.length>t;)e.pop();for(;e.length<t;)e.push(this.constructObject());return this},t}(),rn=function(t){function e(){var e;return(e=t.call(this)||this).type=s,e}return p(e,t),e.prototype.constructObject=function(){return new s},e}(sn),an={sphereSphere:b.types.SPHERE,spherePlane:b.types.SPHERE|b.types.PLANE,boxBox:b.types.BOX|b.types.BOX,sphereBox:b.types.SPHERE|b.types.BOX,planeBox:b.types.PLANE|b.types.BOX,convexConvex:b.types.CONVEXPOLYHEDRON,sphereConvex:b.types.SPHERE|b.types.CONVEXPOLYHEDRON,planeConvex:b.types.PLANE|b.types.CONVEXPOLYHEDRON,boxConvex:b.types.BOX|b.types.CONVEXPOLYHEDRON,sphereHeightfield:b.types.SPHERE|b.types.HEIGHTFIELD,boxHeightfield:b.types.BOX|b.types.HEIGHTFIELD,convexHeightfield:b.types.CONVEXPOLYHEDRON|b.types.HEIGHTFIELD,sphereParticle:b.types.PARTICLE|b.types.SPHERE,planeParticle:b.types.PLANE|b.types.PARTICLE,boxParticle:b.types.BOX|b.types.PARTICLE,convexParticle:b.types.PARTICLE|b.types.CONVEXPOLYHEDRON,sphereTrimesh:b.types.SPHERE|b.types.TRIMESH,planeTrimesh:b.types.PLANE|b.types.TRIMESH},ln=function(){function t(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new rn,this.world=t,this.currentContactMaterial=t.defaultContactMaterial,this.enableFrictionReduction=!1}var e=t.prototype;return e.createContactEquation=function(t,e,i,n,o,s){var r;this.contactPointPool.length?((r=this.contactPointPool.pop()).bi=t,r.bj=e):r=new qt(t,e),r.enabled=t.collisionResponse&&e.collisionResponse&&i.collisionResponse&&n.collisionResponse;var a=this.currentContactMaterial;r.restitution=a.restitution,r.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt);var l=i.material||t.material,h=n.material||e.material;return l&&h&&l.restitution>=0&&h.restitution>=0&&(r.restitution=l.restitution*h.restitution),r.si=o||i,r.sj=s||n,r},e.createFrictionEquationsFromContact=function(t,e){var i=t.bi,n=t.bj,o=t.si,s=t.sj,r=this.world,a=this.currentContactMaterial,l=a.friction,h=o.material||i.material,c=s.material||n.material;if(h&&c&&h.friction>=0&&c.friction>=0&&(l=h.friction*c.friction),l>0){var u=l*r.gravity.length(),d=i.invMass+n.invMass;d>0&&(d=1/d);var p=this.frictionEquationPool,f=p.length?p.pop():new he(i,n,u*d),v=p.length?p.pop():new he(i,n,u*d);return f.bi=v.bi=i,f.bj=v.bj=n,f.minForce=v.minForce=-u*d,f.maxForce=v.maxForce=u*d,f.ri.copy(t.ri),f.rj.copy(t.rj),v.ri.copy(t.ri),v.rj.copy(t.rj),t.ni.tangents(f.t,v.t),f.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),v.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),f.enabled=v.enabled=t.enabled,e.push(f,v),!0}return!1},e.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];hn.setZero(),cn.setZero(),un.setZero();for(var o=e.bi,s=(e.bj,0);s!==t;s++)(e=this.result[this.result.length-1-s]).bi!==o?(hn.vadd(e.ni,hn),cn.vadd(e.ri,cn),un.vadd(e.rj,un)):(hn.vsub(e.ni,hn),cn.vadd(e.rj,cn),un.vadd(e.ri,un));var r=1/t;cn.scale(r,i.ri),un.scale(r,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),hn.normalize(),hn.tangents(i.t,n.t)}},e.getContacts=function(t,e,i,n,o,s,r){this.contactPointPool=o,this.frictionEquationPool=r,this.result=n,this.frictionResult=s;for(var a=fn,l=vn,h=dn,c=pn,u=0,d=t.length;u!==d;u++){var p=t[u],f=e[u],v=null;p.material&&f.material&&(v=i.getContactMaterial(p.material,f.material)||null);for(var m=p.type&R.KINEMATIC&&f.type&R.STATIC||p.type&R.STATIC&&f.type&R.KINEMATIC||p.type&R.KINEMATIC&&f.type&R.KINEMATIC,y=0;y<p.shapes.length;y++){p.quaternion.mult(p.shapeOrientations[y],a),p.quaternion.vmult(p.shapeOffsets[y],h),h.vadd(p.position,h);for(var g=p.shapes[y],w=0;w<f.shapes.length;w++){f.quaternion.mult(f.shapeOrientations[w],l),f.quaternion.vmult(f.shapeOffsets[w],c),c.vadd(f.position,c);var b=f.shapes[w];if(g.collisionFilterMask&b.collisionFilterGroup&&b.collisionFilterMask&g.collisionFilterGroup&&!(h.distanceTo(c)>g.boundingSphereRadius+b.boundingSphereRadius)){var x=null;g.material&&b.material&&(x=i.getContactMaterial(g.material,b.material)||null),this.currentContactMaterial=x||v||i.defaultContactMaterial;var E=this[g.type|b.type];E&&(g.type<b.type?E.call(this,g,b,h,c,a,l,p,f,g,b,m):E.call(this,b,g,c,h,l,a,f,p,g,b,m))&&m&&(i.shapeOverlapKeeper.set(g.id,b.id),i.bodyOverlapKeeper.set(p.id,f.id))}}}}},e.sphereSphere=function(t,e,i,n,o,s,r,a,l,h,c){if(c)return i.distanceSquared(n)<Math.pow(t.radius+e.radius,2);var u=this.createContactEquation(r,a,t,e,l,h);n.vsub(i,u.ni),u.ni.normalize(),u.ri.copy(u.ni),u.rj.copy(u.ni),u.ri.scale(t.radius,u.ri),u.rj.scale(-e.radius,u.rj),u.ri.vadd(i,u.ri),u.ri.vsub(r.position,u.ri),u.rj.vadd(n,u.rj),u.rj.vsub(a.position,u.rj),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)},e.spherePlane=function(t,e,i,n,o,s,r,a,l,h,c){var u=this.createContactEquation(r,a,t,e,l,h);if(u.ni.set(0,0,1),s.vmult(u.ni,u.ni),u.ni.negate(u.ni),u.ni.normalize(),u.ni.scale(t.radius,u.ri),i.vsub(n,Ln),u.ni.scale(u.ni.dot(Ln),Nn),Ln.vsub(Nn,u.rj),-Ln.dot(u.ni)<=t.radius){if(c)return!0;var d=u.ri,p=u.rj;d.vadd(i,d),d.vsub(r.position,d),p.vadd(n,p),p.vsub(a.position,p),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)}},e.boxBox=function(t,e,i,n,o,s,r,a,l,h,c){return t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,i,n,o,s,r,a,t,e,c)},e.sphereBox=function(t,e,i,n,o,s,r,a,l,h,c){var u=this.v3pool,d=jn;i.vsub(n,qn),e.getSideNormals(d,s);for(var p=t.radius,f=!1,v=Gn,m=Yn,y=Xn,g=null,w=0,b=0,x=0,E=null,A=0,S=d.length;A!==S&&!1===f;A++){var C=_n;C.copy(d[A]);var T=C.length();C.normalize();var B=qn.dot(C);if(B<T+p&&B>0){var M=Wn,z=kn;M.copy(d[(A+1)%3]),z.copy(d[(A+2)%3]);var R=M.length(),P=z.length();M.normalize(),z.normalize();var I=qn.dot(M),F=qn.dot(z);if(I<R&&I>-R&&F<P&&F>-P){var L=Math.abs(B-T-p);if((null===E||L<E)&&(E=L,b=I,x=F,g=T,v.copy(C),m.copy(M),y.copy(z),w++,c))return!0}}}if(w){f=!0;var N=this.createContactEquation(r,a,t,e,l,h);v.scale(-p,N.ri),N.ni.copy(v),N.ni.negate(N.ni),v.scale(g,v),m.scale(b,m),v.vadd(m,v),y.scale(x,y),v.vadd(y,N.rj),N.ri.vadd(i,N.ri),N.ri.vsub(r.position,N.ri),N.rj.vadd(n,N.rj),N.rj.vsub(a.position,N.rj),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult)}for(var D=u.get(),V=Un,O=0;2!==O&&!f;O++)for(var H=0;2!==H&&!f;H++)for(var q=0;2!==q&&!f;q++)if(D.set(0,0,0),O?D.vadd(d[0],D):D.vsub(d[0],D),H?D.vadd(d[1],D):D.vsub(d[1],D),q?D.vadd(d[2],D):D.vsub(d[2],D),n.vadd(D,V),V.vsub(i,V),V.lengthSquared()<p*p){if(c)return!0;f=!0;var _=this.createContactEquation(r,a,t,e,l,h);_.ri.copy(V),_.ri.normalize(),_.ni.copy(_.ri),_.ri.scale(p,_.ri),_.rj.copy(D),_.ri.vadd(i,_.ri),_.ri.vsub(r.position,_.ri),_.rj.vadd(n,_.rj),_.rj.vsub(a.position,_.rj),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}u.release(D),D=null;for(var W=u.get(),k=u.get(),j=u.get(),U=u.get(),G=u.get(),Y=d.length,X=0;X!==Y&&!f;X++)for(var Q=0;Q!==Y&&!f;Q++)if(X%3!=Q%3){d[Q].cross(d[X],W),W.normalize(),d[X].vadd(d[Q],k),j.copy(i),j.vsub(k,j),j.vsub(n,j);var Z=j.dot(W);W.scale(Z,U);for(var K=0;K===X%3||K===Q%3;)K++;G.copy(i),G.vsub(U,G),G.vsub(k,G),G.vsub(n,G);var J=Math.abs(Z),$=G.length();if(J<d[K].length()&&$<p){if(c)return!0;f=!0;var tt=this.createContactEquation(r,a,t,e,l,h);k.vadd(U,tt.rj),tt.rj.copy(tt.rj),G.negate(tt.ni),tt.ni.normalize(),tt.ri.copy(tt.rj),tt.ri.vadd(n,tt.ri),tt.ri.vsub(i,tt.ri),tt.ri.normalize(),tt.ri.scale(p,tt.ri),tt.ri.vadd(i,tt.ri),tt.ri.vsub(r.position,tt.ri),tt.rj.vadd(n,tt.rj),tt.rj.vsub(a.position,tt.rj),this.result.push(tt),this.createFrictionEquationsFromContact(tt,this.frictionResult)}}u.release(W,k,j,U,G)},e.planeBox=function(t,e,i,n,o,s,r,a,l,h,c){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,e.convexPolyhedronRepresentation.id=e.id,this.planeConvex(t,e.convexPolyhedronRepresentation,i,n,o,s,r,a,t,e,c)},e.convexConvex=function(t,e,i,n,o,s,r,a,l,h,c,u,d){var p=ho;if(!(i.distanceTo(n)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,i,o,n,s,p,u,d)){var f=[],v=co;t.clipAgainstHull(i,o,e,n,s,p,-100,100,f);for(var m=0,y=0;y!==f.length;y++){if(c)return!0;var g=this.createContactEquation(r,a,t,e,l,h),w=g.ri,b=g.rj;p.negate(g.ni),f[y].normal.negate(v),v.scale(f[y].depth,v),f[y].point.vadd(v,w),b.copy(f[y].point),w.vsub(i,w),b.vsub(n,b),w.vadd(i,w),w.vsub(r.position,w),b.vadd(n,b),b.vsub(a.position,b),this.result.push(g),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(g,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}},e.sphereConvex=function(t,e,i,n,o,s,r,a,l,h,c){var u=this.v3pool;i.vsub(n,Qn);for(var d=e.faceNormals,p=e.faces,f=e.vertices,v=t.radius,m=!1,y=0;y!==f.length;y++){var g=f[y],w=$n;s.vmult(g,w),n.vadd(w,w);var b=Jn;if(w.vsub(i,b),b.lengthSquared()<v*v){if(c)return!0;m=!0;var x=this.createContactEquation(r,a,t,e,l,h);return x.ri.copy(b),x.ri.normalize(),x.ni.copy(x.ri),x.ri.scale(v,x.ri),w.vsub(n,x.rj),x.ri.vadd(i,x.ri),x.ri.vsub(r.position,x.ri),x.rj.vadd(n,x.rj),x.rj.vsub(a.position,x.rj),this.result.push(x),void this.createFrictionEquationsFromContact(x,this.frictionResult)}}for(var E=0,A=p.length;E!==A&&!1===m;E++){var S=d[E],C=p[E],T=to;s.vmult(S,T);var B=eo;s.vmult(f[C[0]],B),B.vadd(n,B);var M=io;T.scale(-v,M),i.vadd(M,M);var z=no;M.vsub(B,z);var R=z.dot(T),P=oo;if(i.vsub(B,P),R<0&&P.dot(T)>0){for(var I=[],F=0,L=C.length;F!==L;F++){var N=u.get();s.vmult(f[C[F]],N),n.vadd(N,N),I.push(N)}if(Hn(I,T,i)){if(c)return!0;m=!0;var D=this.createContactEquation(r,a,t,e,l,h);T.scale(-v,D.ri),T.negate(D.ni);var V=u.get();T.scale(-R,V);var O=u.get();T.scale(-v,O),i.vsub(n,D.rj),D.rj.vadd(O,D.rj),D.rj.vadd(V,D.rj),D.rj.vadd(n,D.rj),D.rj.vsub(a.position,D.rj),D.ri.vadd(i,D.ri),D.ri.vsub(r.position,D.ri),u.release(V),u.release(O),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult);for(var H=0,q=I.length;H!==q;H++)u.release(I[H]);return}for(var _=0;_!==C.length;_++){var W=u.get(),k=u.get();s.vmult(f[C[(_+1)%C.length]],W),s.vmult(f[C[(_+2)%C.length]],k),n.vadd(W,W),n.vadd(k,k);var j=Zn;k.vsub(W,j);var U=Kn;j.unit(U);var G=u.get(),Y=u.get();i.vsub(W,Y);var X=Y.dot(U);U.scale(X,G),G.vadd(W,G);var Q=u.get();if(G.vsub(i,Q),X>0&&X*X<j.lengthSquared()&&Q.lengthSquared()<v*v){if(c)return!0;var Z=this.createContactEquation(r,a,t,e,l,h);G.vsub(n,Z.rj),G.vsub(i,Z.ni),Z.ni.normalize(),Z.ni.scale(v,Z.ri),Z.rj.vadd(n,Z.rj),Z.rj.vsub(a.position,Z.rj),Z.ri.vadd(i,Z.ri),Z.ri.vsub(r.position,Z.ri),this.result.push(Z),this.createFrictionEquationsFromContact(Z,this.frictionResult);for(var K=0,J=I.length;K!==J;K++)u.release(I[K]);return u.release(W),u.release(k),u.release(G),u.release(Q),void u.release(Y)}u.release(W),u.release(k),u.release(G),u.release(Q),u.release(Y)}for(var $=0,tt=I.length;$!==tt;$++)u.release(I[$])}}},e.planeConvex=function(t,e,i,n,o,s,r,a,l,h,c){var u=so,d=ro;d.set(0,0,1),o.vmult(d,d);for(var p=0,f=ao,v=0;v!==e.vertices.length;v++)if(u.copy(e.vertices[v]),s.vmult(u,u),n.vadd(u,u),u.vsub(i,f),d.dot(f)<=0){if(c)return!0;var m=this.createContactEquation(r,a,t,e,l,h),y=lo;d.scale(d.dot(f),y),u.vsub(y,y),y.vsub(i,m.ri),m.ni.copy(d),u.vsub(n,m.rj),m.ri.vadd(i,m.ri),m.ri.vsub(r.position,m.ri),m.rj.vadd(n,m.rj),m.rj.vsub(a.position,m.rj),this.result.push(m),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)},e.boxConvex=function(t,e,i,n,o,s,r,a,l,h,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,i,n,o,s,r,a,t,e,c)},e.sphereHeightfield=function(t,e,i,n,o,s,r,a,l,h,c){var u=e.data,d=t.radius,p=e.elementSize,f=Co,v=So;x.pointToLocalFrame(n,s,i,v);var m=Math.floor((v.x-d)/p)-1,y=Math.ceil((v.x+d)/p)+1,g=Math.floor((v.y-d)/p)-1,w=Math.ceil((v.y+d)/p)+1;if(!(y<0||w<0||m>u.length||g>u[0].length)){m<0&&(m=0),y<0&&(y=0),g<0&&(g=0),w<0&&(w=0),m>=u.length&&(m=u.length-1),y>=u.length&&(y=u.length-1),w>=u[0].length&&(w=u[0].length-1),g>=u[0].length&&(g=u[0].length-1);var b=[];e.getRectMinMax(m,g,y,w,b);var E=b[0],A=b[1];if(!(v.z-d>A||v.z+d<E))for(var S=this.result,C=m;C<y;C++)for(var T=g;T<w;T++){var B=S.length,M=!1;if(e.getConvexTrianglePillar(C,T,!1),x.pointToWorldFrame(n,s,e.pillarOffset,f),i.distanceTo(f)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(M=this.sphereConvex(t,e.pillarConvex,i,f,o,s,r,a,t,e,c)),c&&M)return!0;if(e.getConvexTrianglePillar(C,T,!0),x.pointToWorldFrame(n,s,e.pillarOffset,f),i.distanceTo(f)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(M=this.sphereConvex(t,e.pillarConvex,i,f,o,s,r,a,t,e,c)),c&&M)return!0;if(S.length-B>2)return}}},e.boxHeightfield=function(t,e,i,n,o,s,r,a,l,h,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,i,n,o,s,r,a,t,e,c)},e.convexHeightfield=function(t,e,i,n,o,s,r,a,l,h,c){var u=e.data,d=e.elementSize,p=t.boundingSphereRadius,f=Eo,v=Ao,m=xo;x.pointToLocalFrame(n,s,i,m);var y=Math.floor((m.x-p)/d)-1,g=Math.ceil((m.x+p)/d)+1,w=Math.floor((m.y-p)/d)-1,b=Math.ceil((m.y+p)/d)+1;if(!(g<0||b<0||y>u.length||w>u[0].length)){y<0&&(y=0),g<0&&(g=0),w<0&&(w=0),b<0&&(b=0),y>=u.length&&(y=u.length-1),g>=u.length&&(g=u.length-1),b>=u[0].length&&(b=u[0].length-1),w>=u[0].length&&(w=u[0].length-1);var E=[];e.getRectMinMax(y,w,g,b,E);var A=E[0],S=E[1];if(!(m.z-p>S||m.z+p<A))for(var C=y;C<g;C++)for(var T=w;T<b;T++){var B=!1;if(e.getConvexTrianglePillar(C,T,!1),x.pointToWorldFrame(n,s,e.pillarOffset,f),i.distanceTo(f)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(B=this.convexConvex(t,e.pillarConvex,i,f,o,s,r,a,null,null,c,v,null)),c&&B)return!0;if(e.getConvexTrianglePillar(C,T,!0),x.pointToWorldFrame(n,s,e.pillarOffset,f),i.distanceTo(f)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(B=this.convexConvex(t,e.pillarConvex,i,f,o,s,r,a,null,null,c,v,null)),c&&B)return!0}}},e.sphereParticle=function(t,e,i,n,o,s,r,a,l,h,c){var u=vo;if(u.set(0,0,1),n.vsub(i,u),u.lengthSquared()<=t.radius*t.radius){if(c)return!0;var d=this.createContactEquation(a,r,e,t,l,h);u.normalize(),d.rj.copy(u),d.rj.scale(t.radius,d.rj),d.ni.copy(u),d.ni.negate(d.ni),d.ri.set(0,0,0),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}},e.planeParticle=function(t,e,i,n,o,s,r,a,l,h,c){var u=uo;u.set(0,0,1),r.quaternion.vmult(u,u);var d=po;if(n.vsub(r.position,d),u.dot(d)<=0){if(c)return!0;var p=this.createContactEquation(a,r,e,t,l,h);p.ni.copy(u),p.ni.negate(p.ni),p.ri.set(0,0,0);var f=fo;u.scale(u.dot(n),f),n.vsub(f,f),p.rj.copy(f),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}},e.boxParticle=function(t,e,i,n,o,s,r,a,l,h,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,i,n,o,s,r,a,t,e,c)},e.convexParticle=function(t,e,i,n,o,s,r,a,l,h,c){var u=-1,d=go,p=bo,f=null,v=yo;if(v.copy(n),v.vsub(i,v),o.conjugate(mo),mo.vmult(v,v),t.pointIsInside(v)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(i,o),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(o);for(var m=0,y=t.faces.length;m!==y;m++){var g=[t.worldVertices[t.faces[m][0]]],w=t.worldFaceNormals[m];n.vsub(g[0],wo);var b=-w.dot(wo);if(null===f||Math.abs(b)<Math.abs(f)){if(c)return!0;f=b,u=m,d.copy(w)}}if(-1!==u){var x=this.createContactEquation(a,r,e,t,l,h);d.scale(f,p),p.vadd(n,p),p.vsub(i,p),x.rj.copy(p),d.negate(x.ni),x.ri.set(0,0,0);var E=x.ri,A=x.rj;E.vadd(n,E),E.vsub(a.position,E),A.vadd(i,A),A.vsub(r.position,A),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},e.sphereTrimesh=function(t,e,i,n,o,s,r,a,l,h,c){var u=An,d=Sn,p=Cn,f=Tn,v=Bn,m=Mn,y=In,g=En,w=bn,b=Fn;x.pointToLocalFrame(n,s,i,v);var E=t.radius;y.lowerBound.set(v.x-E,v.y-E,v.z-E),y.upperBound.set(v.x+E,v.y+E,v.z+E),e.getTrianglesInAABB(y,b);for(var A=xn,S=t.radius*t.radius,C=0;C<b.length;C++)for(var T=0;T<3;T++)if(e.getVertex(e.indices[3*b[C]+T],A),A.vsub(v,w),w.lengthSquared()<=S){if(g.copy(A),x.pointToWorldFrame(n,s,g,A),A.vsub(i,w),c)return!0;var B=this.createContactEquation(r,a,t,e,l,h);B.ni.copy(w),B.ni.normalize(),B.ri.copy(B.ni),B.ri.scale(t.radius,B.ri),B.ri.vadd(i,B.ri),B.ri.vsub(r.position,B.ri),B.rj.copy(A),B.rj.vsub(a.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}for(var M=0;M<b.length;M++)for(var z=0;z<3;z++){e.getVertex(e.indices[3*b[M]+z],u),e.getVertex(e.indices[3*b[M]+(z+1)%3],d),d.vsub(u,p),v.vsub(d,m);var R=m.dot(p);v.vsub(u,m);var P=m.dot(p);if(P>0&&R<0&&(v.vsub(u,m),f.copy(p),f.normalize(),P=m.dot(f),f.scale(P,m),m.vadd(u,m),m.distanceTo(v)<t.radius)){if(c)return!0;var I=this.createContactEquation(r,a,t,e,l,h);m.vsub(v,I.ni),I.ni.normalize(),I.ni.scale(t.radius,I.ri),I.ri.vadd(i,I.ri),I.ri.vsub(r.position,I.ri),x.pointToWorldFrame(n,s,m,m),m.vsub(a.position,I.rj),x.vectorToWorldFrame(s,I.ni,I.ni),x.vectorToWorldFrame(s,I.ri,I.ri),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult)}}for(var F=zn,L=Rn,N=Pn,D=wn,V=0,O=b.length;V!==O;V++){e.getTriangleVertices(b[V],F,L,N),e.getNormal(b[V],D),v.vsub(F,m);var H=m.dot(D);if(D.scale(H,m),v.vsub(m,m),H=m.distanceTo(v),$.pointInTriangle(m,F,L,N)&&H<t.radius){if(c)return!0;var q=this.createContactEquation(r,a,t,e,l,h);m.vsub(v,q.ni),q.ni.normalize(),q.ni.scale(t.radius,q.ri),q.ri.vadd(i,q.ri),q.ri.vsub(r.position,q.ri),x.pointToWorldFrame(n,s,m,m),m.vsub(a.position,q.rj),x.vectorToWorldFrame(s,q.ni,q.ni),x.vectorToWorldFrame(s,q.ri,q.ri),this.result.push(q),this.createFrictionEquationsFromContact(q,this.frictionResult)}}b.length=0},e.planeTrimesh=function(t,e,i,n,o,r,a,l,h,c,u){var d=new s,p=mn;p.set(0,0,1),o.vmult(p,p);for(var f=0;f<e.vertices.length/3;f++){e.getVertex(f,d);var v=new s;v.copy(d),x.pointToWorldFrame(n,r,v,d);var m=yn;if(d.vsub(i,m),p.dot(m)<=0){if(u)return!0;var y=this.createContactEquation(a,l,t,e,h,c);y.ni.copy(p);var g=gn;p.scale(m.dot(p),g),d.vsub(g,g),y.ri.copy(g),y.ri.vsub(a.position,y.ri),y.rj.copy(d),y.rj.vsub(l.position,y.rj),this.result.push(y),this.createFrictionEquationsFromContact(y,this.frictionResult)}}},t}(),hn=new s,cn=new s,un=new s,dn=new s,pn=new s,fn=new m,vn=new m;ln.prototype[an.boxBox]=ln.prototype.boxBox,ln.prototype[an.boxConvex]=ln.prototype.boxConvex,ln.prototype[an.boxParticle]=ln.prototype.boxParticle,ln.prototype[an.sphereSphere]=ln.prototype.sphereSphere;var mn=new s,yn=new s,gn=new s;ln.prototype[an.planeTrimesh]=ln.prototype.planeTrimesh;var wn=new s,bn=new s,xn=(new s,new s),En=new s,An=new s,Sn=new s,Cn=new s,Tn=new s,Bn=new s,Mn=new s,zn=new s,Rn=new s,Pn=new s,In=new h,Fn=[];ln.prototype[an.sphereTrimesh]=ln.prototype.sphereTrimesh;var Ln=new s,Nn=new s;ln.prototype[an.spherePlane]=ln.prototype.spherePlane;var Dn=new s,Vn=new s,On=new s;function Hn(t,e,i){for(var n=null,o=t.length,s=0;s!==o;s++){var r=t[s],a=Dn;t[(s+1)%o].vsub(r,a);var l=Vn;a.cross(e,l);var h=On;i.vsub(r,h);var c=l.dot(h);if(!(null===n||c>0&&!0===n||c<=0&&!1===n))return!1;null===n&&(n=c>0)}return!0}var qn=new s,_n=new s,Wn=new s,kn=new s,jn=[new s,new s,new s,new s,new s,new s],Un=new s,Gn=new s,Yn=new s,Xn=new s;ln.prototype[an.sphereBox]=ln.prototype.sphereBox;var Qn=new s,Zn=new s,Kn=new s,Jn=new s,$n=new s,to=new s,eo=new s,io=new s,no=new s,oo=new s;ln.prototype[an.sphereConvex]=ln.prototype.sphereConvex,new s,new s,ln.prototype[an.planeBox]=ln.prototype.planeBox;var so=new s,ro=new s,ao=new s,lo=new s;ln.prototype[an.planeConvex]=ln.prototype.planeConvex;var ho=new s,co=new s;ln.prototype[an.convexConvex]=ln.prototype.convexConvex;var uo=new s,po=new s,fo=new s;ln.prototype[an.planeParticle]=ln.prototype.planeParticle;var vo=new s;ln.prototype[an.sphereParticle]=ln.prototype.sphereParticle;var mo=new m,yo=new s,go=(new s,new s),wo=new s,bo=new s;ln.prototype[an.convexParticle]=ln.prototype.convexParticle,ln.prototype[an.boxHeightfield]=ln.prototype.boxHeightfield;var xo=new s,Eo=new s,Ao=[0];ln.prototype[an.convexHeightfield]=ln.prototype.convexHeightfield;var So=new s,Co=new s;ln.prototype[an.sphereHeightfield]=ln.prototype.sphereHeightfield;var To=function(){function t(){this.current=[],this.previous=[]}var e=t.prototype;return e.getKey=function(t,e){if(e<t){var i=e;e=t,t=i}return t<<16|e},e.set=function(t,e){for(var i=this.getKey(t,e),n=this.current,o=0;i>n[o];)o++;if(i!==n[o]){for(var s=n.length-1;s>=o;s--)n[s+1]=n[s];n[o]=i}},e.tick=function(){var t=this.current;this.current=this.previous,this.previous=t,this.current.length=0},e.getDiff=function(t,e){for(var i=this.current,n=this.previous,o=i.length,s=n.length,r=0,a=0;a<o;a++){for(var l=i[a];l>n[r];)r++;l===n[r]||Bo(t,l)}r=0;for(var h=0;h<s;h++){for(var c=n[h];c>i[r];)r++;i[r]===c||Bo(e,c)}},t}();function Bo(t,e){t.push((4294901760&e)>>16,65535&e)}var Mo=function(){function t(){this.data={keys:[]}}var e=t.prototype;return e.get=function(t,e){if(t>e){var i=e;e=t,t=i}return this.data[t+"-"+e]},e.set=function(t,e,i){if(t>e){var n=e;e=t,t=n}var o=t+"-"+e;this.get(t,e)||this.data.keys.push(o),this.data[o]=i},e.reset=function(){for(var t=this.data,e=t.keys;e.length>0;)delete t[e.pop()]},t}(),zo=function(t){function e(e){var i;return void 0===e&&(e={}),(i=t.call(this)||this).dt=-1,i.allowSleep=!!e.allowSleep,i.contacts=[],i.frictionEquations=[],i.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,i.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,i.time=0,i.stepnumber=0,i.default_dt=1/60,i.nextId=0,i.gravity=new s,e.gravity&&i.gravity.copy(e.gravity),i.broadphase=void 0!==e.broadphase?e.broadphase:new K,i.bodies=[],i.hasActiveBodies=!1,i.solver=void 0!==e.solver?e.solver:new ji,i.constraints=[],i.narrowphase=new ln(f(i)),i.collisionMatrix=new d,i.collisionMatrixPrevious=new d,i.bodyOverlapKeeper=new To,i.shapeOverlapKeeper=new To,i.materials=[],i.contactmaterials=[],i.contactMaterialTable=new Mo,i.defaultMaterial=new pe("default"),i.defaultContactMaterial=new de(i.defaultMaterial,i.defaultMaterial,{friction:.3,restitution:0}),i.doProfiling=!1,i.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},i.accumulator=0,i.subsystems=[],i.addBodyEvent={type:"addBody",body:null},i.removeBodyEvent={type:"removeBody",body:null},i.idToBodyMap={},i.broadphase.setWorld(f(i)),i}p(e,t);var i=e.prototype;return i.getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)},i.numObjects=function(){return this.bodies.length},i.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},i.addConstraint=function(t){this.constraints.push(t)},i.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},i.rayTest=function(t,e,i){i instanceof J?this.raycastClosest(t,e,{skipBackfaces:!0},i):this.raycastAll(t,e,{skipBackfaces:!0},i)},i.raycastAll=function(t,e,i,n){return void 0===i&&(i={}),i.mode=$.ALL,i.from=t,i.to=e,i.callback=n,Ro.intersectWorld(this,i)},i.raycastAny=function(t,e,i,n){return void 0===i&&(i={}),i.mode=$.ANY,i.from=t,i.to=e,i.result=n,Ro.intersectWorld(this,i)},i.raycastClosest=function(t,e,i,n){return void 0===i&&(i={}),i.mode=$.CLOSEST,i.from=t,i.to=e,i.result=n,Ro.intersectWorld(this,i)},i.addBody=function(t){this.bodies.includes(t)||(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof R&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.idToBodyMap[t.id]=t,this.dispatchEvent(this.addBodyEvent))},i.removeBody=function(t){t.world=null;var e=this.bodies.length-1,i=this.bodies,n=i.indexOf(t);if(-1!==n){i.splice(n,1);for(var o=0;o!==i.length;o++)i[o].index=o;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,delete this.idToBodyMap[t.id],this.dispatchEvent(this.removeBodyEvent)}},i.getBodyById=function(t){return this.idToBodyMap[t]},i.getShapeById=function(t){for(var e=this.bodies,i=0,n=e.length;i<n;i++)for(var o=e[i].shapes,s=0,r=o.length;s<r;s++){var a=o[s];if(a.id===t)return a}},i.addMaterial=function(t){this.materials.push(t)},i.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},i.step=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=10),0===e)this.internalStep(t),this.time+=t;else{this.accumulator+=e;for(var n=0;this.accumulator>=t&&n<i;)this.internalStep(t),this.accumulator-=t,n++;for(var o=this.accumulator%t/t,s=0;s!==this.bodies.length;s++){var r=this.bodies[s];r.previousPosition.lerp(r.position,o,r.interpolatedPosition),r.previousQuaternion.slerp(r.quaternion,o,r.interpolatedQuaternion),r.previousQuaternion.normalize()}this.time+=e}},i.internalStep=function(t){this.dt=t;var e=this.contacts,i=ko,n=jo,o=this.numObjects(),s=this.bodies,r=this.solver,a=this.gravity,l=this.doProfiling,h=this.profile,c=R.DYNAMIC,u=-1/0,d=this.constraints,p=Wo,f=(a.length(),a.x),v=a.y,m=a.z,y=0;for(l&&(u=performance.now()),y=0;y!==o;y++){var g=s[y];if(g.type===c){var w=g.force,b=g.mass;w.x+=b*f,w.y+=b*v,w.z+=b*m}}for(var x=0,E=this.subsystems.length;x!==E;x++)this.subsystems[x].update();l&&(u=performance.now()),i.length=0,n.length=0,this.broadphase.collisionPairs(this,i,n),l&&(h.broadphase=performance.now()-u);var A=d.length;for(y=0;y!==A;y++){var S=d[y];if(!S.collideConnected)for(var C=i.length-1;C>=0;C-=1)(S.bodyA===i[C]&&S.bodyB===n[C]||S.bodyB===i[C]&&S.bodyA===n[C])&&(i.splice(C,1),n.splice(C,1))}this.collisionMatrixTick(),l&&(u=performance.now());var T=_o,B=e.length;for(y=0;y!==B;y++)T.push(e[y]);e.length=0;var M=this.frictionEquations.length;for(y=0;y!==M;y++)p.push(this.frictionEquations[y]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,n,this,e,T,this.frictionEquations,p),l&&(h.narrowphase=performance.now()-u),l&&(u=performance.now()),y=0;y<this.frictionEquations.length;y++)r.addEquation(this.frictionEquations[y]);for(var z=e.length,P=0;P!==z;P++){var I=e[P],F=I.bi,L=I.bj,N=I.si,D=I.sj;(F.material&&L.material&&this.getContactMaterial(F.material,L.material)||this.defaultContactMaterial).friction,F.material&&L.material&&(F.material.friction>=0&&L.material.friction>=0&&(F.material.friction,L.material.friction),F.material.restitution>=0&&L.material.restitution>=0&&(I.restitution=F.material.restitution*L.material.restitution)),r.addEquation(I),F.allowSleep&&F.type===R.DYNAMIC&&F.sleepState===R.SLEEPING&&L.sleepState===R.AWAKE&&L.type!==R.STATIC&&L.velocity.lengthSquared()+L.angularVelocity.lengthSquared()>=2*Math.pow(L.sleepSpeedLimit,2)&&(F.wakeUpAfterNarrowphase=!0),L.allowSleep&&L.type===R.DYNAMIC&&L.sleepState===R.SLEEPING&&F.sleepState===R.AWAKE&&F.type!==R.STATIC&&F.velocity.lengthSquared()+F.angularVelocity.lengthSquared()>=2*Math.pow(F.sleepSpeedLimit,2)&&(L.wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(F,L,!0),this.collisionMatrixPrevious.get(F,L)||(qo.body=L,qo.contact=I,F.dispatchEvent(qo),qo.body=F,L.dispatchEvent(qo)),this.bodyOverlapKeeper.set(F.id,L.id),this.shapeOverlapKeeper.set(N.id,D.id)}for(this.emitContactEvents(),l&&(h.makeContactConstraints=performance.now()-u,u=performance.now()),y=0;y!==o;y++){var V=s[y];V.wakeUpAfterNarrowphase&&(V.wakeUp(),V.wakeUpAfterNarrowphase=!1)}for(A=d.length,y=0;y!==A;y++){var O=d[y];O.update();for(var H=0,q=O.equations.length;H!==q;H++){var _=O.equations[H];r.addEquation(_)}}r.solve(t,this),l&&(h.solve=performance.now()-u),r.removeAllEquations();var W=Math.pow;for(y=0;y!==o;y++){var k=s[y];if(k.type&c){var j=W(1-k.linearDamping,t),U=k.velocity;U.scale(j,U);var G=k.angularVelocity;if(G){var Y=W(1-k.angularDamping,t);G.scale(Y,G)}}}for(this.dispatchEvent(Ho),y=0;y!==o;y++){var X=s[y];X.preStep&&X.preStep.call(X)}l&&(u=performance.now());var Q=this.stepnumber%(this.quatNormalizeSkip+1)==0,Z=this.quatNormalizeFast;for(y=0;y!==o;y++)s[y].integrate(t,Q,Z);for(this.clearForces(),this.broadphase.dirty=!0,l&&(h.integrate=performance.now()-u),this.time+=t,this.stepnumber+=1,this.dispatchEvent(Oo),y=0;y!==o;y++){var K=s[y],J=K.postStep;J&&J.call(K)}var $=!0;if(this.allowSleep)for($=!1,y=0;y!==o;y++){var tt=s[y];tt.sleepTick(this.time),tt.sleepState!==R.SLEEPING&&($=!0)}this.hasActiveBodies=$},i.clearForces=function(){for(var t=this.bodies,e=t.length,i=0;i!==e;i++){var n=t[i];n.force,n.torque,n.force.set(0,0,0),n.torque.set(0,0,0)}},e}(v),Ro=(new h,new $);if("undefined"==typeof performance&&(performance={}),!performance.now){var Po=Date.now();performance.timing&&performance.timing.navigationStart&&(Po=performance.timing.navigationStart),performance.now=function(){return Date.now()-Po}}new s;var Io,Fo,Lo,No,Do,Vo,Oo={type:"postStep"},Ho={type:"preStep"},qo={type:R.COLLIDE_EVENT_NAME,body:null,contact:null},_o=[],Wo=[],ko=[],jo=[];zo.prototype.emitContactEvents=(Io=[],Fo=[],Lo={type:"beginContact",bodyA:null,bodyB:null},No={type:"endContact",bodyA:null,bodyB:null},Do={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},Vo={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},function(){var t=this.hasAnyEventListener("beginContact"),e=this.hasAnyEventListener("endContact");if((t||e)&&this.bodyOverlapKeeper.getDiff(Io,Fo),t){for(var i=0,n=Io.length;i<n;i+=2)Lo.bodyA=this.getBodyById(Io[i]),Lo.bodyB=this.getBodyById(Io[i+1]),this.dispatchEvent(Lo);Lo.bodyA=Lo.bodyB=null}if(e){for(var o=0,s=Fo.length;o<s;o+=2)No.bodyA=this.getBodyById(Fo[o]),No.bodyB=this.getBodyById(Fo[o+1]),this.dispatchEvent(No);No.bodyA=No.bodyB=null}Io.length=Fo.length=0;var r=this.hasAnyEventListener("beginShapeContact"),a=this.hasAnyEventListener("endShapeContact");if((r||a)&&this.shapeOverlapKeeper.getDiff(Io,Fo),r){for(var l=0,h=Io.length;l<h;l+=2){var c=this.getShapeById(Io[l]),u=this.getShapeById(Io[l+1]);Do.shapeA=c,Do.shapeB=u,Do.bodyA=c.body,Do.bodyB=u.body,this.dispatchEvent(Do)}Do.bodyA=Do.bodyB=Do.shapeA=Do.shapeB=null}if(a){for(var d=0,p=Fo.length;d<p;d+=2){var f=this.getShapeById(Fo[d]),v=this.getShapeById(Fo[d+1]);Vo.shapeA=f,Vo.shapeB=v,Vo.bodyA=f.body,Vo.bodyB=v.body,this.dispatchEvent(Vo)}Vo.bodyA=Vo.bodyB=Vo.shapeA=Vo.shapeB=null}}),i.AABB=h,i.ArrayCollisionMatrix=d,i.BODY_SLEEP_STATES=z,i.BODY_TYPES={DYNAMIC:1,STATIC:2,KINEMATIC:4},i.Body=R,i.Box=T,i.Broadphase=j,i.COLLISION_TYPES=an,i.ConeTwistConstraint=ie,i.Constraint=Pt,i.ContactEquation=qt,i.ContactMaterial=de,i.ConvexPolyhedron=A,i.Cylinder=ui,i.DistanceConstraint=ne,i.Equation=Ft,i.EventTarget=v,i.FrictionEquation=he,i.GSSolver=ji,i.GridBroadphase=Q,i.Heightfield=vi,i.HingeConstraint=re,i.JacobianElement=It,i.LockConstraint=oe,i.Mat3=o,i.Material=pe,i.NaiveBroadphase=K,i.Narrowphase=ln,i.ObjectCollisionMatrix=n,i.Particle=di,i.Plane=pi,i.PointToPointConstraint=Qt,i.Pool=sn,i.Quaternion=m,i.RAY_MODES={CLOSEST:1,ANY:2,ALL:4},i.Ray=$,i.RaycastResult=J,i.RaycastVehicle=ze,i.RigidVehicle=ti,i.RotationalEquation=$t,i.RotationalMotorEquation=se,i.SAPBroadphase=zt,i.SHAPE_TYPES=w,i.SPHSystem=ni,i.Shape=b,i.Solver=ki,i.Sphere=$e,i.SplitSolver=Xi,i.Spring=fe,i.Transform=x,i.Trimesh=zi,i.Vec3=s,i.Vec3Pool=rn,i.World=zo},{}],5:[function(t,e,i){"use strict";const n=i.TYPE={BOX:"box",CYLINDER:"cylinder",SPHERE:"sphere",CAPSULE:"capsule",CONE:"cone",HULL:"hull",HACD:"hacd",VHACD:"vhacd",MESH:"mesh",HEIGHTFIELD:"heightfield"},o=i.FIT={ALL:"all",MANUAL:"manual"},s=(i.HEIGHTFIELD_DATA_TYPE={short:"short",float:"float"},THREE.Object3D.prototype.hasOwnProperty("updateMatrices"));function r(t){t.fit=t.hasOwnProperty("fit")?t.fit:o.ALL,t.type=t.type||n.HULL,t.minHalfExtent=t.hasOwnProperty("minHalfExtent")?t.minHalfExtent:0,t.maxHalfExtent=t.hasOwnProperty("maxHalfExtent")?t.maxHalfExtent:Number.POSITIVE_INFINITY,t.cylinderAxis=t.cylinderAxis||"y",t.margin=t.hasOwnProperty("margin")?t.margin:.01,t.includeInvisible=!!t.hasOwnProperty("includeInvisible")&&t.includeInvisible,t.offset||(t.offset=new THREE.Vector3),t.orientation||(t.orientation=new THREE.Quaternion)}i.createCollisionShapes=function(t,e){switch(e.type){case n.BOX:return[this.createBoxShape(t,e)];case n.CYLINDER:return[this.createCylinderShape(t,e)];case n.CAPSULE:return[this.createCapsuleShape(t,e)];case n.CONE:return[this.createConeShape(t,e)];case n.SPHERE:return[this.createSphereShape(t,e)];case n.HULL:return[this.createHullShape(t,e)];case n.HACD:return this.createHACDShapes(t,e);case n.VHACD:return this.createVHACDShapes(t,e);case n.MESH:return[this.createTriMeshShape(t,e)];case n.HEIGHTFIELD:return[this.createHeightfieldTerrainShape(t,e)];default:return console.warn(e.type+" is not currently supported"),[]}},i.createBoxShape=function(t,e){e.type=n.BOX,r(e),e.fit===o.ALL&&(e.halfExtents=u(t,d(t,e),e.minHalfExtent,e.maxHalfExtent));const i=new Ammo.btVector3(e.halfExtents.x,e.halfExtents.y,e.halfExtents.z),s=new Ammo.btBoxShape(i);return Ammo.destroy(i),a(s,e,h(t,e)),s},i.createCylinderShape=function(t,e){e.type=n.CYLINDER,r(e),e.fit===o.ALL&&(e.halfExtents=u(t,d(t,e),e.minHalfExtent,e.maxHalfExtent));const i=new Ammo.btVector3(e.halfExtents.x,e.halfExtents.y,e.halfExtents.z),s=(()=>{switch(e.cylinderAxis){case"y":return new Ammo.btCylinderShape(i);case"x":return new Ammo.btCylinderShapeX(i);case"z":return new Ammo.btCylinderShapeZ(i)}return null})();return Ammo.destroy(i),a(s,e,h(t,e)),s},i.createCapsuleShape=function(t,e){e.type=n.CAPSULE,r(e),e.fit===o.ALL&&(e.halfExtents=u(t,d(t,e),e.minHalfExtent,e.maxHalfExtent));const{x:i,y:s,z:l}=e.halfExtents,c=(()=>{switch(e.cylinderAxis){case"y":return new Ammo.btCapsuleShape(Math.max(i,l),2*s);case"x":return new Ammo.btCapsuleShapeX(Math.max(s,l),2*i);case"z":return new Ammo.btCapsuleShapeZ(Math.max(i,s),2*l)}return null})();return a(c,e,h(t,e)),c},i.createConeShape=function(t,e){e.type=n.CONE,r(e),e.fit===o.ALL&&(e.halfExtents=u(t,d(t,e),e.minHalfExtent,e.maxHalfExtent));const{x:i,y:s,z:l}=e.halfExtents,c=(()=>{switch(e.cylinderAxis){case"y":return new Ammo.btConeShape(Math.max(i,l),2*s);case"x":return new Ammo.btConeShapeX(Math.max(s,l),2*i);case"z":return new Ammo.btConeShapeZ(Math.max(i,s),2*l)}return null})();return a(c,e,h(t,e)),c},i.createSphereShape=function(t,e){let i;e.type=n.SPHERE,r(e),i=e.fit!==o.MANUAL||isNaN(e.sphereRadius)?c(t,e,d(t,e)):e.sphereRadius;const s=new Ammo.btSphereShape(i);return a(s,e,h(t,e)),s},i.createHullShape=function(){const t=new THREE.Vector3,e=new THREE.Vector3;return function(i,s){if(s.type=n.HULL,r(s),s.fit===o.MANUAL)return console.warn("cannot use fit: manual with type: hull"),null;const c=d(i,s),u=new Ammo.btVector3,p=new Ammo.btConvexHullShape;p.setMargin(s.margin),e.addVectors(c.max,c.min).multiplyScalar(.5);let f=0;l(i,s,(t=>{f+=t.attributes.position.array.length/3}));const v=s.hullMaxVertices||1e5;f>v&&console.warn(`too many vertices for hull shape; sampling ~${v} from ~${f} vertices`);const m=Math.min(1,v/f);l(i,s,((i,n)=>{const o=i.attributes.position.array;for(let i=0;i<o.length;i+=3)Math.random()<=m&&(t.set(o[i],o[i+1],o[i+2]).applyMatrix4(n).sub(e),u.setValue(t.x,t.y,t.z),p.addPoint(u,i===o.length-3))}));let y=p;if(p.getNumVertices()>=100){const t=new Ammo.btShapeHull(p);t.buildHull(s.margin),Ammo.destroy(p),y=new Ammo.btConvexHullShape(Ammo.getPointer(t.getVertexPointer()),t.numVertices()),Ammo.destroy(t)}return Ammo.destroy(u),a(y,s,h(i,s)),y}}(),i.createHACDShapes=function(){const t=new THREE.Vector3,e=new THREE.Vector3;return function(i,s){if(s.type=n.HACD,r(s),s.fit===o.MANUAL)return console.warn("cannot use fit: manual with type: hacd"),[];if(!Ammo.hasOwnProperty("HACD"))return console.warn("HACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];const c=d(i),u=h(i,s);let p=0,f=0;e.addVectors(c.max,c.min).multiplyScalar(.5),l(i,s,(t=>{p+=t.attributes.position.array.length/3,t.index?f+=t.index.array.length/3:f+=t.attributes.position.array.length/9}));const v=new Ammo.HACD;s.hasOwnProperty("compacityWeight")&&v.SetCompacityWeight(s.compacityWeight),s.hasOwnProperty("volumeWeight")&&v.SetVolumeWeight(s.volumeWeight),s.hasOwnProperty("nClusters")&&v.SetNClusters(s.nClusters),s.hasOwnProperty("nVerticesPerCH")&&v.SetNVerticesPerCH(s.nVerticesPerCH),s.hasOwnProperty("concavity")&&v.SetConcavity(s.concavity);const m=Ammo._malloc(3*p*8),y=Ammo._malloc(3*f*4);v.SetPoints(m),v.SetTriangles(y),v.SetNPoints(p),v.SetNTriangles(f);const g=m/8,w=y/4;l(i,s,((i,n)=>{const o=i.attributes.position.array,s=i.index?i.index.array:null;for(let i=0;i<o.length;i+=3)t.set(o[i+0],o[i+1],o[i+2]).applyMatrix4(n).sub(e),Ammo.HEAPF64[g+i+0]=t.x,Ammo.HEAPF64[g+i+1]=t.y,Ammo.HEAPF64[g+i+2]=t.z;if(s)for(let t=0;t<s.length;t++)Ammo.HEAP32[w+t]=s[t];else for(let t=0;t<o.length/3;t++)Ammo.HEAP32[w+t]=t})),v.Compute(),Ammo._free(m),Ammo._free(y);const b=v.GetNClusters(),x=[];for(let t=0;t<b;t++){const e=new Ammo.btConvexHullShape;e.setMargin(s.margin);const i=v.GetNPointsCH(t),n=v.GetNTrianglesCH(t),o=Ammo._malloc(3*i*8),r=Ammo._malloc(3*n*4);v.GetCH(t,o,r);const l=o/8;for(let t=0;t<i;t++){const n=new Ammo.btVector3,o=Ammo.HEAPF64[l+3*t+0],s=Ammo.HEAPF64[l+3*t+1],r=Ammo.HEAPF64[l+3*t+2];n.setValue(o,s,r),e.addPoint(n,t===i-1),Ammo.destroy(n)}a(e,s,u),x.push(e)}return x}}(),i.createVHACDShapes=function(){const t=new THREE.Vector3,e=new THREE.Vector3;return function(i,s){if(s.type=n.VHACD,r(s),s.fit===o.MANUAL)return console.warn("cannot use fit: manual with type: vhacd"),[];if(!Ammo.hasOwnProperty("VHACD"))return console.warn("VHACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];const c=d(i,s),u=h(i,s);let p=0,f=0;e.addVectors(c.max,c.min).multiplyScalar(.5),l(i,s,(t=>{p+=t.attributes.position.count,t.index?f+=t.index.count/3:f+=t.attributes.position.count/3}));const v=new Ammo.VHACD,m=new Ammo.Parameters;s.hasOwnProperty("resolution")&&m.set_m_resolution(s.resolution),s.hasOwnProperty("depth")&&m.set_m_depth(s.depth),s.hasOwnProperty("concavity")&&m.set_m_concavity(s.concavity),s.hasOwnProperty("planeDownsampling")&&m.set_m_planeDownsampling(s.planeDownsampling),s.hasOwnProperty("convexhullDownsampling")&&m.set_m_convexhullDownsampling(s.convexhullDownsampling),s.hasOwnProperty("alpha")&&m.set_m_alpha(s.alpha),s.hasOwnProperty("beta")&&m.set_m_beta(s.beta),s.hasOwnProperty("gamma")&&m.set_m_gamma(s.gamma),s.hasOwnProperty("pca")&&m.set_m_pca(s.pca),s.hasOwnProperty("mode")&&m.set_m_mode(s.mode),s.hasOwnProperty("maxNumVerticesPerCH")&&m.set_m_maxNumVerticesPerCH(s.maxNumVerticesPerCH),s.hasOwnProperty("minVolumePerCH")&&m.set_m_minVolumePerCH(s.minVolumePerCH),s.hasOwnProperty("convexhullApproximation")&&m.set_m_convexhullApproximation(s.convexhullApproximation),s.hasOwnProperty("oclAcceleration")&&m.set_m_oclAcceleration(s.oclAcceleration);const y=Ammo._malloc(3*p*8),g=Ammo._malloc(3*f*4);let w=y/8,b=g/4;l(i,s,((i,n)=>{const o=i.attributes.position.array,s=i.index?i.index.array:null;for(let i=0;i<o.length;i+=3)t.set(o[i+0],o[i+1],o[i+2]).applyMatrix4(n).sub(e),Ammo.HEAPF64[w+0]=t.x,Ammo.HEAPF64[w+1]=t.y,Ammo.HEAPF64[w+2]=t.z,w+=3;if(s)for(let t=0;t<s.length;t++)Ammo.HEAP32[b]=s[t],b++;else for(let t=0;t<o.length/3;t++)Ammo.HEAP32[b]=t,b++})),v.Compute(y,3,p,g,3,f,m),Ammo._free(y),Ammo._free(g);const x=v.GetNConvexHulls(),E=[],A=new Ammo.ConvexHull;for(let t=0;t<x;t++){v.GetConvexHull(t,A);const e=A.get_m_nPoints(),i=(A.get_m_points(),new Ammo.btConvexHullShape);i.setMargin(s.margin);for(let t=0;t<e;t++){const n=new Ammo.btVector3,o=A.get_m_points(3*t+0),s=A.get_m_points(3*t+1),r=A.get_m_points(3*t+2);n.setValue(o,s,r),i.addPoint(n,t===e-1),Ammo.destroy(n)}a(i,s,u),E.push(i)}return Ammo.destroy(A),Ammo.destroy(v),E}}(),i.createTriMeshShape=function(){const t=new THREE.Vector3,e=new THREE.Vector3,i=new THREE.Vector3;return function(s,c){if(c.type=n.MESH,r(c),c.fit===o.MANUAL)return console.warn("cannot use fit: manual with type: mesh"),null;const u=h(s,c),d=new Ammo.btVector3,p=new Ammo.btVector3,f=new Ammo.btVector3,v=new Ammo.btTriangleMesh(!0,!1);l(s,c,((n,o)=>{const s=n.attributes.position.array;if(n.index)for(let r=0;r<n.index.count;r+=3){const a=3*n.index.array[r],l=3*n.index.array[r+1],h=3*n.index.array[r+2];t.set(s[a],s[a+1],s[a+2]).applyMatrix4(o),e.set(s[l],s[l+1],s[l+2]).applyMatrix4(o),i.set(s[h],s[h+1],s[h+2]).applyMatrix4(o),d.setValue(t.x,t.y,t.z),p.setValue(e.x,e.y,e.z),f.setValue(i.x,i.y,i.z),v.addTriangle(d,p,f,!1)}else for(let n=0;n<s.length;n+=9)t.set(s[n+0],s[n+1],s[n+2]).applyMatrix4(o),e.set(s[n+3],s[n+4],s[n+5]).applyMatrix4(o),i.set(s[n+6],s[n+7],s[n+8]).applyMatrix4(o),d.setValue(t.x,t.y,t.z),p.setValue(e.x,e.y,e.z),f.setValue(i.x,i.y,i.z),v.addTriangle(d,p,f,!1)}));const m=new Ammo.btVector3(u.x,u.y,u.z);v.setScaling(m),Ammo.destroy(m);const y=new Ammo.btBvhTriangleMeshShape(v,!0,!0);return y.resources=[v],Ammo.destroy(d),Ammo.destroy(p),Ammo.destroy(f),a(y,c),y}}(),i.createHeightfieldTerrainShape=function(t,e){if(r(e),e.fit===o.ALL)return console.warn("cannot use fit: all with type: heightfield"),null;const i=e.heightfieldDistance||1,n=e.heightfieldData||[],s=e.heightScale||0,l=e.hasOwnProperty("upAxis")?e.upAxis:1,h="short"===e.heightDataType?Ammo.PHY_SHORT:Ammo.PHY_FLOAT,c=!e.hasOwnProperty("flipQuadEdges")||e.flipQuadEdges,u=n.length,d=u>0?n[0].length:0,p=Ammo._malloc(u*d*4),f=p/4;let v=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,y=0;for(let t=0;t<u;t++)for(let e=0;e<d;e++){const i=n[t][e];Ammo.HEAPF32[f+y]=i,y++,v=Math.min(v,i),m=Math.max(m,i)}const g=new Ammo.btHeightfieldTerrainShape(d,u,p,s,v,m,l,h,c),w=new Ammo.btVector3(i,1,i);return g.setLocalScaling(w),Ammo.destroy(w),g.heightfieldData=p,a(g,e),g};const a=function(t,e,i){t.type=e.type,t.setMargin(e.margin),t.destroy=()=>{for(let e of t.resources||[])Ammo.destroy(e);t.heightfieldData&&Ammo._free(t.heightfieldData),Ammo.destroy(t)};const n=new Ammo.btTransform,o=new Ammo.btQuaternion;if(n.setIdentity(),n.getOrigin().setValue(e.offset.x,e.offset.y,e.offset.z),o.setValue(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w),n.setRotation(o),Ammo.destroy(o),i){const e=new Ammo.btVector3(i.x,i.y,i.z);t.setLocalScaling(e),Ammo.destroy(e)}t.localTransform=n},l=function(){const t=new THREE.Matrix4,e=new THREE.Matrix4,i=new THREE.BufferGeometry;return function(n,o,r){e.getInverse(n.matrixWorld),n.traverse((a=>{!a.isMesh||THREE.Sky&&a.__proto__==THREE.Sky.prototype||!(o.includeInvisible||a.el&&a.el.object3D.visible||a.visible)||(a===n?t.identity():(s&&a.updateMatrices(),t.multiplyMatrices(e,a.matrixWorld)),r(a.geometry.isBufferGeometry?a.geometry:i.fromGeometry(a.geometry),t))}))}}(),h=function(t,e){const i=new THREE.Vector3(1,1,1);return e.fit===o.ALL&&i.setFromMatrixScale(t.matrixWorld),i},c=function(){const t=new THREE.Vector3,e=new THREE.Vector3;return function(i,n,o){let s=0,{x:r,y:a,z:h}=o.getCenter(e);return l(i,n,((e,i)=>{const n=e.attributes.position.array;for(let e=0;e<n.length;e+=3){t.set(n[e],n[e+1],n[e+2]).applyMatrix4(i);const o=r-t.x,l=a-t.y,c=h-t.z;s=Math.max(s,o*o+l*l+c*c)}})),Math.sqrt(s)}}(),u=function(t,e,i,n){return(new THREE.Vector3).subVectors(e.max,e.min).multiplyScalar(.5).clampScalar(i,n)},d=function(){const t=new THREE.Vector3;return function(e,i){const n=new THREE.Box3;let o=1/0,s=1/0,r=1/0,a=-1/0,h=-1/0,c=-1/0;return n.min.set(0,0,0),n.max.set(0,0,0),l(e,i,((e,i)=>{const n=e.attributes.position.array;for(let e=0;e<n.length;e+=3)t.set(n[e],n[e+1],n[e+2]).applyMatrix4(i),t.x<o&&(o=t.x),t.y<s&&(s=t.y),t.z<r&&(r=t.z),t.x>a&&(a=t.x),t.y>h&&(h=t.y),t.z>c&&(c=t.z)})),n.min.set(o,s,r),n.max.set(a,h,c),n}}()},{}],6:[function(t,e,i){(function(e){var n=t("cannon-es"),o="undefined"!=typeof window?window.THREE:void 0!==e?e.THREE:null,s=function(){var t,e,i,n,s=new o.Vector3;function r(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new c,this.unassigned=new c,this.vertices=[]}function a(){this.normal=new o.Vector3,this.midpoint=new o.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}function l(t,e){this.vertex=t,this.prev=null,this.next=null,this.twin=null,this.face=e}function h(t){this.point=t,this.prev=null,this.next=null,this.face=null}function c(){this.head=null,this.tail=null}return Object.assign(r.prototype,{setFromPoints:function(t){!0!==Array.isArray(t)&&console.error("THREE.ConvexHull: Points parameter is not an array."),t.length<4&&console.error("THREE.ConvexHull: The algorithm needs at least four points."),this.makeEmpty();for(var e=0,i=t.length;e<i;e++)this.vertices.push(new h(t[e]));return this.compute(),this},setFromObject:function(t){var e=[];return t.updateMatrixWorld(!0),t.traverse((function(t){var i,n,s,r=t.geometry;if(void 0!==r)if(r.isGeometry){var a=r.vertices;for(i=0,n=a.length;i<n;i++)(s=a[i].clone()).applyMatrix4(t.matrixWorld),e.push(s)}else if(r.isBufferGeometry){var l=r.attributes.position;if(void 0!==l)for(i=0,n=l.count;i<n;i++)(s=new o.Vector3).fromBufferAttribute(l,i).applyMatrix4(t.matrixWorld),e.push(s)}})),this.setFromPoints(e)},containsPoint:function(t){for(var e=this.faces,i=0,n=e.length;i<n;i++)if(e[i].distanceToPoint(t)>this.tolerance)return!1;return!0},intersectRay:function(t,e){for(var i=this.faces,n=-1/0,o=1/0,s=0,r=i.length;s<r;s++){var a=i[s],l=a.distanceToPoint(t.origin),h=a.normal.dot(t.direction);if(l>0&&h>=0)return null;var c=0!==h?-l/h:0;if(!(c<=0)&&(h>0?o=Math.min(c,o):n=Math.max(c,n),n>o))return null}return t.at(-1/0!==n?n:o,e),e},intersectsRay:function(t){return null!==this.intersectRay(t,s)},makeEmpty:function(){return this.faces=[],this.vertices=[],this},addVertexToFace:function(t,e){return t.face=e,null===e.outside?this.assigned.append(t):this.assigned.insertBefore(e.outside,t),e.outside=t,this},removeVertexFromFace:function(t,e){return t===e.outside&&(e.outside=null!==t.next&&t.next.face===e?t.next:null),this.assigned.remove(t),this},removeAllVerticesFromFace:function(t){if(null!==t.outside){for(var e=t.outside,i=t.outside;null!==i.next&&i.next.face===t;)i=i.next;return this.assigned.removeSubList(e,i),e.prev=i.next=null,t.outside=null,e}},deleteFaceVertices:function(t,e){var i=this.removeAllVerticesFromFace(t);if(void 0!==i)if(void 0===e)this.unassigned.appendChain(i);else{var n=i;do{var o=n.next;e.distanceToPoint(n.point)>this.tolerance?this.addVertexToFace(n,e):this.unassigned.append(n),n=o}while(null!==n)}return this},resolveUnassignedPoints:function(t){if(!1===this.unassigned.isEmpty()){var e=this.unassigned.first();do{for(var i=e.next,n=this.tolerance,o=null,s=0;s<t.length;s++){var r=t[s];if(0===r.mark){var a=r.distanceToPoint(e.point);if(a>n&&(n=a,o=r),n>1e3*this.tolerance)break}}null!==o&&this.addVertexToFace(e,o),e=i}while(null!==e)}return this},computeExtremes:function(){var t,e,i,n=new o.Vector3,s=new o.Vector3,r=[],a=[];for(t=0;t<3;t++)r[t]=a[t]=this.vertices[0];for(n.copy(this.vertices[0].point),s.copy(this.vertices[0].point),t=0,e=this.vertices.length;t<e;t++){var l=this.vertices[t],h=l.point;for(i=0;i<3;i++)h.getComponent(i)<n.getComponent(i)&&(n.setComponent(i,h.getComponent(i)),r[i]=l);for(i=0;i<3;i++)h.getComponent(i)>s.getComponent(i)&&(s.setComponent(i,h.getComponent(i)),a[i]=l)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(n.x),Math.abs(s.x))+Math.max(Math.abs(n.y),Math.abs(s.y))+Math.max(Math.abs(n.z),Math.abs(s.z))),{min:r,max:a}},computeInitialHull:function(){void 0===t&&(t=new o.Line3,e=new o.Plane,i=new o.Vector3);var n,s,r,l,h,c,u,d,p,f=this.vertices,v=this.computeExtremes(),m=v.min,y=v.max,g=0,w=0;for(c=0;c<3;c++)(p=y[c].point.getComponent(c)-m[c].point.getComponent(c))>g&&(g=p,w=c);for(g=0,t.set((s=m[w]).point,(r=y[w]).point),c=0,u=this.vertices.length;c<u;c++)(n=f[c])!==s&&n!==r&&(t.closestPointToPoint(n.point,!0,i),(p=i.distanceToSquared(n.point))>g&&(g=p,l=n));for(g=-1,e.setFromCoplanarPoints(s.point,r.point,l.point),c=0,u=this.vertices.length;c<u;c++)(n=f[c])!==s&&n!==r&&n!==l&&(p=Math.abs(e.distanceToPoint(n.point)))>g&&(g=p,h=n);var b=[];if(e.distanceToPoint(h.point)<0)for(b.push(a.create(s,r,l),a.create(h,r,s),a.create(h,l,r),a.create(h,s,l)),c=0;c<3;c++)d=(c+1)%3,b[c+1].getEdge(2).setTwin(b[0].getEdge(d)),b[c+1].getEdge(1).setTwin(b[d+1].getEdge(0));else for(b.push(a.create(s,l,r),a.create(h,s,r),a.create(h,r,l),a.create(h,l,s)),c=0;c<3;c++)d=(c+1)%3,b[c+1].getEdge(2).setTwin(b[0].getEdge((3-c)%3)),b[c+1].getEdge(0).setTwin(b[d+1].getEdge(1));for(c=0;c<4;c++)this.faces.push(b[c]);for(c=0,u=f.length;c<u;c++)if((n=f[c])!==s&&n!==r&&n!==l&&n!==h){g=this.tolerance;var x=null;for(d=0;d<4;d++)(p=this.faces[d].distanceToPoint(n.point))>g&&(g=p,x=this.faces[d]);null!==x&&this.addVertexToFace(n,x)}return this},reindexFaces:function(){for(var t=[],e=0;e<this.faces.length;e++){var i=this.faces[e];0===i.mark&&t.push(i)}return this.faces=t,this},nextVertexToAdd:function(){if(!1===this.assigned.isEmpty()){var t,e=0,i=this.assigned.first().face,n=i.outside;do{var o=i.distanceToPoint(n.point);o>e&&(e=o,t=n),n=n.next}while(null!==n&&n.face===i);return t}},computeHorizon:function(t,e,i,n){var o;this.deleteFaceVertices(i),i.mark=1,o=null===e?e=i.getEdge(0):e.next;do{var s=o.twin,r=s.face;0===r.mark&&(r.distanceToPoint(t)>this.tolerance?this.computeHorizon(t,s,r,n):n.push(o)),o=o.next}while(o!==e);return this},addAdjoiningFace:function(t,e){var i=a.create(t,e.tail(),e.head());return this.faces.push(i),i.getEdge(-1).setTwin(e.twin),i.getEdge(0)},addNewFaces:function(t,e){this.newFaces=[];for(var i=null,n=null,o=0;o<e.length;o++){var s=this.addAdjoiningFace(t,e[o]);null===i?i=s:s.next.setTwin(n),this.newFaces.push(s.face),n=s}return i.next.setTwin(n),this},addVertexToHull:function(t){var e=[];return this.unassigned.clear(),this.removeVertexFromFace(t,t.face),this.computeHorizon(t.point,null,t.face,e),this.addNewFaces(t,e),this.resolveUnassignedPoints(this.newFaces),this},cleanup:function(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this},compute:function(){var t;for(this.computeInitialHull();void 0!==(t=this.nextVertexToAdd());)this.addVertexToHull(t);return this.reindexFaces(),this.cleanup(),this}}),Object.assign(a,{create:function(t,e,i){var n=new a,o=new l(t,n),s=new l(e,n),r=new l(i,n);return o.next=r.prev=s,s.next=o.prev=r,r.next=s.prev=o,n.edge=o,n.compute()}}),Object.assign(a.prototype,{getEdge:function(t){for(var e=this.edge;t>0;)e=e.next,t--;for(;t<0;)e=e.prev,t++;return e},compute:function(){void 0===n&&(n=new o.Triangle);var t=this.edge.tail(),e=this.edge.head(),i=this.edge.next.head();return n.set(t.point,e.point,i.point),n.getNormal(this.normal),n.getMidpoint(this.midpoint),this.area=n.getArea(),this.constant=this.normal.dot(this.midpoint),this},distanceToPoint:function(t){return this.normal.dot(t)-this.constant}}),Object.assign(l.prototype,{head:function(){return this.vertex},tail:function(){return this.prev?this.prev.vertex:null},length:function(){var t=this.head(),e=this.tail();return null!==e?e.point.distanceTo(t.point):-1},lengthSquared:function(){var t=this.head(),e=this.tail();return null!==e?e.point.distanceToSquared(t.point):-1},setTwin:function(t){return this.twin=t,t.twin=this,this}}),Object.assign(c.prototype,{first:function(){return this.head},last:function(){return this.tail},clear:function(){return this.head=this.tail=null,this},insertBefore:function(t,e){return e.prev=t.prev,e.next=t,null===e.prev?this.head=e:e.prev.next=e,t.prev=e,this},insertAfter:function(t,e){return e.prev=t,e.next=t.next,null===e.next?this.tail=e:e.next.prev=e,t.next=e,this},append:function(t){return null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail,t.next=null,this.tail=t,this},appendChain:function(t){for(null===this.head?this.head=t:this.tail.next=t,t.prev=this.tail;null!==t.next;)t=t.next;return this.tail=t,this},remove:function(t){return null===t.prev?this.head=t.next:t.prev.next=t.next,null===t.next?this.tail=t.prev:t.next.prev=t.prev,this},removeSubList:function(t,e){return null===t.prev?this.head=e.next:t.prev.next=e.next,null===e.next?this.tail=t.prev:e.next.prev=t.prev,this},isEmpty:function(){return null===this.head}}),r}(),r=Math.PI/2,a={BOX:"Box",CYLINDER:"Cylinder",SPHERE:"Sphere",HULL:"ConvexPolyhedron",MESH:"Trimesh"},l=function(t,e){var i;if((e=e||{}).type===a.BOX)return c(t);if(e.type===a.CYLINDER)return function(t,e){var i=["x","y","z"],s=e.cylinderAxis||"y",a=i.splice(i.indexOf(s),1)&&i,l=(new o.Box3).setFromObject(t);if(!isFinite(l.min.lengthSq()))return null;var h=l.max[s]-l.min[s],c=.5*Math.max(l.max[a[0]]-l.min[a[0]],l.max[a[1]]-l.min[a[1]]),u=new n.Cylinder(c,c,h,12);return u._type=n.Shape.types.CYLINDER,u.radiusTop=c,u.radiusBottom=c,u.height=h,u.numSegments=12,u.orientation=new n.Quaternion,u.orientation.setFromEuler("y"===s?r:0,"z"===s?r:0,0,"XYZ").normalize(),u}(t,e);if(e.type===a.SPHERE)return function(t,e){if(e.sphereRadius)return new n.Sphere(e.sphereRadius);var i=u(t);return i?(i.computeBoundingSphere(),new n.Sphere(i.boundingSphere.radius)):null}(t,e);if(e.type===a.HULL)return function(t){var e=u(t);if(!e||!e.vertices.length)return null;for(var i=0;i<e.vertices.length;i++)e.vertices[i].x+=1e-4*(Math.random()-.5),e.vertices[i].y+=1e-4*(Math.random()-.5),e.vertices[i].z+=1e-4*(Math.random()-.5);var r=(new s).setFromObject(new o.Mesh(e)).faces,a=[],l=[];for(i=0;i<r.length;i++){var h=r[i],c=h.edge;do{var d=c.head().point;a.push(new n.Vec3(d.x,d.y,d.z)),l.push(new n.Vec3(h.normal.x,h.normal.y,h.normal.z)),c=c.next}while(c!==h.edge)}return new n.ConvexPolyhedron({vertices:a,normals:l})}(t);if(e.type===a.MESH)return(i=u(t))?function(t){var e=d(i);if(!e.length)return null;var o=Object.keys(e).map(Number);return new n.Trimesh(e,o)}():null;if(e.type)throw new Error('[CANNON.threeToCannon] Invalid type "%s".',e.type);if(!(i=u(t)))return null;switch(i.metadata?i.metadata.type:i.type){case"BoxGeometry":case"BoxBufferGeometry":return h(i);case"CylinderGeometry":case"CylinderBufferGeometry":return function(t){var e=t.metadata?t.metadata.parameters:t.parameters,i=new n.Cylinder(e.radiusTop,e.radiusBottom,e.height,e.radialSegments);return i._type=n.Shape.types.CYLINDER,i.radiusTop=e.radiusTop,i.radiusBottom=e.radiusBottom,i.height=e.height,i.numSegments=e.radialSegments,i.orientation=new n.Quaternion,i.orientation.setFromEuler(o.Math.degToRad(-90),0,0,"XYZ").normalize(),i}(i);case"PlaneGeometry":case"PlaneBufferGeometry":return function(t){t.computeBoundingBox();var e=t.boundingBox;return new n.Box(new n.Vec3((e.max.x-e.min.x)/2||.1,(e.max.y-e.min.y)/2||.1,(e.max.z-e.min.z)/2||.1))}(i);case"SphereGeometry":case"SphereBufferGeometry":return function(t){return new n.Sphere((t.metadata?t.metadata.parameters:t.parameters).radius)}(i);case"TubeGeometry":case"Geometry":case"BufferGeometry":return c(t);default:return console.warn('Unrecognized geometry: "%s". Using bounding box as shape.',i.type),h(i)}};function h(t){if(!d(t).length)return null;t.computeBoundingBox();var e=t.boundingBox;return new n.Box(new n.Vec3((e.max.x-e.min.x)/2,(e.max.y-e.min.y)/2,(e.max.z-e.min.z)/2))}function c(t){var e=t.clone();e.quaternion.set(0,0,0,1),e.updateMatrixWorld();var i=(new o.Box3).setFromObject(e);if(!isFinite(i.min.lengthSq()))return null;var s=new n.Box(new n.Vec3((i.max.x-i.min.x)/2,(i.max.y-i.min.y)/2,(i.max.z-i.min.z)/2)),r=i.translate(e.position.negate()).getCenter(new o.Vector3);return r.lengthSq()&&(s.offset=r),s}function u(t){var e,i=function(t){var e=[];return t.traverse((function(t){"Mesh"===t.type&&e.push(t)})),e}(t),n=new o.Geometry,s=new o.Geometry;if(0===i.length)return null;if(1===i.length){var r=new o.Vector3,a=new o.Quaternion,l=new o.Vector3;return i[0].geometry.isBufferGeometry?i[0].geometry.attributes.position&&i[0].geometry.attributes.position.itemSize>2&&n.fromBufferGeometry(i[0].geometry):n=i[0].geometry.clone(),n.metadata=i[0].geometry.metadata,i[0].updateMatrixWorld(),i[0].matrixWorld.decompose(r,a,l),n.scale(l.x,l.y,l.z)}for(;e=i.pop();)if(e.updateMatrixWorld(),e.geometry.isBufferGeometry){if(e.geometry.attributes.position&&e.geometry.attributes.position.itemSize>2){var h=new o.Geometry;h.fromBufferGeometry(e.geometry),s.merge(h,e.matrixWorld),h.dispose()}}else s.merge(e.geometry,e.matrixWorld);var c=new o.Matrix4;return c.scale(t.scale),s.applyMatrix(c),s}function d(t){return t.attributes||(t=(new o.BufferGeometry).fromGeometry(t)),(t.attributes.position||{}).array||[]}l.Type=a,i.threeToCannon=l}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"cannon-es":4}],7:[function(t,e,i){var n=arguments[3],o=arguments[4],s=arguments[5],r=JSON.stringify;e.exports=function(t,e){for(var i,a=Object.keys(s),l=0,h=a.length;l<h;l++){var c=a[l],u=s[c].exports;if(u===t||u&&u.default===t){i=c;break}}if(!i){i=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var d={};for(l=0,h=a.length;l<h;l++)d[c=a[l]]=c;o[i]=[Function(["require","module","exports"],"("+t+")(self)"),d]}var p=Math.floor(Math.pow(16,8)*Math.random()).toString(16),f={};f[i]=i,o[p]=[Function(["require"],"var f = require("+r(i)+");(f.default ? f.default : f)(self);"),f];var v={};!function t(e){for(var i in v[e]=!0,o[e][1]){var n=o[e][1][i];v[n]||t(n)}}(p);var m="("+n+")({"+Object.keys(v).map((function(t){return r(t)+":["+o[t][0]+","+r(o[t][1])+"]"})).join(",")+"},{},["+r(p)+"])",y=window.URL||window.webkitURL||window.mozURL||window.msURL,g=new Blob([m],{type:"text/javascript"});if(e&&e.bare)return g;var w=y.createObjectURL(g),b=new Worker(w);return b.objectURL=w,b}},{}],8:[function(t,e,i){const n=t("../constants").CONSTRAINT;e.exports=AFRAME.registerComponent("ammo-constraint",{multiple:!0,schema:{type:{default:n.LOCK,oneOf:[n.LOCK,n.FIXED,n.SPRING,n.SLIDER,n.HINGE,n.CONE_TWIST,n.POINT_TO_POINT]},target:{type:"selector"},pivot:{type:"vec3"},targetPivot:{type:"vec3"},axis:{type:"vec3",default:{x:0,y:0,z:1}},targetAxis:{type:"vec3",default:{x:0,y:0,z:1}}},init:function(){this.system=this.el.sceneEl.systems.physics,this.constraint=null},remove:function(){this.constraint&&(this.system.removeConstraint(this.constraint),this.constraint=null)},update:function(){const t=this.el,e=this.data;this.remove(),t.body&&e.target.body?(this.constraint=this.createConstraint(),this.system.addConstraint(this.constraint)):(t.body?e.target:t).addEventListener("body-loaded",this.update.bind(this,{}),{once:!0})},createConstraint:function(){let t;const e=this.data,i=this.el.body,o=e.target.body,s=i.getCenterOfMassTransform().invert().op_mul(o.getWorldTransform()),r=new Ammo.btTransform;switch(r.setIdentity(),e.type){case n.LOCK:{t=new Ammo.btGeneric6DofConstraint(i,o,s,r,!0);const e=new Ammo.btVector3(0,0,0);t.setLinearLowerLimit(e),t.setLinearUpperLimit(e),t.setAngularLowerLimit(e),t.setAngularUpperLimit(e),Ammo.destroy(e);break}case n.FIXED:s.setRotation(i.getWorldTransform().getRotation()),r.setRotation(o.getWorldTransform().getRotation()),t=new Ammo.btFixedConstraint(i,o,s,r);break;case n.SPRING:t=new Ammo.btGeneric6DofSpringConstraint(i,o,s,r,!0);break;case n.SLIDER:(t=new Ammo.btSliderConstraint(i,o,s,r,!0)).setLowerLinLimit(-1),t.setUpperLinLimit(1);break;case n.HINGE:{const n=new Ammo.btVector3(e.pivot.x,e.pivot.y,e.pivot.z),s=new Ammo.btVector3(e.targetPivot.x,e.targetPivot.y,e.targetPivot.z),r=new Ammo.btVector3(e.axis.x,e.axis.y,e.axis.z),a=new Ammo.btVector3(e.targetAxis.x,e.targetAxis.y,e.targetAxis.z);t=new Ammo.btHingeConstraint(i,o,n,s,r,a,!0),Ammo.destroy(n),Ammo.destroy(s),Ammo.destroy(r),Ammo.destroy(a);break}case n.CONE_TWIST:{const n=new Ammo.btTransform;n.setIdentity(),n.getOrigin().setValue(e.pivot.x,e.pivot.y,e.pivot.z);const s=new Ammo.btTransform;s.setIdentity(),s.getOrigin().setValue(e.targetPivot.x,e.targetPivot.y,e.targetPivot.z),t=new Ammo.btConeTwistConstraint(i,o,n,s),Ammo.destroy(n),Ammo.destroy(s);break}case n.POINT_TO_POINT:{const n=new Ammo.btVector3(e.pivot.x,e.pivot.y,e.pivot.z),s=new Ammo.btVector3(e.targetPivot.x,e.targetPivot.y,e.targetPivot.z);t=new Ammo.btPoint2PointConstraint(i,o,n,s),Ammo.destroy(n),Ammo.destroy(s);break}default:throw new Error("[constraint] Unexpected type: "+e.type)}return Ammo.destroy(s),Ammo.destroy(r),t}})},{"../constants":19}],9:[function(t,e,i){t("ammo-debug-drawer");const n=t("three-to-ammo"),o=t("../../constants"),s=o.ACTIVATION_STATE,r=o.COLLISION_FLAG,a=o.SHAPE,l=o.TYPE,h=(o.FIT,[s.ACTIVE_TAG,s.ISLAND_SLEEPING,s.WANTS_DEACTIVATION,s.DISABLE_DEACTIVATION,s.DISABLE_SIMULATION]);function c(t,e,i){return Math.abs(e.x-i.x)<t&&Math.abs(e.y-i.y)<t&&Math.abs(e.z-i.z)<t}function u(t,e,i){return Math.abs(e.x()-i.x())<t&&Math.abs(e.y()-i.y())<t&&Math.abs(e.z()-i.z())<t}let d={schema:{loadedEvent:{default:""},mass:{default:1},gravity:{type:"vec3",default:{x:0,y:-9.8,z:0}},linearDamping:{default:.01},angularDamping:{default:.01},linearSleepingThreshold:{default:1.6},angularSleepingThreshold:{default:2.5},angularFactor:{type:"vec3",default:{x:1,y:1,z:1}},activationState:{default:s.ACTIVE_TAG,oneOf:h},type:{default:"dynamic",oneOf:[l.STATIC,l.DYNAMIC,l.KINEMATIC]},emitCollisionEvents:{default:!1},disableCollision:{default:!1},collisionFilterGroup:{default:1},collisionFilterMask:{default:1},scaleAutoUpdate:{default:!0}},init:function(){this.system=this.el.sceneEl.systems.physics,this.shapeComponents=[],""===this.data.loadedEvent?this.loadedEventFired=!0:this.el.addEventListener(this.data.loadedEvent,(()=>{this.loadedEventFired=!0}),{once:!0}),this.system.initialized&&this.loadedEventFired&&this.initBody()},initBody:function(){const t=new THREE.Vector3,e=new THREE.Quaternion;return new THREE.Box3,function(){const i=this.el,n=this.data;this.localScaling=new Ammo.btVector3;const o=this.el.object3D;o.getWorldPosition(t),o.getWorldQuaternion(e),this.prevScale=new THREE.Vector3(1,1,1),this.prevNumChildShapes=0,this.msTransform=new Ammo.btTransform,this.msTransform.setIdentity(),this.rotation=new Ammo.btQuaternion(e.x,e.y,e.z,e.w),this.msTransform.getOrigin().setValue(t.x,t.y,t.z),this.msTransform.setRotation(this.rotation),this.motionState=new Ammo.btDefaultMotionState(this.msTransform),this.localInertia=new Ammo.btVector3(0,0,0),this.compoundShape=new Ammo.btCompoundShape(!0),this.rbInfo=new Ammo.btRigidBodyConstructionInfo(n.mass,this.motionState,this.compoundShape,this.localInertia),this.body=new Ammo.btRigidBody(this.rbInfo),this.body.setActivationState(h.indexOf(n.activationState)+1),this.body.setSleepingThresholds(n.linearSleepingThreshold,n.angularSleepingThreshold),this.body.setDamping(n.linearDamping,n.angularDamping);const s=new Ammo.btVector3(n.angularFactor.x,n.angularFactor.y,n.angularFactor.z);this.body.setAngularFactor(s),Ammo.destroy(s);const r=new Ammo.btVector3(n.gravity.x,n.gravity.y,n.gravity.z);u(.001,r,this.system.driver.physicsWorld.getGravity())||(this.body.setGravity(r),this.body.setFlags(1)),Ammo.destroy(r),this.updateCollisionFlags(),this.el.body=this.body,this.body.el=i,this.isLoaded=!0,this.el.emit("body-loaded",{body:this.el.body}),this._addToSystem()}}(),tick:function(){this.system.initialized&&!this.isLoaded&&this.loadedEventFired&&this.initBody()},_updateShapes:function(){const t=[a.HULL,a.HACD,a.VHACD];return function(){let e=!1;const i=this.el.object3D;if(this.data.scaleAutoUpdate&&this.prevScale&&!c(.001,i.scale,this.prevScale)&&(this.prevScale.copy(i.scale),e=!0,this.localScaling.setValue(this.prevScale.x,this.prevScale.y,this.prevScale.z),this.compoundShape.setLocalScaling(this.localScaling)),this.shapeComponentsChanged){this.shapeComponentsChanged=!1,e=!0;for(let t=0;t<this.shapeComponents.length;t++){const e=this.shapeComponents[t];0===e.getShapes().length&&this._createCollisionShape(e);const i=e.getShapes();for(let t=0;t<i.length;t++){const e=i[t];e.added||(this.compoundShape.addChildShape(e.localTransform,e),e.added=!0)}}this.data.type===l.DYNAMIC&&this.updateMass(),this.system.driver.updateBody(this.body)}if(this.system.debug&&(e||!this.polyHedralFeaturesInitialized)){for(let e=0;e<this.shapeComponents.length;e++){const i=this.shapeComponents[e].getShapes();for(let e=0;e<i.length;e++){const n=i[e];-1!==t.indexOf(n.type)&&n.initializePolyhedralFeatures(0)}}this.polyHedralFeaturesInitialized=!0}}}(),_createCollisionShape:function(t){const e=t.data,i=n.createCollisionShapes(t.getMesh(),e);t.addShapes(i)},play:function(){this.isLoaded&&this._addToSystem()},_addToSystem:function(){this.addedToSystem||(this.system.addBody(this.body,this.data.collisionFilterGroup,this.data.collisionFilterMask),this.data.emitCollisionEvents&&this.system.driver.addEventListener(this.body),this.system.addComponent(this),this.addedToSystem=!0)},pause:function(){this.addedToSystem&&(this.system.removeComponent(this),this.system.removeBody(this.body),this.addedToSystem=!1)},update:function(t){if(this.isLoaded){if(!this.hasUpdated)return void(this.hasUpdated=!0);const e=this.data;if(t.type===e.type&&t.disableCollision===e.disableCollision||this.updateCollisionFlags(),t.activationState!==e.activationState&&(this.body.forceActivationState(h.indexOf(e.activationState)+1),e.activationState===s.ACTIVE_TAG&&this.body.activate(!0)),t.collisionFilterGroup!==e.collisionFilterGroup||t.collisionFilterMask!==e.collisionFilterMask){const t=this.body.getBroadphaseProxy();t.set_m_collisionFilterGroup(e.collisionFilterGroup),t.set_m_collisionFilterMask(e.collisionFilterMask),this.system.driver.broadphase.getOverlappingPairCache().removeOverlappingPairsContainingProxy(t,this.system.driver.dispatcher)}if(t.linearDamping==e.linearDamping&&t.angularDamping==e.angularDamping||this.body.setDamping(e.linearDamping,e.angularDamping),!c(.001,t.gravity,e.gravity)){const t=new Ammo.btVector3(e.gravity.x,e.gravity.y,e.gravity.z);u(.001,t,this.system.driver.physicsWorld.getGravity())?this.body.setFlags(0):this.body.setFlags(1),this.body.setGravity(t),Ammo.destroy(t)}if(t.linearSleepingThreshold==e.linearSleepingThreshold&&t.angularSleepingThreshold==e.angularSleepingThreshold||this.body.setSleepingThresholds(e.linearSleepingThreshold,e.angularSleepingThreshold),!c(.001,t.angularFactor,e.angularFactor)){const t=new Ammo.btVector3(e.angularFactor.x,e.angularFactor.y,e.angularFactor.z);this.body.setAngularFactor(t),Ammo.destroy(t)}}},remove:function(){this.triMesh&&Ammo.destroy(this.triMesh),this.localScaling&&Ammo.destroy(this.localScaling),this.compoundShape&&Ammo.destroy(this.compoundShape),this.body&&(Ammo.destroy(this.body),delete this.body),Ammo.destroy(this.rbInfo),Ammo.destroy(this.msTransform),Ammo.destroy(this.motionState),Ammo.destroy(this.localInertia),Ammo.destroy(this.rotation)},beforeStep:function(){this._updateShapes(),this.data.type!==l.DYNAMIC&&this.syncToPhysics()},step:function(){this.data.type===l.DYNAMIC&&this.syncFromPhysics()},syncToPhysics:function(){const t=new THREE.Quaternion,e=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3;return function(){const o=this.el,s=o.parentEl;if(!this.body)return;this.motionState.getWorldTransform(this.msTransform),s.isScene?(e.copy(o.object3D.position),t.copy(o.object3D.quaternion)):(o.object3D.getWorldPosition(e),o.object3D.getWorldQuaternion(t));const r=this.msTransform.getOrigin();n.set(r.x(),r.y(),r.z());const a=this.msTransform.getRotation();i.set(a.x(),a.y(),a.z(),a.w()),c(.001,e,n)&&function(t,e,i){return Math.abs(e.x-i.x)<t&&Math.abs(e.y-i.y)<t&&Math.abs(e.z-i.z)<t&&Math.abs(e.w-i.w)<t||Math.abs(e.x+i.x)<t&&Math.abs(e.y+i.y)<t&&Math.abs(e.z+i.z)<t&&Math.abs(e.w+i.w)<t}(.001,t,i)||(this.body.isActive()||this.body.activate(!0),this.msTransform.getOrigin().setValue(e.x,e.y,e.z),this.rotation.setValue(t.x,t.y,t.z,t.w),this.msTransform.setRotation(this.rotation),this.motionState.setWorldTransform(this.msTransform),this.data.type===l.STATIC&&this.body.setCenterOfMassTransform(this.msTransform))}}(),syncFromPhysics:function(){const t=new THREE.Vector3,e=new THREE.Quaternion,i=new THREE.Quaternion;return function(){this.motionState.getWorldTransform(this.msTransform);const n=this.msTransform.getOrigin(),o=this.msTransform.getRotation(),s=this.el,r=s.parentEl;this.body&&r&&(r.isScene?(s.object3D.position.set(n.x(),n.y(),n.z()),s.object3D.quaternion.set(o.x(),o.y(),o.z(),o.w())):(e.set(o.x(),o.y(),o.z(),o.w()),r.object3D.getWorldQuaternion(i),e.multiply(i.invert()),s.object3D.quaternion.copy(e),t.set(n.x(),n.y(),n.z()),r.object3D.worldToLocal(t),s.object3D.position.copy(t)))}}(),addShapeComponent:function(t){t.data.type!==a.MESH||this.data.type===l.STATIC?(this.shapeComponents.push(t),this.shapeComponentsChanged=!0):console.warn("non-static mesh colliders not supported")},removeShapeComponent:function(t){const e=this.shapeComponents.indexOf(t);if(this.compoundShape&&-1!==e&&this.body){const n=t.getShapes();for(var i=0;i<n.length;i++)this.compoundShape.removeChildShape(n[i]);this.shapeComponentsChanged=!0,this.shapeComponents.splice(e,1)}},updateMass:function(){const t=this.body.getCollisionShape(),e=this.data.type===l.DYNAMIC?this.data.mass:0;t.calculateLocalInertia(e,this.localInertia),this.body.setMassProps(e,this.localInertia),this.body.updateInertiaTensor()},updateCollisionFlags:function(){let t=this.data.disableCollision?4:0;switch(this.data.type){case l.STATIC:t|=r.STATIC_OBJECT;break;case l.KINEMATIC:t|=r.KINEMATIC_OBJECT;break;default:this.body.applyGravity()}this.body.setCollisionFlags(t),this.updateMass(),this.system.driver.updateBody(this.body)},getVelocity:function(){return this.body.getLinearVelocity()}};e.exports.definition=d,e.exports.Component=AFRAME.registerComponent("ammo-body",d)},{"../../constants":19,"ammo-debug-drawer":3,"three-to-ammo":5}],10:[function(t,e,i){var n=t("cannon-es"),o=t("three-to-cannon").threeToCannon;t("../../../lib/CANNON-shape2mesh");var s,r,a={dependencies:["velocity"],schema:{mass:{default:5,if:{type:"dynamic"}},linearDamping:{default:.01,if:{type:"dynamic"}},angularDamping:{default:.01,if:{type:"dynamic"}},shape:{default:"auto",oneOf:["auto","box","cylinder","sphere","hull","mesh","none"]},cylinderAxis:{default:"y",oneOf:["x","y","z"]},sphereRadius:{default:NaN},type:{default:"dynamic",oneOf:["static","dynamic"]}},init:function(){this.system=this.el.sceneEl.systems.physics,this.el.sceneEl.hasLoaded?this.initBody():this.el.sceneEl.addEventListener("loaded",this.initBody.bind(this))},initBody:function(){var t=this.el,e=this.data,i=this.el.object3D,s=i.position,r=i.quaternion;if(this.body=new n.Body({mass:"static"===e.type?0:e.mass||0,material:this.system.getMaterial("defaultMaterial"),position:new n.Vec3(s.x,s.y,s.z),quaternion:new n.Quaternion(r.x,r.y,r.z,r.w),linearDamping:e.linearDamping,angularDamping:e.angularDamping,type:"dynamic"===e.type?n.Body.DYNAMIC:n.Body.STATIC}),this.el.object3D.updateMatrixWorld(!0),"none"!==e.shape){var a="auto"===e.shape?void 0:AFRAME.utils.extend({},this.data,{type:o.Type[e.shape.toUpperCase()]}),l=o(this.el.object3D,a);if(!l)return void t.addEventListener("object3dset",this.initBody.bind(this));this.body.addShape(l,l.offset,l.orientation),this.system.debug&&(this.shouldUpdateWireframe=!0),this.isLoaded=!0}this.el.body=this.body,this.body.el=t,this.isPlaying&&this._play(),this.isLoaded&&this.el.emit("body-loaded",{body:this.el.body})},addShape:function(t,e,i){"none"===this.data.shape?t?this.body?(this.body.addShape(t,e,i),this.system.debug&&(this.shouldUpdateWireframe=!0),this.shouldUpdateBody=!0):console.warn("shape cannot be added before body is loaded"):console.warn("shape cannot be null"):console.warn("shape can only be added if shape property is none")},tick:function(){this.shouldUpdateBody&&(this.isLoaded=!0,this._play(),this.el.emit("body-loaded",{body:this.el.body}),this.shouldUpdateBody=!1),this.shouldUpdateWireframe&&(this.createWireframe(this.body),this.shouldUpdateWireframe=!1)},play:function(){this.isLoaded&&this._play()},_play:function(){this.syncToPhysics(),this.system.addComponent(this),this.system.addBody(this.body),this.wireframe&&this.el.sceneEl.object3D.add(this.wireframe)},pause:function(){this.isLoaded&&this._pause()},_pause:function(){this.system.removeComponent(this),this.body&&this.system.removeBody(this.body),this.wireframe&&this.el.sceneEl.object3D.remove(this.wireframe)},update:function(t){if(this.body){var e=this.data;null!=t.type&&e.type!=t.type&&(this.body.type="dynamic"===e.type?n.Body.DYNAMIC:n.Body.STATIC),this.body.mass=e.mass||0,"dynamic"===e.type&&(this.body.linearDamping=e.linearDamping,this.body.angularDamping=e.angularDamping),e.mass!==t.mass&&this.body.updateMassProperties(),this.body.updateProperties&&this.body.updateProperties()}},remove:function(){this.body&&(delete this.body.el,delete this.body),delete this.el.body,delete this.wireframe},beforeStep:function(){0===this.body.mass&&this.syncToPhysics()},step:function(){0!==this.body.mass&&this.syncFromPhysics()},createWireframe:function(t){var e,i;this.wireframe&&(this.el.sceneEl.object3D.remove(this.wireframe),delete this.wireframe),this.wireframe=new THREE.Object3D,this.el.sceneEl.object3D.add(this.wireframe);for(var o=new THREE.Quaternion,s=0;s<this.body.shapes.length;s++){e=this.body.shapeOffsets[s],o.copy(this.body.shapeOrientations[s]),i=n.shape2mesh(this.body).children[s];var r=new THREE.LineSegments(new THREE.EdgesGeometry(i.geometry),new THREE.LineBasicMaterial({color:16711680}));e&&r.position.copy(e),o&&r.quaternion.copy(o),this.wireframe.add(r)}this.syncWireframe()},syncWireframe:function(){var t,e=this.wireframe;this.wireframe&&(e.quaternion.copy(this.body.quaternion),e.orientation&&e.quaternion.multiply(e.orientation),e.position.copy(this.body.position),e.offset&&(t=e.offset.clone().applyQuaternion(e.quaternion),e.position.add(t)),e.updateMatrix())},syncToPhysics:(s=new THREE.Quaternion,r=new THREE.Vector3,function(){var t=this.el,e=t.parentEl,i=this.body;i&&(t.components.velocity&&i.velocity.copy(t.getAttribute("velocity")),e.isScene?(i.quaternion.copy(t.object3D.quaternion),i.position.copy(t.object3D.position)):(t.object3D.getWorldQuaternion(s),i.quaternion.copy(s),t.object3D.getWorldPosition(r),i.position.copy(r)),this.body.updateProperties&&this.body.updateProperties(),this.wireframe&&this.syncWireframe())}),syncFromPhysics:function(){var t=new THREE.Vector3,e=new THREE.Quaternion,i=new THREE.Quaternion;return function(){var n=this.el,o=n.parentEl,s=this.body;s&&o&&(o.isScene?(n.object3D.quaternion.copy(s.quaternion),n.object3D.position.copy(s.position)):(e.copy(s.quaternion),o.object3D.getWorldQuaternion(i),e.premultiply(i.invert()),n.object3D.quaternion.copy(e),t.copy(s.position),o.object3D.worldToLocal(t),n.object3D.position.copy(t)),this.wireframe&&this.syncWireframe())}}()};e.exports.definition=a,e.exports.Component=AFRAME.registerComponent("body",a)},{"../../../lib/CANNON-shape2mesh":2,"cannon-es":4,"three-to-cannon":6}],11:[function(t,e,i){var n=t("./body"),o=AFRAME.utils.extend({},n.definition);e.exports=AFRAME.registerComponent("dynamic-body",o)},{"./body":10}],12:[function(t,e,i){var n=t("./body"),o=AFRAME.utils.extend({},n.definition);o.schema=AFRAME.utils.extend({},n.definition.schema,{type:{default:"static",oneOf:["static","dynamic"]},mass:{default:0}}),e.exports=AFRAME.registerComponent("static-body",o)},{"./body":10}],13:[function(t,e,i){var n=t("cannon-es");e.exports=AFRAME.registerComponent("constraint",{multiple:!0,schema:{type:{default:"lock",oneOf:["coneTwist","distance","hinge","lock","pointToPoint"]},target:{type:"selector"},maxForce:{default:1e6,min:0},collideConnected:{default:!0},wakeUpBodies:{default:!0},distance:{default:0,min:0},pivot:{type:"vec3"},targetPivot:{type:"vec3"},axis:{type:"vec3",default:{x:0,y:0,z:1}},targetAxis:{type:"vec3",default:{x:0,y:0,z:1}}},init:function(){this.system=this.el.sceneEl.systems.physics,this.constraint=null},remove:function(){this.constraint&&(this.system.removeConstraint(this.constraint),this.constraint=null)},update:function(){var t=this.el,e=this.data;this.remove(),t.body&&e.target.body?(this.constraint=this.createConstraint(),this.system.addConstraint(this.constraint)):(t.body?e.target:t).addEventListener("body-loaded",this.update.bind(this,{}))},createConstraint:function(){var t,e=this.data,i=new n.Vec3(e.pivot.x,e.pivot.y,e.pivot.z),o=new n.Vec3(e.targetPivot.x,e.targetPivot.y,e.targetPivot.z),s=new n.Vec3(e.axis.x,e.axis.y,e.axis.z),r=new n.Vec3(e.targetAxis.x,e.targetAxis.y,e.targetAxis.z);switch(e.type){case"lock":(t=new n.LockConstraint(this.el.body,e.target.body,{maxForce:e.maxForce})).type="LockConstraint";break;case"distance":(t=new n.DistanceConstraint(this.el.body,e.target.body,e.distance,e.maxForce)).type="DistanceConstraint";break;case"hinge":(t=new n.HingeConstraint(this.el.body,e.target.body,{pivotA:i,pivotB:o,axisA:s,axisB:r,maxForce:e.maxForce})).type="HingeConstraint";break;case"coneTwist":(t=new n.ConeTwistConstraint(this.el.body,e.target.body,{pivotA:i,pivotB:o,axisA:s,axisB:r,maxForce:e.maxForce})).type="ConeTwistConstraint";break;case"pointToPoint":(t=new n.PointToPointConstraint(this.el.body,i,e.target.body,o,e.maxForce)).type="PointToPointConstraint";break;default:throw new Error("[constraint] Unexpected type: "+e.type)}return t.collideConnected=e.collideConnected,t}})},{"cannon-es":4}],14:[function(t,e,i){e.exports={velocity:t("./velocity"),registerAll:function(t){this._registered||((t=t||window.AFRAME).components.velocity||t.registerComponent("velocity",this.velocity),this._registered=!0)}}},{"./velocity":15}],15:[function(t,e,i){e.exports=AFRAME.registerComponent("velocity",{schema:{type:"vec3"},init:function(){this.system=this.el.sceneEl.systems.physics,this.system&&this.system.addComponent(this)},remove:function(){this.system&&this.system.removeComponent(this)},tick:function(t,e){e&&(this.system||this.afterStep(t,e))},afterStep:function(t,e){if(e){var i=this.el.sceneEl.systems.physics||{data:{maxInterval:1/60}},n=this.el.getAttribute("velocity")||{x:0,y:0,z:0},o=this.el.object3D.position||{x:0,y:0,z:0};e=Math.min(e,1e3*i.data.maxInterval),this.el.object3D.position.set(o.x+n.x*e/1e3,o.y+n.y*e/1e3,o.z+n.z*e/1e3)}}})},{}],16:[function(t,e,i){t("three-to-ammo");const n=t("../../constants"),o=n.SHAPE,s=n.FIT;var r={schema:{type:{default:o.HULL,oneOf:[o.BOX,o.CYLINDER,o.SPHERE,o.CAPSULE,o.CONE,o.HULL,o.HACD,o.VHACD,o.MESH,o.HEIGHTFIELD]},fit:{default:s.ALL,oneOf:[s.ALL,s.MANUAL]},halfExtents:{type:"vec3",default:{x:1,y:1,z:1}},minHalfExtent:{default:0},maxHalfExtent:{default:Number.POSITIVE_INFINITY},sphereRadius:{default:NaN},cylinderAxis:{default:"y",oneOf:["x","y","z"]},margin:{default:.01},offset:{type:"vec3",default:{x:0,y:0,z:0}},orientation:{type:"vec4",default:{x:0,y:0,z:0,w:1}},heightfieldData:{default:[]},heightfieldDistance:{default:1},includeInvisible:{default:!1}},multiple:!0,init:function(){this.system=this.el.sceneEl.systems.physics,this.collisionShapes=[];let t=this.el;for(this.body=t.components["ammo-body"]||null;!this.body&&t.parentNode!=this.el.sceneEl;)(t=t.parentNode).components["ammo-body"]&&(this.body=t.components["ammo-body"]);if(this.body){if(this.data.fit!==s.MANUAL){if(!this.el.object3DMap.mesh)return void console.error("Cannot use FIT.ALL without object3DMap.mesh");this.mesh=this.el.object3DMap.mesh}this.body.addShapeComponent(this)}else console.warn("body not found")},getMesh:function(){return this.mesh||null},addShapes:function(t){this.collisionShapes=t},getShapes:function(){return this.collisionShapes},remove:function(){if(this.body)for(this.body.removeShapeComponent(this);this.collisionShapes.length>0;){const t=this.collisionShapes.pop();t.destroy(),Ammo.destroy(t.localTransform)}}};e.exports.definition=r,e.exports.Component=AFRAME.registerComponent("ammo-shape",r)},{"../../constants":19,"three-to-ammo":5}],17:[function(t,e,i){var n=t("cannon-es"),o={schema:{shape:{default:"box",oneOf:["box","sphere","cylinder"]},offset:{type:"vec3",default:{x:0,y:0,z:0}},orientation:{type:"vec4",default:{x:0,y:0,z:0,w:1}},radius:{type:"number",default:1,if:{shape:["sphere"]}},halfExtents:{type:"vec3",default:{x:.5,y:.5,z:.5},if:{shape:["box"]}},radiusTop:{type:"number",default:1,if:{shape:["cylinder"]}},radiusBottom:{type:"number",default:1,if:{shape:["cylinder"]}},height:{type:"number",default:1,if:{shape:["cylinder"]}},numSegments:{type:"int",default:8,if:{shape:["cylinder"]}}},multiple:!0,init:function(){this.el.sceneEl.hasLoaded?this.initShape():this.el.sceneEl.addEventListener("loaded",this.initShape.bind(this))},initShape:function(){this.bodyEl=this.el;for(var t=this._findType(this.bodyEl),e=this.data;!t&&this.bodyEl.parentNode!=this.el.sceneEl;)this.bodyEl=this.bodyEl.parentNode,t=this._findType(this.bodyEl);if(t){var i,o,s,r=new THREE.Vector3;switch(this.bodyEl.object3D.getWorldScale(r),e.hasOwnProperty("offset")&&(o=new n.Vec3(e.offset.x*r.x,e.offset.y*r.y,e.offset.z*r.z)),e.hasOwnProperty("orientation")&&(s=new n.Quaternion).copy(e.orientation),e.shape){case"sphere":i=new n.Sphere(e.radius*r.x);break;case"box":var a=new n.Vec3(e.halfExtents.x*r.x,e.halfExtents.y*r.y,e.halfExtents.z*r.z);i=new n.Box(a);break;case"cylinder":i=new n.Cylinder(e.radiusTop*r.x,e.radiusBottom*r.x,e.height*r.y,e.numSegments);var l=new n.Quaternion;l.setFromEuler(90*THREE.Math.DEG2RAD,0,0,"XYZ").normalize(),s.mult(l,s);break;default:return void console.warn(e.shape+" shape not supported")}this.bodyEl.body?this.bodyEl.components[t].addShape(i,o,s):this.bodyEl.addEventListener("body-loaded",(function(){this.bodyEl.components[t].addShape(i,o,s)}),{once:!0})}else console.warn("body not found")},_findType:function(t){return t.hasAttribute("body")?"body":t.hasAttribute("dynamic-body")?"dynamic-body":t.hasAttribute("static-body")?"static-body":null},remove:function(){this.bodyEl.parentNode&&console.warn("removing shape component not currently supported")}};e.exports.definition=o,e.exports.Component=AFRAME.registerComponent("shape",o)},{"cannon-es":4}],18:[function(t,e,i){var n=t("cannon-es");e.exports=AFRAME.registerComponent("spring",{multiple:!0,schema:{target:{type:"selector"},restLength:{default:1,min:0},stiffness:{default:100,min:0},damping:{default:1,min:0},localAnchorA:{type:"vec3",default:{x:0,y:0,z:0}},localAnchorB:{type:"vec3",default:{x:0,y:0,z:0}}},init:function(){this.system=this.el.sceneEl.systems.physics,this.system.addComponent(this),this.isActive=!0,this.spring=null},update:function(t){var e=this.el,i=this.data;i.target?e.body&&i.target.body?(this.createSpring(),this.updateSpring(t)):(e.body?i.target:e).addEventListener("body-loaded",this.update.bind(this,{})):console.warn("Spring: invalid target specified.")},updateSpring:function(t){if(this.spring){var e=this.data,i=this.spring;Object.keys(e).forEach((function(n){if(e[n]!==t[n]){if("target"===n)return void(i.bodyB=e.target.body);i[n]=e[n]}}))}else console.warn("Spring: Component attempted to change spring before its created. No changes made.")},createSpring:function(){this.spring||(this.spring=new n.Spring(this.el.body))},step:function(t,e){return this.spring&&this.isActive?this.spring.applyForce():void 0},play:function(){this.isActive=!0},pause:function(){this.isActive=!1},remove:function(){this.spring&&delete this.spring,this.spring=null}})},{"cannon-es":4}],19:[function(t,e,i){e.exports={GRAVITY:-9.8,MAX_INTERVAL:4/60,ITERATIONS:10,CONTACT_MATERIAL:{friction:.01,restitution:.3,contactEquationStiffness:1e8,contactEquationRelaxation:3,frictionEquationStiffness:1e8,frictionEquationRegularization:3},ACTIVATION_STATE:{ACTIVE_TAG:"active",ISLAND_SLEEPING:"islandSleeping",WANTS_DEACTIVATION:"wantsDeactivation",DISABLE_DEACTIVATION:"disableDeactivation",DISABLE_SIMULATION:"disableSimulation"},COLLISION_FLAG:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32,DISABLE_SPU_COLLISION_PROCESSING:64},TYPE:{STATIC:"static",DYNAMIC:"dynamic",KINEMATIC:"kinematic"},SHAPE:{BOX:"box",CYLINDER:"cylinder",SPHERE:"sphere",CAPSULE:"capsule",CONE:"cone",HULL:"hull",HACD:"hacd",VHACD:"vhacd",MESH:"mesh",HEIGHTFIELD:"heightfield"},FIT:{ALL:"all",MANUAL:"manual"},CONSTRAINT:{LOCK:"lock",FIXED:"fixed",SPRING:"spring",SLIDER:"slider",HINGE:"hinge",CONE_TWIST:"coneTwist",POINT_TO_POINT:"pointToPoint"}}},{}],20:[function(t,e,i){const n=t("./driver");function o(){this.collisionConfiguration=null,this.dispatcher=null,this.broadphase=null,this.solver=null,this.physicsWorld=null,this.debugDrawer=null,this.els=new Map,this.eventListeners=[],this.collisions=new Map,this.collisionKeys=[],this.currentCollisions=new Map}"undefined"!=typeof window&&(window.AmmoModule=window.Ammo,window.Ammo=null),o.prototype=new n,o.prototype.constructor=o,e.exports=o,o.prototype.init=function(t){return new Promise((e=>{AmmoModule().then((i=>{Ammo=i,this.epsilon=t.epsilon||1e-5,this.debugDrawMode=t.debugDrawMode||THREE.AmmoDebugConstants.NoDebug,this.maxSubSteps=t.maxSubSteps||4,this.fixedTimeStep=t.fixedTimeStep||1/60,this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.broadphase=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.physicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.broadphase,this.solver,this.collisionConfiguration),this.physicsWorld.setForceUpdateAllAabbs(!1),this.physicsWorld.setGravity(new Ammo.btVector3(0,t.hasOwnProperty("gravity")?t.gravity:-9.8,0)),this.physicsWorld.getSolverInfo().set_m_numIterations(t.solverIterations),e()}))}))},o.prototype.addBody=function(t,e,i){this.physicsWorld.addRigidBody(t,e,i),this.els.set(Ammo.getPointer(t),t.el)},o.prototype.removeBody=function(t){this.physicsWorld.removeRigidBody(t),this.removeEventListener(t);const e=Ammo.getPointer(t);this.els.delete(e),this.collisions.delete(e),this.collisionKeys.splice(this.collisionKeys.indexOf(e),1),this.currentCollisions.delete(e)},o.prototype.updateBody=function(t){this.els.has(Ammo.getPointer(t))&&this.physicsWorld.updateSingleAabb(t)},o.prototype.step=function(t){this.physicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);const e=this.dispatcher.getNumManifolds();for(let t=0;t<e;t++){const e=this.dispatcher.getManifoldByIndexInternal(t),i=e.getNumContacts(),n=Ammo.getPointer(e.getBody0()),o=Ammo.getPointer(e.getBody1());let s=!1;for(let t=0;t<i;t++)if(e.getContactPoint(t).getDistance()<=this.epsilon){s=!0;break}s&&(this.collisions.has(n)||(this.collisions.set(n,[]),this.collisionKeys.push(n)),-1===this.collisions.get(n).indexOf(o)&&(this.collisions.get(n).push(o),-1!==this.eventListeners.indexOf(n)&&this.els.get(n).emit("collidestart",{targetEl:this.els.get(o)}),-1!==this.eventListeners.indexOf(o)&&this.els.get(o).emit("collidestart",{targetEl:this.els.get(n)})),this.currentCollisions.has(n)||this.currentCollisions.set(n,new Set),this.currentCollisions.get(n).add(o))}for(let t=0;t<this.collisionKeys.length;t++){const e=this.collisionKeys[t],i=this.collisions.get(e);for(let t=i.length-1;t>=0;t--){const n=i[t];this.currentCollisions.get(e).has(n)||(-1!==this.eventListeners.indexOf(e)&&this.els.get(e).emit("collideend",{targetEl:this.els.get(n)}),-1!==this.eventListeners.indexOf(n)&&this.els.get(n).emit("collideend",{targetEl:this.els.get(e)}),i.splice(t,1))}this.currentCollisions.get(e).clear()}this.debugDrawer&&this.debugDrawer.update()},o.prototype.addConstraint=function(t){this.physicsWorld.addConstraint(t,!1)},o.prototype.removeConstraint=function(t){this.physicsWorld.removeConstraint(t)},o.prototype.addEventListener=function(t){this.eventListeners.push(Ammo.getPointer(t))},o.prototype.removeEventListener=function(t){const e=Ammo.getPointer(t);-1!==this.eventListeners.indexOf(e)&&this.eventListeners.splice(this.eventListeners.indexOf(e),1)},o.prototype.destroy=function(){Ammo.destroy(this.collisionConfiguration),Ammo.destroy(this.dispatcher),Ammo.destroy(this.broadphase),Ammo.destroy(this.solver),Ammo.destroy(this.physicsWorld),Ammo.destroy(this.debugDrawer)},o.prototype.getDebugDrawer=function(t,e){return this.debugDrawer||((e=e||{}).debugDrawMode=e.debugDrawMode||this.debugDrawMode,this.debugDrawer=new THREE.AmmoDebugDrawer(t,this.physicsWorld,e)),this.debugDrawer}},{"./driver":21}],21:[function(t,e,i){function n(){}function o(){throw new Error("Method not implemented.")}e.exports=n,n.prototype.init=o,n.prototype.step=o,n.prototype.destroy=o,n.prototype.addBody=o,n.prototype.removeBody=o,n.prototype.applyBodyMethod=o,n.prototype.updateBodyProperties=o,n.prototype.addMaterial=o,n.prototype.addContactMaterial=o,n.prototype.addConstraint=o,n.prototype.removeConstraint=o,n.prototype.getContacts=o},{}],22:[function(t,e,i){e.exports={INIT:"init",STEP:"step",ADD_BODY:"add-body",REMOVE_BODY:"remove-body",APPLY_BODY_METHOD:"apply-body-method",UPDATE_BODY_PROPERTIES:"update-body-properties",ADD_MATERIAL:"add-material",ADD_CONTACT_MATERIAL:"add-contact-material",ADD_CONSTRAINT:"add-constraint",REMOVE_CONSTRAINT:"remove-constraint",COLLIDE:"collide"}},{}],23:[function(t,e,i){var n=t("cannon-es"),o=t("./driver");function s(){this.world=null,this.materials={},this.contactMaterial=null}s.prototype=new o,s.prototype.constructor=s,e.exports=s,s.prototype.init=function(t){var e=new n.World;e.quatNormalizeSkip=t.quatNormalizeSkip,e.quatNormalizeFast=t.quatNormalizeFast,e.solver.iterations=t.solverIterations,e.gravity.set(0,t.gravity,0),e.broadphase=new n.NaiveBroadphase,this.world=e},s.prototype.step=function(t){this.world.step(t)},s.prototype.destroy=function(){delete this.world,delete this.contactMaterial,this.materials={}},s.prototype.addBody=function(t){this.world.addBody(t)},s.prototype.removeBody=function(t){this.world.removeBody(t)},s.prototype.applyBodyMethod=function(t,e,i){t["__"+e].apply(t,i)},s.prototype.updateBodyProperties=function(){},s.prototype.getMaterial=function(t){return this.materials[t]},s.prototype.addMaterial=function(t){this.materials[t.name]=new n.Material(t),this.materials[t.name].name=t.name},s.prototype.addContactMaterial=function(t,e,i){var o=this.materials[t],s=this.materials[e];this.contactMaterial=new n.ContactMaterial(o,s,i),this.world.addContactMaterial(this.contactMaterial)},s.prototype.addConstraint=function(t){t.type||(t instanceof n.LockConstraint?t.type="LockConstraint":t instanceof n.DistanceConstraint?t.type="DistanceConstraint":t instanceof n.HingeConstraint?t.type="HingeConstraint":t instanceof n.ConeTwistConstraint?t.type="ConeTwistConstraint":t instanceof n.PointToPointConstraint&&(t.type="PointToPointConstraint")),this.world.addConstraint(t)},s.prototype.removeConstraint=function(t){this.world.removeConstraint(t)},s.prototype.getContacts=function(){return this.world.contacts}},{"./driver":21,"cannon-es":4}],24:[function(t,e,i){var n=t("./driver");function o(){throw new Error("[NetworkDriver] Driver not implemented.")}o.prototype=new n,o.prototype.constructor=o,e.exports=o},{"./driver":21}],25:[function(t,e,i){function n(){this.listeners=[]}e.exports=function(t){var e=new n,i=new n;return e.setTarget(i),i.setTarget(e),t(e),i},n.prototype.setTarget=function(t){this.target=t},n.prototype.addEventListener=function(t,e){this.listeners.push(e)},n.prototype.dispatchEvent=function(t,e){for(var i=0;i<this.listeners.length;i++)this.listeners[i](e)},n.prototype.postMessage=function(t){this.target.dispatchEvent("message",{data:t})}},{}],26:[function(t,e,i){var n=t("webworkify"),o=t("./webworkify-debug"),s=t("./driver"),r=t("./event"),a=t("./worker"),l=t("../utils/protocol"),h=l.ID;function c(t){this.fps=t.fps,this.engine=t.engine,this.interpolate=t.interpolate,this.interpBufferSize=t.interpolationBufferSize,this.debug=t.debug,this.bodies={},this.contacts=[],this.frameDelay=1e3*this.interpBufferSize/this.fps,this.frameBuffer=[],this.worker=this.debug?o(a):n(a),this.worker.addEventListener("message",this._onMessage.bind(this))}c.prototype=new s,c.prototype.constructor=c,e.exports=c,c.prototype.init=function(t){this.worker.postMessage({type:r.INIT,worldConfig:t,fps:this.fps,engine:this.engine})},c.prototype.step=function(){if(this.interpolate){for(var t=this.frameBuffer[0],e=this.frameBuffer[1],i=performance.now();t&&e&&i-t.timestamp>this.frameDelay;)this.frameBuffer.shift(),t=this.frameBuffer[0],e=this.frameBuffer[1];if(t&&e){var n=(i-t.timestamp)/this.frameDelay;for(var o in n=(n-(1-1/this.interpBufferSize))*this.interpBufferSize,t.bodies)t.bodies.hasOwnProperty(o)&&e.bodies.hasOwnProperty(o)&&l.deserializeInterpBodyUpdate(t.bodies[o],e.bodies[o],this.bodies[o],n)}}},c.prototype.destroy=function(){this.worker.terminate(),delete this.worker},c.prototype._onMessage=function(t){if(t.data.type===r.STEP){var e=t.data.bodies;if(this.contacts=t.data.contacts,this.interpolate)this.frameBuffer.push({timestamp:performance.now(),bodies:e});else for(var i in e)e.hasOwnProperty(i)&&l.deserializeBodyUpdate(e[i],this.bodies[i])}else{if(t.data.type!==r.COLLIDE)throw new Error("[WorkerDriver] Unexpected message type.");var n=this.bodies[t.data.bodyID],o=this.bodies[t.data.targetID],s=l.deserializeContact(t.data.contact,this.bodies);if(!n._listeners||!n._listeners.collide)return;for(var a=0;a<n._listeners.collide.length;a++)n._listeners.collide[a]({target:o,body:n,contact:s})}},c.prototype.addBody=function(t){l.assignID("body",t),this.bodies[t[h]]=t,this.worker.postMessage({type:r.ADD_BODY,body:l.serializeBody(t)})},c.prototype.removeBody=function(t){this.worker.postMessage({type:r.REMOVE_BODY,bodyID:t[h]}),delete this.bodies[t[h]]},c.prototype.applyBodyMethod=function(t,e,i){switch(e){case"applyForce":case"applyImpulse":this.worker.postMessage({type:r.APPLY_BODY_METHOD,bodyID:t[h],methodName:e,args:[i[0].toArray(),i[1].toArray()]});break;default:throw new Error("Unexpected methodName: %s",e)}},c.prototype.updateBodyProperties=function(t){this.worker.postMessage({type:r.UPDATE_BODY_PROPERTIES,body:l.serializeBody(t)})},c.prototype.getMaterial=function(t){},c.prototype.addMaterial=function(t){this.worker.postMessage({type:r.ADD_MATERIAL,materialConfig:t})},c.prototype.addContactMaterial=function(t,e,i){this.worker.postMessage({type:r.ADD_CONTACT_MATERIAL,materialName1:t,materialName2:e,contactMaterialConfig:i})},c.prototype.addConstraint=function(t){t.type||(t instanceof CANNON.LockConstraint?t.type="LockConstraint":t instanceof CANNON.DistanceConstraint?t.type="DistanceConstraint":t instanceof CANNON.HingeConstraint?t.type="HingeConstraint":t instanceof CANNON.ConeTwistConstraint?t.type="ConeTwistConstraint":t instanceof CANNON.PointToPointConstraint&&(t.type="PointToPointConstraint")),l.assignID("constraint",t),this.worker.postMessage({type:r.ADD_CONSTRAINT,constraint:l.serializeConstraint(t)})},c.prototype.removeConstraint=function(t){this.worker.postMessage({type:r.REMOVE_CONSTRAINT,constraintID:t[h]})},c.prototype.getContacts=function(){var t=this.bodies;return this.contacts.map((function(e){return l.deserializeContact(e,t)}))}},{"../utils/protocol":30,"./driver":21,"./event":22,"./webworkify-debug":25,"./worker":27,webworkify:7}],27:[function(t,e,i){var n=t("./event"),o=t("./local-driver"),s=t("./ammo-driver"),r=t("../utils/protocol"),a=r.ID;e.exports=function(t){var e,i=null,l={},h={};function c(){i.step(e);var o={};Object.keys(l).forEach((function(t){o[t]=r.serializeBody(l[t])})),t.postMessage({type:n.STEP,bodies:o,contacts:i.getContacts().map(r.serializeContact)})}t.addEventListener("message",(function(u){var d=u.data;switch(d.type){case n.INIT:(i="cannon"===d.engine?new o:new s).init(d.worldConfig),e=1/d.fps,setInterval(c,1e3/d.fps);break;case n.ADD_BODY:var p=r.deserializeBody(d.body);p.material=i.getMaterial("defaultMaterial"),l[p[a]]=p,p.addEventListener("collide",(function(e){var i={type:n.COLLIDE,bodyID:e.target[a],targetID:e.body[a],contact:r.serializeContact(e.contact)};t.postMessage(i)})),i.addBody(p);break;case n.REMOVE_BODY:i.removeBody(l[d.bodyID]),delete l[d.bodyID];break;case n.APPLY_BODY_METHOD:l[d.bodyID][d.methodName](r.deserializeVec3(d.args[0]),r.deserializeVec3(d.args[1]));break;case n.UPDATE_BODY_PROPERTIES:r.deserializeBodyUpdate(d.body,l[d.body.id]);break;case n.ADD_MATERIAL:i.addMaterial(d.materialConfig);break;case n.ADD_CONTACT_MATERIAL:i.addContactMaterial(d.materialName1,d.materialName2,d.contactMaterialConfig);break;case n.ADD_CONSTRAINT:var f=r.deserializeConstraint(d.constraint,l);h[f[a]]=f,i.addConstraint(f);break;case n.REMOVE_CONSTRAINT:i.removeConstraint(h[d.constraintID]),delete h[d.constraintID];break;default:throw new Error("[Worker] Unexpected event type: %s",d.type)}}))}},{"../utils/protocol":30,"./ammo-driver":20,"./event":22,"./local-driver":23}],28:[function(t,e,i){t("cannon-es");var n=t("./constants"),o=n.GRAVITY,s=n.CONTACT_MATERIAL,r=t("./drivers/local-driver"),a=t("./drivers/worker-driver"),l=t("./drivers/network-driver"),h=t("./drivers/ammo-driver");e.exports=AFRAME.registerSystem("physics",{schema:{driver:{default:"local",oneOf:["local","worker","network","ammo"]},networkUrl:{default:"",if:{driver:"network"}},workerFps:{default:60,if:{driver:"worker"}},workerInterpolate:{default:!0,if:{driver:"worker"}},workerInterpBufferSize:{default:2,if:{driver:"worker"}},workerEngine:{default:"cannon",if:{driver:"worker"},oneOf:["cannon"]},workerDebug:{default:!1,if:{driver:"worker"}},gravity:{default:o},iterations:{default:n.ITERATIONS},friction:{default:s.friction},restitution:{default:s.restitution},contactEquationStiffness:{default:s.contactEquationStiffness},contactEquationRelaxation:{default:s.contactEquationRelaxation},frictionEquationStiffness:{default:s.frictionEquationStiffness},frictionEquationRegularization:{default:s.frictionEquationRegularization},maxInterval:{default:4/60},debug:{default:!1},debugDrawMode:{default:THREE.AmmoDebugConstants.NoDebug},maxSubSteps:{default:4},fixedTimeStep:{default:1/60}},async init(){var t=this.data;switch(this.debug=t.debug,this.callbacks={beforeStep:[],step:[],afterStep:[]},this.listeners={},this.driver=null,t.driver){case"local":this.driver=new r;break;case"ammo":this.driver=new h;break;case"network":this.driver=new l(t.networkUrl);break;case"worker":this.driver=new a({fps:t.workerFps,engine:t.workerEngine,interpolate:t.workerInterpolate,interpolationBufferSize:t.workerInterpBufferSize,debug:t.workerDebug});break;default:throw new Error('[physics] Driver not recognized: "%s".',t.driver)}"ammo"!==t.driver?(await this.driver.init({quatNormalizeSkip:0,quatNormalizeFast:!1,solverIterations:t.iterations,gravity:t.gravity}),this.driver.addMaterial({name:"defaultMaterial"}),this.driver.addMaterial({name:"staticMaterial"}),this.driver.addContactMaterial("defaultMaterial","defaultMaterial",{friction:t.friction,restitution:t.restitution,contactEquationStiffness:t.contactEquationStiffness,contactEquationRelaxation:t.contactEquationRelaxation,frictionEquationStiffness:t.frictionEquationStiffness,frictionEquationRegularization:t.frictionEquationRegularization}),this.driver.addContactMaterial("staticMaterial","defaultMaterial",{friction:1,restitution:0,contactEquationStiffness:t.contactEquationStiffness,contactEquationRelaxation:t.contactEquationRelaxation,frictionEquationStiffness:t.frictionEquationStiffness,frictionEquationRegularization:t.frictionEquationRegularization})):await this.driver.init({gravity:t.gravity,debugDrawMode:t.debugDrawMode,solverIterations:t.iterations,maxSubSteps:t.maxSubSteps,fixedTimeStep:t.fixedTimeStep}),this.initialized=!0,this.debug&&this.setDebug(!0)},tick:function(t,e){if(this.initialized&&e){var i,n=this.callbacks;for(i=0;i<this.callbacks.beforeStep.length;i++)this.callbacks.beforeStep[i].beforeStep(t,e);for(this.driver.step(Math.min(e/1e3,this.data.maxInterval)),i=0;i<n.step.length;i++)n.step[i].step(t,e);for(i=0;i<n.afterStep.length;i++)n.afterStep[i].afterStep(t,e)}},setDebug:function(t){this.debug=t,"ammo"===this.data.driver&&this.initialized&&(t&&!this.debugDrawer?(this.debugDrawer=this.driver.getDebugDrawer(this.el.object3D),this.debugDrawer.enable()):this.debugDrawer&&(this.debugDrawer.disable(),this.debugDrawer=null))},addBody:function(t,e,i){var n=this.driver;"local"===this.data.driver&&(t.__applyImpulse=t.applyImpulse,t.applyImpulse=function(){n.applyBodyMethod(t,"applyImpulse",arguments)},t.__applyForce=t.applyForce,t.applyForce=function(){n.applyBodyMethod(t,"applyForce",arguments)},t.updateProperties=function(){n.updateBodyProperties(t)},this.listeners[t.id]=function(e){t.el.emit("collide",e)},t.addEventListener("collide",this.listeners[t.id])),this.driver.addBody(t,e,i)},removeBody:function(t){this.driver.removeBody(t),"local"!==this.data.driver&&"worker"!==this.data.driver||(t.removeEventListener("collide",this.listeners[t.id]),delete this.listeners[t.id],t.applyImpulse=t.__applyImpulse,delete t.__applyImpulse,t.applyForce=t.__applyForce,delete t.__applyForce,delete t.updateProperties)},addConstraint:function(t){this.driver.addConstraint(t)},removeConstraint:function(t){this.driver.removeConstraint(t)},addComponent:function(t){var e=this.callbacks;t.beforeStep&&e.beforeStep.push(t),t.step&&e.step.push(t),t.afterStep&&e.afterStep.push(t)},removeComponent:function(t){var e=this.callbacks;t.beforeStep&&e.beforeStep.splice(e.beforeStep.indexOf(t),1),t.step&&e.step.splice(e.step.indexOf(t),1),t.afterStep&&e.afterStep.splice(e.afterStep.indexOf(t),1)},getContacts:function(){return this.driver.getContacts()},getMaterial:function(t){return this.driver.getMaterial(t)}})},{"./constants":19,"./drivers/ammo-driver":20,"./drivers/local-driver":23,"./drivers/network-driver":24,"./drivers/worker-driver":26,"cannon-es":4}],29:[function(t,e,i){e.exports.slerp=function(t,e,i){if(i<=0)return t;if(i>=1)return e;var n=t[0],o=t[1],s=t[2],r=t[3],a=r*e[3]+n*e[0]+o*e[1]+s*e[2];if(!(a<0))return e;if((t=t.slice())[3]=-e[3],t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],(a=-a)>=1)return t[3]=r,t[0]=n,t[1]=o,t[2]=s,this;var l=Math.sqrt(1-a*a);if(Math.abs(l)<.001)return t[3]=.5*(r+t[3]),t[0]=.5*(n+t[0]),t[1]=.5*(o+t[1]),t[2]=.5*(s+t[2]),this;var h=Math.atan2(l,a),c=Math.sin((1-i)*h)/l,u=Math.sin(i*h)/l;return t[3]=r*c+t[3]*u,t[0]=n*c+t[0]*u,t[1]=o*c+t[1]*u,t[2]=s*c+t[2]*u,t}},{}],30:[function(t,e,i){var n=t("cannon-es"),o=t("./math"),s="__id";e.exports.ID=s;var r={};function a(t){var e={type:t.type};if(t.type===n.Shape.types.BOX)e.halfExtents=h(t.halfExtents);else if(t.type===n.Shape.types.SPHERE)e.radius=t.radius;else{if(t._type!==n.Shape.types.CYLINDER)throw new Error("Unimplemented shape type: %s",t.type);e.type=n.Shape.types.CYLINDER,e.radiusTop=t.radiusTop,e.radiusBottom=t.radiusBottom,e.height=t.height,e.numSegments=t.numSegments}return e}function l(t){var e;if(t.type===n.Shape.types.BOX)e=new n.Box(c(t.halfExtents));else if(t.type===n.Shape.types.SPHERE)e=new n.Sphere(t.radius);else{if(t.type!==n.Shape.types.CYLINDER)throw new Error("Unimplemented shape type: %s",t.type);(e=new n.Cylinder(t.radiusTop,t.radiusBottom,t.height,t.numSegments))._type=n.Shape.types.CYLINDER}return e}function h(t){return t.toArray()}function c(t){return new n.Vec3(t[0],t[1],t[2])}function u(t){return t.toArray()}function d(t){return new n.Quaternion(t[0],t[1],t[2],t[3])}e.exports.assignID=function(t,e){e[s]||(r[t]=r[t]||1,e[s]=t+"_"+r[t]++)},e.exports.serializeBody=function(t){return{shapes:t.shapes.map(a),shapeOffsets:t.shapeOffsets.map(h),shapeOrientations:t.shapeOrientations.map(u),position:h(t.position),quaternion:t.quaternion.toArray(),velocity:h(t.velocity),angularVelocity:h(t.angularVelocity),id:t[s],mass:t.mass,linearDamping:t.linearDamping,angularDamping:t.angularDamping,fixedRotation:t.fixedRotation,allowSleep:t.allowSleep,sleepSpeedLimit:t.sleepSpeedLimit,sleepTimeLimit:t.sleepTimeLimit}},e.exports.deserializeBodyUpdate=function(t,e){return e.position.set(t.position[0],t.position[1],t.position[2]),e.quaternion.set(t.quaternion[0],t.quaternion[1],t.quaternion[2],t.quaternion[3]),e.velocity.set(t.velocity[0],t.velocity[1],t.velocity[2]),e.angularVelocity.set(t.angularVelocity[0],t.angularVelocity[1],t.angularVelocity[2]),e.linearDamping=t.linearDamping,e.angularDamping=t.angularDamping,e.fixedRotation=t.fixedRotation,e.allowSleep=t.allowSleep,e.sleepSpeedLimit=t.sleepSpeedLimit,e.sleepTimeLimit=t.sleepTimeLimit,e.mass!==t.mass&&(e.mass=t.mass,e.updateMassProperties()),e},e.exports.deserializeInterpBodyUpdate=function(t,e,i,n){var s=1-n,r=n;i.position.set(t.position[0]*s+e.position[0]*r,t.position[1]*s+e.position[1]*r,t.position[2]*s+e.position[2]*r);var a=o.slerp(t.quaternion,e.quaternion,n);return i.quaternion.set(a[0],a[1],a[2],a[3]),i.velocity.set(t.velocity[0]*s+e.velocity[0]*r,t.velocity[1]*s+e.velocity[1]*r,t.velocity[2]*s+e.velocity[2]*r),i.angularVelocity.set(t.angularVelocity[0]*s+e.angularVelocity[0]*r,t.angularVelocity[1]*s+e.angularVelocity[1]*r,t.angularVelocity[2]*s+e.angularVelocity[2]*r),i.linearDamping=e.linearDamping,i.angularDamping=e.angularDamping,i.fixedRotation=e.fixedRotation,i.allowSleep=e.allowSleep,i.sleepSpeedLimit=e.sleepSpeedLimit,i.sleepTimeLimit=e.sleepTimeLimit,i.mass!==e.mass&&(i.mass=e.mass,i.updateMassProperties()),i},e.exports.deserializeBody=function(t){for(var e,i=new n.Body({mass:t.mass,position:c(t.position),quaternion:d(t.quaternion),velocity:c(t.velocity),angularVelocity:c(t.angularVelocity),linearDamping:t.linearDamping,angularDamping:t.angularDamping,fixedRotation:t.fixedRotation,allowSleep:t.allowSleep,sleepSpeedLimit:t.sleepSpeedLimit,sleepTimeLimit:t.sleepTimeLimit}),o=0;e=t.shapes[o];o++)i.addShape(l(e),c(t.shapeOffsets[o]),d(t.shapeOrientations[o]));return i[s]=t.id,i},e.exports.serializeShape=a,e.exports.deserializeShape=l,e.exports.serializeConstraint=function(t){var e={id:t[s],type:t.type,maxForce:t.maxForce,bodyA:t.bodyA[s],bodyB:t.bodyB[s]};switch(t.type){case"LockConstraint":break;case"DistanceConstraint":e.distance=t.distance;break;case"HingeConstraint":case"ConeTwistConstraint":e.axisA=h(t.axisA),e.axisB=h(t.axisB),e.pivotA=h(t.pivotA),e.pivotB=h(t.pivotB);break;case"PointToPointConstraint":e.pivotA=h(t.pivotA),e.pivotB=h(t.pivotB);break;default:throw new Error("Unexpected constraint type: "+t.type+'. You may need to manually set `constraint.type = "FooConstraint";`.')}return e},e.exports.deserializeConstraint=function(t,e){var i,o=n[t.type],r=e[t.bodyA],a=e[t.bodyB];switch(t.type){case"LockConstraint":i=new n.LockConstraint(r,a,t);break;case"DistanceConstraint":i=new n.DistanceConstraint(r,a,t.distance,t.maxForce);break;case"HingeConstraint":case"ConeTwistConstraint":i=new o(r,a,{pivotA:c(t.pivotA),pivotB:c(t.pivotB),axisA:c(t.axisA),axisB:c(t.axisB),maxForce:t.maxForce});break;case"PointToPointConstraint":i=new n.PointToPointConstraint(r,c(t.pivotA),a,c(t.pivotB),t.maxForce);break;default:throw new Error("Unexpected constraint type: "+t.type)}return i[s]=t.id,i},e.exports.serializeContact=function(t){return{bi:t.bi[s],bj:t.bj[s],ni:h(t.ni),ri:h(t.ri),rj:h(t.rj)}},e.exports.deserializeContact=function(t,e){return{bi:e[t.bi],bj:e[t.bj],ni:c(t.ni),ri:c(t.ri),rj:c(t.rj)}},e.exports.serializeVec3=h,e.exports.deserializeVec3=c,e.exports.serializeQuaternion=u,e.exports.deserializeQuaternion=d},{"./math":29,"cannon-es":4}]},{},[1]);